<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>International Digital Human Platform - AI Digital Human Management System</title>
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a2e;
      --text-primary: #ffffff;
      --text-secondary: #8b8b9e;
      --primary: #1890ff;
      --primary-dark: #096dd9;
      --success: #52c41a;
      --warning: #faad14;
      --danger: #ff4d4f;
      --border: #2a2a3e;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Arial', 'Helvetica', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* ‰æßËæπÊ†èËèúÂçï */
    .sidebar-menu {
      width: 240px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      min-height: calc(100vh - 64px);
      position: fixed;
      left: 0;
      top: 64px;
      padding: 20px 0;
      overflow-y: auto;
      z-index: 90;
    }
    
    .menu-item {
      padding: 0 16px;
      margin-bottom: 8px;
    }
    
    .menu-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      color: var(--text-secondary);
      text-decoration: none;
    }
    
    .menu-link:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }
    
    .menu-link.active {
      background: linear-gradient(135deg, rgba(24, 144, 255, 0.2), rgba(82, 196, 26, 0.2));
      color: var(--primary);
      border-left: 3px solid var(--primary);
    }
    
    .menu-text {
      flex: 1;
      font-size: 0.95rem;
    }
    
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0 40px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .back-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
    }
    
    .back-btn:hover { background: rgba(255,255,255,0.1); }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon { font-size: 32px; }
    
    .logo-text {
      font-size: 1.4rem;
      font-weight: 700;
      background: linear-gradient(135deg, #1890ff, #52c41a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .main-content {
      margin-left: 240px;
      padding: 40px;
      max-width: calc(100% - 240px);
    }
    
    @media (max-width: 768px) {
      .sidebar-menu {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      
      .sidebar-menu.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
        max-width: 100%;
      }
    }
    
    .page-title {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .page-title h1 {
      font-size: 2rem;
      margin-bottom: 8px;
    }
    
    .page-title p {
      color: var(--text-secondary);
    }
    
    /* Âπ≥Âè∞ÈÄâÊã©Ê†áÁ≠æ */
    .platform-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .platform-tab {
      padding: 14px 28px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
    }
    
    .platform-tab:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    
    .platform-tab.active {
      background: linear-gradient(135deg, rgba(24,144,255,0.2), rgba(82,196,26,0.2));
      border-color: var(--primary);
    }
    
    /* APIÈÖçÁΩÆÂå∫Âüü */
    .api-config-section {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
      border: 1px solid var(--border);
    }
    
    .api-config-section h3 {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .api-config-section h3 .badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 20px;
      background: var(--primary);
      color: white;
      font-weight: normal;
    }
    
    .api-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-group label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .form-group input {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1rem;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .api-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .api-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .api-btn.primary {
      background: var(--primary);
      color: white;
    }
    
    .api-btn.primary:hover {
      background: var(--primary-dark);
    }
    
    .api-btn.success {
      background: var(--success);
      color: white;
    }
    
    .api-btn.secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text-primary);
    }
    
    .api-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .api-status {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    
    .api-status.success {
      background: rgba(82, 196, 26, 0.15);
      color: var(--success);
      border: 1px solid rgba(82, 196, 26, 0.3);
    }
    
    .api-status.error {
      background: rgba(255, 77, 79, 0.15);
      color: var(--danger);
      border: 1px solid rgba(255, 77, 79, 0.3);
    }
    
    .api-status.warning {
      background: rgba(250, 173, 20, 0.15);
      color: var(--warning);
      border: 1px solid rgba(250, 173, 20, 0.3);
    }
    
    .api-help {
      margin-top: 16px;
      padding: 16px;
      background: rgba(24, 144, 255, 0.1);
      border-radius: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.8;
    }
    
    .api-help a {
      color: var(--primary);
      text-decoration: none;
    }
    
    .api-help a:hover {
      text-decoration: underline;
    }
    
    /* ÂàõÂª∫Âå∫Âüü */
    .create-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }
    
    @media (max-width: 1000px) {
      .create-container { grid-template-columns: 1fr; }
    }
    
    .section-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border);
    }
    
    .section-card h3 {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* ÂΩ¢Ë±°ÈÄâÊã© */
    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .avatar-item {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s;
      text-align: center;
    }
    
    .avatar-item:hover { border-color: var(--primary); }
    
    .avatar-item.selected {
      border-color: var(--primary);
      background: rgba(24,144,255,0.1);
    }
    
    .avatar-item .avatar-icon {
      font-size: 3rem;
      margin-bottom: 8px;
    }
    
    .avatar-item .name {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    /* ‰∏ä‰º†ÂíåÂΩïÂà∂Âå∫Âüü */
    .upload-section, .record-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .upload-item, .record-item {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .upload-label {
      cursor: pointer;
    }
    
    .upload-box {
      background: var(--bg-secondary);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    
    .upload-box:hover {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.1);
    }
    
    .upload-icon {
      font-size: 2rem;
    }
    
    .upload-text {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .remove-btn:hover {
      transform: scale(1.1);
    }
    
    .record-btn {
      width: 100%;
      padding: 16px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }
    
    .record-btn:hover {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.1);
    }
    
    .record-btn.recording {
      background: rgba(255, 77, 79, 0.2);
      border-color: var(--danger);
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(255, 77, 79, 0); }
    }
    
    .record-icon {
      font-size: 2rem;
    }
    
    .record-text {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .record-preview {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 12px;
    }
    
    .record-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .record-action-btn {
      flex: 1;
      padding: 8px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s;
    }
    
    .record-action-btn:hover {
      background: var(--primary);
    }
    
    .record-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255, 77, 79, 0.1);
      border: 1px solid var(--danger);
      border-radius: 8px;
      margin-top: 12px;
      color: var(--danger);
      font-weight: 500;
    }
    
    .record-dot {
      width: 12px;
      height: 12px;
      background: var(--danger);
      border-radius: 50%;
      animation: blink 1s ease-in-out infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    /* ÊñáÊ°àËæìÂÖ• */
    .script-textarea {
      width: 100%;
      min-height: 150px;
      padding: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1rem;
      resize: vertical;
      margin-bottom: 16px;
      line-height: 1.6;
    }
    
    .script-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .char-count {
      text-align: right;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 16px;
    }
    
    .char-count.warning { color: var(--warning); }
    .char-count.error { color: var(--danger); }
    
    /* ÈÄâÈ°π */
    .options-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .option-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .option-select {
      width: 100%;
      padding: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .option-select:hover {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.05);
    }
    
    .option-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.2);
    }
    
    /* ÊªëÂùóÊéßÂà∂ */
    .slider-group {
      margin-bottom: 16px;
    }
    
    .slider-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .slider-header label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .slider-value {
      color: var(--primary);
      font-weight: 500;
    }
    
    .slider {
      width: 100%;
      -webkit-appearance: none;
      height: 6px;
      border-radius: 3px;
      background: var(--bg-secondary);
      outline: none;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }
    
    /* ÊåâÈíÆ */
    .btn-row {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn.primary {
      background: linear-gradient(135deg, #1890ff, #52c41a);
      color: white;
    }
    
    .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(24,144,255,0.3);
    }
    
    .btn.secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text-primary);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* È¢ÑËßàÂå∫Âüü */
    .preview-container {
      position: relative;
    }
    
    .preview-area {
      background: linear-gradient(135deg, #1a1a2e, #0f0f23);
      border-radius: 16px;
      aspect-ratio: 16/9;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    /* Èü≥È¢ëÊí≠ÊîæÂô® */
    .audio-player {
      margin-top: 16px;
      width: 100%;
    }
    
    .audio-player audio {
      width: 100%;
      height: 40px;
    }
    
    /* ÊéßÂà∂ÊåâÈíÆ */
    .control-row {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    
    .control-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 8px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .control-btn.active {
      background: var(--primary);
    }
    
    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ÂéÜÂè≤ËÆ∞ÂΩï */
    .history-section {
      margin-top: 40px;
    }
    
    .history-section h3 {
      margin-bottom: 20px;
    }
    
    .history-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    
    /* ‰ΩúÂìÅÁÆ°ÁêÜÂç°ÁâáÔºö‰∏Ä‰∏™ÁΩëÊ†ºÂÜÖÂûÇÁõ¥ ‚Äî ‰∏äÊñπÊ†áÈ¢òÂå∫„ÄÅ‰∏≠Èó¥‰ø°ÊÅØ„ÄÅÊúÄ‰∏ãÊñπÊåâÈíÆ */
    .history-item {
      display: flex;
      flex-direction: column;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }
    
    .history-item:hover {
      border-color: var(--primary);
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .history-avatar { font-size: 2rem; }
    
    .history-meta {
      text-align: right;
    }
    
    .history-platform {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--primary);
      color: white;
      margin-bottom: 4px;
      display: inline-block;
    }
    
    .history-date {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }
    
    .history-script {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .history-actions {
      display: flex;
      gap: 8px;
    }
    
    .history-btn {
      flex: 1;
      padding: 8px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s;
    }
    
    .history-btn:hover {
      background: var(--primary);
    }
    
    .empty-history {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }
    
    /* Âä†ËΩΩÂä®Áîª */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: white;
      font-size: 1rem;
    }
    
    .hidden { display: none !important; }
    
    /* ÂÜÖÂÆπÈù¢Êùø */
    .content-panel {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Ê≠•È™§ÊåáÁ§∫Âô® */
    .steps-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 40px 0;
      padding: 0 20px;
    }
    
    .step-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
      z-index: 2;
    }
    
    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--text-secondary);
      transition: all 0.3s;
    }
    
    .step-item.active .step-number {
      background: linear-gradient(135deg, var(--primary), var(--success));
      border-color: var(--primary);
      color: white;
      transform: scale(1.1);
    }
    
    .step-item.completed .step-number {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    
    .step-item.completed .step-number::after {
      content: '‚úì';
      font-size: 1.2rem;
    }
    
    .step-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    .step-item.active .step-label {
      color: var(--primary);
      font-weight: 500;
    }
    
    .step-line {
      flex: 1;
      height: 2px;
      background: var(--border);
      margin: 0 20px;
      position: relative;
      top: -20px;
    }
    
    .step-line.completed {
      background: var(--success);
    }
    
    /* Ê≠•È™§ÂÜÖÂÆπÂå∫Âüü */
    .step-content {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }
    
    .step-content.active {
      display: block;
    }
    
    .step-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 32px;
      border: 1px solid var(--border);
      margin-bottom: 24px;
    }
    
    .step-card h3 {
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
    }
    
    .step-card h3 .step-badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 12px;
      background: rgba(24, 144, 255, 0.2);
      color: var(--primary);
    }
    
    /* ÂΩ¢Ë±°ÈÄâÊã©‰ºòÂåñ */
    .avatar-selection-section {
      margin-bottom: 32px;
    }
    
    .section-title {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .tab-button {
      padding: 12px 20px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s;
    }
    
    .tab-button.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ‰∏ä‰º†Âå∫Âüü‰ºòÂåñ */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
      background: var(--bg-secondary);
    }
    
    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.05);
    }
    
    .upload-area.dragover {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.1);
      transform: scale(1.02);
    }
    
    .upload-icon-large {
      font-size: 3rem;
      margin-bottom: 16px;
    }
    
    .upload-text-large {
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .upload-hint {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    /* Á¥†ÊùêÈ¢ÑËßàÁΩëÊ†º */
    .material-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    
    .material-item {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px;
      border: 2px solid var(--border);
      transition: all 0.3s;
      position: relative;
    }
    
    .material-item:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    
    .material-item.selected {
      border-color: var(--primary);
      background: rgba(24, 144, 255, 0.1);
    }
    
    .material-preview {
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 8px;
      object-fit: cover;
      margin-bottom: 12px;
    }
    
    .material-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .material-name {
      font-size: 0.9rem;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .material-remove {
      width: 24px;
      height: 24px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }
    
    /* Êìç‰ΩúÊåâÈíÆÂå∫Âüü */
    .step-actions {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }
    
    .step-btn {
      padding: 12px 32px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .step-btn.prev {
      background: rgba(255,255,255,0.1);
      color: var(--text-primary);
    }
    
    .step-btn.prev:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .step-btn.next {
      background: linear-gradient(135deg, var(--primary), var(--success));
      color: white;
    }
    
    .step-btn.next:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(24,144,255,0.3);
    }
    
    .step-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* ËßÜÈ¢ëÈ¢ÑËßàÂå∫Âüü */
    #videoPreviewSection {
      margin-top: 24px;
    }
    
    #videoPreviewSection video {
      background: var(--bg-primary);
    }
    
    /* ÂÖ≥ÈîÆÂ∏ßÁΩëÊ†º */
    #frameGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
    }
    
    #frameGrid .material-item {
      cursor: pointer;
    }
    
    #frameGrid .material-preview {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
    }
    
    /* Âä†ËΩΩÂä®Áîª */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-spinner {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    
    .btn.loading {
      opacity: 0.7;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .btn.loading .loading-spinner {
      display: inline-block;
      margin-right: 4px;
    }
  </style>
</head>
<body data-back-url="../page.html?page=my-digital-worker">
  <header class="header">
    <div class="header-left">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <div class="logo">
        <span class="logo-icon">üåç</span>
        <span class="logo-text">International Digital Human Platform</span>
      </div>
    </div>
  </header>
  
  <!-- ‰æßËæπÊ†èËèúÂçï -->
  <aside class="sidebar-menu">
    <div class="menu-item">
      <a class="menu-link active" href="javascript:void(0)" onclick="switchMenu('create')" data-menu="create">
        <span class="menu-icon">‚ú®</span>
        <span class="menu-text">Create Digital Human</span>
      </a>
    </div>
    <div class="menu-item">
      <a class="menu-link" href="javascript:void(0)" onclick="switchMenu('manage')" data-menu="manage">
        <span class="menu-icon">üë•</span>
        <span class="menu-text">Digital Human Management</span>
      </a>
    </div>
    <div class="menu-item">
      <a class="menu-link" href="javascript:void(0)" onclick="switchMenu('works')" data-menu="works">
        <span class="menu-icon">üé¨</span>
        <span class="menu-text">Works Management</span>
      </a>
    </div>
    <div class="menu-item">
      <a class="menu-link" href="javascript:void(0)" onclick="switchMenu('recite')" data-menu="recite">
        <span class="menu-icon">üìñ</span>
        <span class="menu-text">Script Recitation</span>
      </a>
    </div>
    <div class="menu-item">
      <a class="menu-link" href="javascript:void(0)" onclick="switchMenu('promote')" data-menu="promote">
        <span class="menu-icon">üõí</span>
        <span class="menu-text">Product Promotion</span>
      </a>
    </div>
  </aside>
  
  <main class="main-content">
    <!-- ÂàõÂª∫Êï∞Â≠ó‰∫∫ÂÜÖÂÆπ -->
    <div class="content-panel" id="createPanel">
      <div class="page-title">
        <h1>‚ú® Create Digital Human</h1>
        <p>Create your exclusive digital human in three steps, let AI speak for you</p>
      </div>
      
      <!-- Ê≠•È™§ÊåáÁ§∫Âô® -->
      <div class="steps-indicator">
        <div class="step-item active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-label">Connect API</div>
        </div>
        <div class="step-line"></div>
        <div class="step-item" data-step="2">
          <div class="step-number">2</div>
          <div class="step-label">Select Avatar</div>
        </div>
        <div class="step-line"></div>
        <div class="step-item" data-step="3">
          <div class="step-number">3</div>
          <div class="step-label">Configure Generation</div>
        </div>
      </div>
    
    <!-- Ê≠•È™§1ÔºöÊé•ÂÖ•API -->
    <div class="step-content active" id="step1Content">
      <div class="step-card">
        <h3>üîë Connect Voice API <span class="step-badge">Step 1/3</span></h3>
        
        <div class="section-title">Select Digital Human Platform</div>
        <div class="platform-tabs" style="display: flex; margin-bottom: 24px;">
          <div class="platform-tab active" data-platform="heygen">
            <span class="icon">üé¨</span>
            <span>HeyGen</span>
            <span class="tag" style="background: var(--primary);">AI Digital Human</span>
          </div>
        </div>
        
        <!-- APIÈÖçÁΩÆÂå∫Âüü -->
        <div class="api-config-section" id="apiConfigSection" style="margin-bottom: 32px;">
          <!-- HeyGenÈÖçÁΩÆ -->
          <div class="api-config" id="heygenConfig">
            <h3>üé¨ HeyGen AI Digital Human Configuration <span class="badge">Configuration Required</span></h3>
            <div class="api-form">
              <div class="form-group">
                <label>API Key</label>
                <input type="password" id="heygenApiKey" placeholder="Enter HeyGen API Key">
              </div>
            </div>
            <div class="api-actions">
              <button class="api-btn primary" onclick="saveHeyGenConfig()">üíæ Save Configuration</button>
              <button class="api-btn success" onclick="testHeyGenApi()">üß™ Test Connection</button>
            </div>
            <div id="heygenStatus"></div>
            <div class="api-help">
              <strong>üìñ How to Get:</strong><br>
              1. Visit <a href="https://www.heygen.com" target="_blank" rel="noopener">HeyGen Official Website</a> to register an account<br>
              2. Go to Console ‚Üí API Settings<br>
              3. Create API Key and copy<br>
              <br>
              <strong>‚ú® Features:</strong><br>
              ‚Ä¢ AI-powered digital human video generation<br>
              ‚Ä¢ Multi-language voice synthesis support<br>
              ‚Ä¢ High-quality video output<br>
              ‚Ä¢ Rich digital human avatar library<br>
              üí° Free trial credits available
            </div>
          </div>
        </div>
        
        <div class="step-actions">
          <div></div>
          <button class="step-btn next" onclick="goToStep(2)">Next: Select Avatar ‚Üí</button>
        </div>
      </div>
    </div>
    
    <!-- Ê≠•È™§2ÔºöÈÄâÊã©ÂΩ¢Ë±° -->
    <div class="step-content" id="step2Content">
      <div class="step-card">
        <h3>üë§ Select Digital Human Avatar <span class="step-badge">Step 2/3</span></h3>
        
        <!-- ÈáçË¶ÅÊèêÁ§∫ÔºöÊ≠§Ê≠•È™§‰∏∫ÂèØÈÄâ -->
        <div style="background: linear-gradient(135deg, rgba(24, 144, 255, 0.15) 0%, rgba(114, 46, 209, 0.1) 100%); border: 2px solid var(--primary); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
          <div style="display: flex; align-items: flex-start; gap: 16px;">
            <div style="font-size: 2rem; line-height: 1;">‚ú®</div>
            <div style="flex: 1;">
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-bottom: 8px;">
                HeyGen Platform Instructions
              </div>
              <div style="font-size: 0.95rem; color: var(--text-primary); line-height: 1.8;">
                <strong>The system will automatically select digital human avatars from the HeyGen platform for video generation.</strong><br>
                ‚Ä¢ HeyGen platform provides 1287+ digital human avatars for you to choose from<br>
                ‚Ä¢ You can skip this step and proceed directly to the next step for configuration<br>
                ‚Ä¢ The upload and recording functions below are <strong style="color: var(--primary);">optional operations</strong>, for reference only
              </div>
            </div>
          </div>
        </div>
        
        <!-- ÂΩ¢Ë±°ÈÄâÊã©ÊñπÂºèÂàáÊç¢ -->
        <div style="margin-bottom: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
            <div class="section-title" style="margin: 0;">Select Avatar Method</div>
            <div style="background: rgba(24, 144, 255, 0.08); border: 1px solid var(--primary); border-radius: 8px; padding: 8px 12px; font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap;">
              üí° Tip: Please select one method, cannot use simultaneously
            </div>
          </div>
          <div class="tab-buttons" style="margin-bottom: 20px;">
            <button class="tab-button active" id="avatarModeTemplate" onclick="switchAvatarMode('template')">üé® Select Template</button>
            <button class="tab-button" id="avatarModeUpload" onclick="switchAvatarMode('upload')">üìé Upload Reference Files</button>
            <button class="tab-button" id="avatarModeRecord" onclick="switchAvatarMode('record')">üé¨ Real-time Recording</button>
          </div>
        </div>
        
        <!-- ÈÄâÊã©Ê®°ÊùøÂå∫Âüü -->
        <div id="templateSelectionSection" style="margin-bottom: 32px;">
          <!-- Êï∞Â≠ó‰∫∫Ê®°ÊùøÈÄâÊã© -->
          <div style="margin-bottom: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div class="section-title" style="margin: 0;">Select Digital Human Template</div>
              <button class="btn secondary" id="refreshAvatarBtn" onclick="loadHeyGenAvatars('create')" style="padding: 8px 16px; font-size: 0.85rem; position: relative;">
                <span id="refreshAvatarIcon">üîÑ</span>
                <span id="refreshAvatarText">Refresh Templates</span>
              </button>
            </div>
            <div id="avatarTemplateGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; min-height: 200px; max-height: 600px; overflow-y: auto; padding: 8px;">
              <div id="avatarLoadingState" style="text-align: center; color: var(--text-secondary); padding: 40px; grid-column: 1 / -1;">
                <div style="font-size: 2.5rem; margin-bottom: 12px; animation: pulse 2s infinite;">‚è≥</div>
                <div style="font-size: 0.9rem; margin-bottom: 8px;">Loading templates...</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); opacity: 0.7;">Please wait, fetching digital human templates from HeyGen platform</div>
              </div>
            </div>
            
            <!-- Ê®°ÊùøËßÜÈ¢ëÈ¢ÑËßàÂå∫Âüü -->
            <div id="templatePreviewSection" style="display: none; margin-top: 24px; margin-bottom: 24px;">
              <div class="section-title">Template Preview</div>
              <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 2px solid var(--primary);">
                <div id="templatePreviewContent" style="text-align: center; color: var(--text-secondary);">
                  <div style="font-size: 2rem; margin-bottom: 12px;">‚è≥</div>
                  <div>Loading preview...</div>
                </div>
              </div>
            </div>
            <!-- Âä†ËΩΩÊõ¥Â§öÊåâÈíÆ -->
            <div id="loadMoreContainer" style="text-align: center; margin-bottom: 16px; display: none;">
              <button class="btn secondary" id="loadMoreBtn" onclick="loadMoreAvatars('create')" style="padding: 10px 24px;">
                <span id="loadMoreText">Load More Templates</span>
                <span id="loadMoreIcon" style="margin-left: 8px;">‚¨áÔ∏è</span>
              </button>
            </div>
            <!-- ÂàÜÈ°µÊéßÂà∂ -->
            <div id="paginationContainer" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 16px; display: none;">
              <button class="btn secondary" id="prevPageBtn" onclick="changePage(-1)" style="padding: 8px 16px; font-size: 0.85rem;" disabled>Previous Page</button>
              <span id="pageInfo" style="font-size: 0.9rem; color: var(--text-secondary); padding: 0 16px;">Page 1 of 1</span>
              <button class="btn secondary" id="nextPageBtn" onclick="changePage(1)" style="padding: 8px 16px; font-size: 0.85rem;">Next Page</button>
            </div>
            <div style="background: rgba(24, 144, 255, 0.08); border: 1px solid var(--primary); border-radius: 12px; padding: 12px; font-size: 0.9rem; color: var(--text-secondary); text-align: center;">
              üí° Tip: After selecting a template, the system will use that digital human avatar to generate videos. You can also skip the selection, and the system will automatically select a default avatar.
            </div>
          </div>
        </div>
        
        <!-- ‰∏ä‰º†ÂèÇËÄÉÊñá‰ª∂Âå∫Âüü -->
        <div id="uploadReferenceSection" style="display: none; margin-bottom: 32px;">
          <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
              <strong style="color: var(--warning);">Important Notice</strong>
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
              When uploading reference files, you need to <strong style="color: var(--primary);">upload both video and audio</strong>. Video provides avatar reference, audio provides voice reference.
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- ËßÜÈ¢ë‰∏ä‰º†Âå∫Âüü -->
            <div>
              <div style="background: rgba(24, 144, 255, 0.08); border: 1px solid var(--primary); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">üìã</span>
                  <strong>Video Requirements</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.8;">
                  ‚Ä¢ <strong>Duration:</strong> Recommended 10-60 seconds<br>
                  ‚Ä¢ <strong>Content:</strong> Person clearly visible, front or semi-profile preferred<br>
                  ‚Ä¢ <strong>Format:</strong> Common formats like MP4, WebM, MOV<br>
                  ‚Ä¢ <strong>Resolution:</strong> Recommended 720p or higher
                </div>
              </div>
              
              <div class="upload-area" id="uploadArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" style="min-height: 200px;">
                <input type="file" id="uploadFile" accept="video/*" style="display: none;" onchange="handleVideoFileUpload(this)">
                <div class="upload-icon-large">üé¨</div>
                <div class="upload-text-large">Click or drag video here to upload</div>
                <div class="upload-hint">Supports MP4, WebM, MOV formats</div>
                <button class="btn secondary" style="margin-top: 20px;" onclick="document.getElementById('uploadFile').click()">Select Video File</button>
              </div>
              
              <!-- ËßÜÈ¢ëÈ¢ÑËßàÂå∫Âüü -->
              <div id="videoPreviewSection" style="display: none; margin-top: 16px;">
                <div class="section-title">Video Preview</div>
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; border: 1px solid var(--border);">
                  <video id="uploadedVideoPreview" controls style="width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 12px;"></video>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                      <div>File Name: <span id="videoFileName">-</span></div>
                      <div style="margin-top: 4px;">Duration: <span id="videoDuration">-</span></div>
                    </div>
                    <button class="btn secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="removeUploadedVideo()">üóëÔ∏è Delete</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Èü≥È¢ë‰∏ä‰º†Âå∫Âüü -->
            <div>
              <div style="background: rgba(24, 144, 255, 0.08); border: 1px solid var(--primary); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">üìã</span>
                  <strong>Audio Requirements</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.8;">
                  ‚Ä¢ <strong>Format:</strong> Common formats like MP3, WAV, M4A<br>
                  ‚Ä¢ <strong>Quality:</strong> Recommended clear, no background noise<br>
                  ‚Ä¢ <strong>Duration:</strong> Recommended to match video duration
                </div>
              </div>
              
              <div class="upload-area" id="uploadAudioArea" ondrop="handleAudioDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" style="min-height: 200px;">
                <input type="file" id="uploadAudioFile" accept="audio/*" style="display: none;" onchange="handleAudioFileUpload(this)">
                <div class="upload-icon-large">üéµ</div>
                <div class="upload-text-large">Click or drag audio here to upload</div>
                <div class="upload-hint">Supports MP3, WAV, M4A formats</div>
                <button class="btn secondary" style="margin-top: 20px;" onclick="document.getElementById('uploadAudioFile').click()">Select Audio File</button>
              </div>
              
              <!-- Èü≥È¢ëÈ¢ÑËßàÂå∫Âüü -->
              <div id="audioPreviewSection" style="display: none; margin-top: 16px;">
                <div class="section-title">Audio Preview</div>
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; border: 1px solid var(--border);">
                  <audio id="uploadedAudioPreview" controls style="width: 100%; margin-bottom: 12px;"></audio>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                      <div>File Name: <span id="audioFileName">-</span></div>
                      <div style="margin-top: 4px;">Size: <span id="audioFileSize">-</span></div>
                    </div>
                    <button class="btn secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="removeUploadedAudio()">üóëÔ∏è Delete</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Á°ÆËÆ§ÊåâÈíÆ -->
          <div style="margin-top: 24px; text-align: center;">
            <button class="btn primary" style="padding: 12px 32px; font-size: 1rem; font-weight: 600;" onclick="confirmVideoAndAudioSelection()">
              ‚úÖ Confirm Using This Video and Audio
            </button>
          </div>
        </div>
        
        <!-- ÂÆûÊó∂ÂΩïÂà∂Âå∫Âüü -->
        <div id="recordSection" style="display: none; margin-bottom: 32px;">
          <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
              <strong style="color: var(--warning);">ÈáçË¶ÅÊèêÁ§∫</strong>
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
              When recording in real-time, you need to <strong style="color: var(--primary);">record both video and audio</strong>. Video provides avatar reference, audio provides voice reference.
            </div>
          </div>
          
          <div id="permissionHint" style="background: rgba(24, 144, 255, 0.08); border: 1px solid var(--primary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <span style="font-size: 1.2rem;">üí°</span>
              <div style="flex: 1;">
                <strong style="display: block; margin-bottom: 8px;">Usage Instructions</strong>
                <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.8;">
                  ‚Ä¢ When clicking the record button, the browser will pop up a permission request window<br>
                  ‚Ä¢ Please click "Allow" to enable recording<br>
                  ‚Ä¢ Need to <strong style="color: var(--primary);">record both video and audio</strong> to submit<br>
                  ‚Ä¢ If the browser does not pop up a permission request window, it may be because permissions were previously denied<br>
                  ‚Ä¢ At this time, please click the lock icon on the left side of the browser address bar, set the permission to "Allow" and refresh the page
                </div>
              </div>
            </div>
          </div>
          
          <div class="record-section" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="record-item">
              <div style="text-align: center; margin-bottom: 12px;">
                <strong style="color: var(--primary);">üìπ Record Video</strong>
              </div>
              <button class="record-btn" id="recordVideoBtn" onclick="toggleVideoRecording()">
                <span class="record-icon">üìπ</span>
                <span class="record-text">Record Video</span>
              </button>
              <div class="record-preview" id="videoRecordPreview" style="display: none;">
                <video id="recordedVideo" controls style="max-width: 100%; max-height: 200px; border-radius: 8px;"></video>
                <div class="record-actions">
                  <button class="record-action-btn" onclick="playRecordedVideo()">‚ñ∂Ô∏è Play</button>
                  <button class="record-action-btn" onclick="removeRecordedVideo()">üóëÔ∏è Delete</button>
                </div>
              </div>
            </div>
            
            <div class="record-item">
              <div style="text-align: center; margin-bottom: 12px;">
                <strong style="color: var(--primary);">üéôÔ∏è Record Audio</strong>
              </div>
              <button class="record-btn" id="recordAudioBtn" onclick="toggleAudioRecording()">
                <span class="record-icon">üéôÔ∏è</span>
                <span class="record-text">Record Audio</span>
              </button>
              <div class="record-preview" id="audioRecordPreview" style="display: none;">
                <audio id="recordedAudio" controls style="width: 100%;"></audio>
                <div class="record-actions">
                  <button class="record-action-btn" onclick="playRecordedAudio()">‚ñ∂Ô∏è Play</button>
                  <button class="record-action-btn" onclick="removeRecordedAudio()">üóëÔ∏è Delete</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="record-status" id="recordStatus" style="display: none;">
            <span class="record-dot"></span>
            <span id="recordTime">00:00</span>
          </div>
          
          <!-- Á°ÆËÆ§ÊåâÈíÆ -->
          <div style="margin-top: 24px; text-align: center;">
            <button class="btn primary" style="padding: 12px 32px; font-size: 1rem; font-weight: 600;" onclick="confirmRecordedVideoAndAudio()">
              ‚úÖ Confirm Using Recorded Video and Audio
            </button>
          </div>
        </div>
        
        <!-- ËØ≠Èü≥ÈÄâÊã©Ôºà‰ªÖÂú®Ê®°ÊùøÊ®°Âºè‰∏ãÊòæÁ§∫Ôºâ -->
        <div id="voiceSelectionSection" style="margin-bottom: 32px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div class="section-title" style="margin: 0;">üéµ Select Voice</div>
            <button class="btn secondary" id="refreshVoiceBtn" onclick="loadHeyGenVoices('create')" style="padding: 8px 16px; font-size: 0.85rem; position: relative;">
              <span id="refreshVoiceIcon">üîÑ</span>
              <span id="refreshVoiceText">Refresh Voices</span>
            </button>
          </div>
          
          <!-- ÊêúÁ¥¢Ê°Ü -->
          <div style="margin-bottom: 16px;">
            <input 
              type="text" 
              id="voiceSearchInput" 
              placeholder="üîç Search voices (by name, language, gender)..." 
              oninput="filterVoices()"
              style="width: 100%; padding: 12px 16px; font-size: 0.95rem; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 12px; color: var(--text-primary); transition: all 0.3s;"
              onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(24, 144, 255, 0.1)';"
              onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';">
          </div>
          
          <!-- ËØ≠Èü≥ÁΩëÊ†ºÂÆπÂô® -->
          <div id="voiceGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; min-height: 200px; max-height: 600px; overflow-y: auto; padding: 8px;">
            <div id="voiceLoadingState" style="text-align: center; color: var(--text-secondary); padding: 40px; grid-column: 1 / -1;">
              <div style="font-size: 2.5rem; margin-bottom: 12px; animation: pulse 2s infinite;">‚è≥</div>
              <div style="font-size: 0.9rem; margin-bottom: 8px;">Loading voices...</div>
              <div style="font-size: 0.75rem; color: var(--text-secondary); opacity: 0.7;">Please wait, fetching voice list from HeyGen platform</div>
            </div>
          </div>
          
          <!-- ÈöêËóèÁöÑselectÁî®‰∫éÂêëÂêéÂÖºÂÆπ -->
          <select class="option-select" id="voiceSelect" style="display: none;">
            <option value="">üé§ Default Voice (Auto Select)</option>
          </select>
          
          <div style="background: linear-gradient(135deg, rgba(24, 144, 255, 0.12), rgba(82, 196, 26, 0.08)); border: 1px solid var(--primary); border-radius: 12px; padding: 16px; margin-top: 16px; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.8;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <span style="font-size: 1.2rem; flex-shrink: 0;">üí°</span>
              <div>
                <strong style="color: var(--primary); display: block; margin-bottom: 6px;">Voice Selection Instructions</strong>
                <div>This option is used to select TTS voice for reading your input script. If template mode is selected, you need to select both template and voice to proceed to the next step. If not selected, the system will automatically select an appropriate voice based on the script language.</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="step-actions" style="margin-top: 32px; padding-top: 24px; border-top: 2px solid var(--border);">
          <button class="step-btn prev" onclick="goToStep(1)">‚Üê Previous Step</button>
          <button class="step-btn next primary" onclick="goToStep(3)" style="background: var(--primary); color: white; font-weight: 600;">
            Next: Configure Generation ‚Üí
          </button>
        </div>
      </div>
    </div>
    
    <!-- Ê≠•È™§3ÔºöÈÖçÁΩÆÁîüÊàê -->
    <div class="step-content" id="step3Content">
      <div class="step-card">
        <h3>üéõÔ∏è Configure Generation <span class="step-badge">Step 3/3</span></h3>
        
        <!-- ËßÜÈ¢ëÂΩ¢Ë±°È¢ÑËßà -->
        <div id="step3VideoPreview" style="margin-bottom: 32px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);">
          <div class="section-title">Digital Human Video Avatar</div>
          <div id="step3VideoDisplay" style="text-align: center; color: var(--text-secondary);">
            Please go back to the previous step to select video avatar
          </div>
        </div>
        
        <div class="section-title">Input Script</div>
        <textarea class="script-textarea" id="scriptInput" placeholder="Enter what the digital human will say...&#10;&#10;Example: Hello everyone, welcome to our live stream! Today we bring you great deals..." oninput="updateCharCount()" style="min-height: 120px;"></textarea>
        <div class="char-count" id="charCount">0 / 500 characters</div>
        
        <div class="section-title" style="margin-top: 24px;">Audio Settings</div>
        <div class="options-grid">
          <div class="option-group">
            <label>Audio Format</label>
            <select class="option-select" id="formatSelect">
              <option value="wav">WAV (High Quality)</option>
              <option value="mp3">MP3 (Universal)</option>
            </select>
          </div>
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <label>‚ö° Speed</label>
            <span class="slider-value" id="speedValue">5</span>
          </div>
          <input type="range" class="slider" id="speedSlider" min="0" max="15" value="5" oninput="updateSliderValue('speed')">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <label>üéµ Pitch</label>
            <span class="slider-value" id="pitchValue">5</span>
          </div>
          <input type="range" class="slider" id="pitchSlider" min="0" max="15" value="5" oninput="updateSliderValue('pitch')">
        </div>
        
        <div class="slider-group">
          <div class="slider-header">
            <label>üîä Volume</label>
            <span class="slider-value" id="volumeValue">5</span>
          </div>
          <input type="range" class="slider" id="volumeSlider" min="0" max="15" value="5" oninput="updateSliderValue('volume')">
        </div>
        
        <div class="section-title" style="margin-top: 32px;">Digital Human Information</div>
        <div class="form-group" style="margin-bottom: 16px;">
          <label>Digital Human Name</label>
          <input type="text" id="digitalHumanName" placeholder="Give your digital human a name" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
        </div>
        <div class="form-group" style="margin-bottom: 16px;">
          <label>Digital Human Description</label>
          <textarea id="digitalHumanDesc" placeholder="Describe the characteristics and uses of the digital human..." style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: vertical;"></textarea>
        </div>
        
        <div class="step-actions">
          <button class="step-btn prev" onclick="goToStep(2)">‚Üê Previous Step</button>
          <button class="step-btn next" onclick="createDigitalHuman()">üöÄ Generate Digital Human</button>
        </div>
      </div>
    </div>
      </div>
    </div>
    
    <!-- Êï∞Â≠ó‰∫∫ÁÆ°ÁêÜÂÜÖÂÆπ -->
    <div class="content-panel hidden" id="managePanel">
      <div class="page-title">
        <h1>üë• Digital Human Management</h1>
        <p>Manage all digital humans you created</p>
      </div>
      
      <div class="history-list" id="digitalHumanManageList">
        <!-- Âä®ÊÄÅÂä†ËΩΩ -->
      </div>
    </div>
    
    <!-- ‰ΩúÂìÅÁÆ°ÁêÜÂÜÖÂÆπ -->
    <div class="content-panel hidden" id="worksPanel">
      <div class="page-title">
        <h1>üé¨ Works Management</h1>
        <p>Manage all generated video works</p>
      </div>
      
      <div class="history-list" id="worksList">
        <!-- Âä®ÊÄÅÂä†ËΩΩ -->
      </div>
    </div>
    
    <!-- ËØµËØªÊñáÊ°àÈù¢Êùø -->
    <div class="content-panel hidden" id="recitePanel">
      <div class="page-title">
        <h1>üìñ Script Recitation</h1>
        <p>Let digital humans help you recite scripts and generate professional videos</p>
      </div>
      
      <div class="step-card" style="max-width: 900px; margin: 0 auto;">
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">ÈÄâÊã©Êï∞Â≠ó‰∫∫ÂΩ¢Ë±°</label>
          <div id="reciteAvatarSelector" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 16px; margin-bottom: 24px;">
            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
              <div style="font-size: 2rem; margin-bottom: 8px;">‚è≥</div>
              <div style="font-size: 0.85rem;">Ê≠£Âú®Âä†ËΩΩÊ®°Êùø...</div>
            </div>
          </div>
          <button class="btn secondary" onclick="loadHeyGenAvatars('recite')" style="width: 100%;">
            üîÑ Âà∑Êñ∞Ê®°ÊùøÂàóË°®
          </button>
        </div>
        
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Script Content <span style="color: var(--text-secondary); font-weight: normal;">(Required)</span></label>
          <textarea id="reciteScript" class="script-input" placeholder="Please enter the script content to be recited..." rows="8" style="width: 100%; padding: 16px; border-radius: 12px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); font-size: 1rem; line-height: 1.6; resize: vertical;"></textarea>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
            <span style="font-size: 0.85rem; color: var(--text-secondary);">
              Character Count: <span id="reciteCharCount">0</span> / 1000
            </span>
            <button class="btn secondary" onclick="loadHeyGenVoices('recite')" style="padding: 8px 16px; font-size: 0.85rem;">
              üîÑ Get Voice List
            </button>
          </div>
        </div>
        
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Select Voice</label>
          <select id="reciteVoiceSelect" class="option-select" style="width: 100%;">
            <option value="">Default Voice (Auto Select)</option>
          </select>
        </div>
        
        <div style="display: flex; gap: 12px;">
          <button class="btn primary" style="flex: 1; padding: 16px; font-size: 1rem; font-weight: 600;" onclick="createReciteVideo()">
            üöÄ Generate Recitation Video
          </button>
          <button class="btn secondary" style="padding: 16px;" onclick="previewReciteScript()">
            üîä Preview Voice
          </button>
        </div>
      </div>
      
      <div class="history-list" id="reciteHistoryList" style="margin-top: 40px;">
        <!-- Âä®ÊÄÅÂä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï -->
      </div>
    </div>
    
    <!-- ÂçñË¥ßÊé®ÈÄÅÈù¢Êùø -->
    <div class="content-panel hidden" id="promotePanel">
      <div class="page-title">
        <h1>üõí Product Promotion</h1>
        <p>Create product promotion videos, digital humans help you sell</p>
      </div>
      
      <div class="step-card" style="max-width: 900px; margin: 0 auto;">
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">ÈÄâÊã©Êï∞Â≠ó‰∫∫ÂΩ¢Ë±°</label>
          <div id="promoteAvatarSelector" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 16px; margin-bottom: 24px;">
            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
              <div style="font-size: 2rem; margin-bottom: 8px;">‚è≥</div>
              <div style="font-size: 0.85rem;">Ê≠£Âú®Âä†ËΩΩÊ®°Êùø...</div>
            </div>
          </div>
          <button class="btn secondary" onclick="loadHeyGenAvatars('promote')" style="width: 100%;">
            üîÑ Âà∑Êñ∞Ê®°ÊùøÂàóË°®
          </button>
        </div>
        
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Product Name <span style="color: var(--text-secondary); font-weight: normal;">(Required)</span></label>
          <input type="text" id="promoteProductName" class="script-input" placeholder="Please enter product name..." style="width: 100%; padding: 12px 16px; border-radius: 12px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); font-size: 1rem;">
        </div>
        
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Product Description <span style="color: var(--text-secondary); font-weight: normal;">(Required)</span></label>
          <textarea id="promoteProductDesc" class="script-input" placeholder="Please enter product description and selling points..." rows="6" style="width: 100%; padding: 16px; border-radius: 12px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); font-size: 1rem; line-height: 1.6; resize: vertical;"></textarea>
          <div style="margin-top: 8px; font-size: 0.85rem; color: var(--text-secondary);">
            Character Count: <span id="promoteCharCount">0</span> / 500
          </div>
        </div>
        
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Upload Product Image <span style="color: var(--text-secondary); font-weight: normal;">(Optional)</span></label>
          <div class="upload-area" id="promoteImageUploadArea" ondrop="handleProductImageDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" style="min-height: 150px;">
            <input type="file" id="promoteImageInput" accept="image/*" style="display: none;" onchange="handleProductImageUpload(this, 'promote')">
            <div class="upload-icon-large">üñºÔ∏è</div>
            <div class="upload-text-large">Click or drag product image here</div>
            <div class="upload-hint">Supports JPG, PNG, WebP formats</div>
            <button class="btn secondary" style="margin-top: 20px;" onclick="document.getElementById('promoteImageInput').click()">Select Image</button>
          </div>
          <div id="promoteImagePreview" style="display: none; margin-top: 16px;">
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; border: 1px solid var(--border);">
              <img id="promoteImagePreviewImg" src="" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 12px;">
              <button class="btn secondary" onclick="removeProductImage('promote')" style="width: 100%;">üóëÔ∏è Delete Image</button>
            </div>
          </div>
        </div>
        
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Select Voice</label>
          <select id="promoteVoiceSelect" class="option-select" style="width: 100%;">
            <option value="">Default Voice (Auto Select)</option>
          </select>
        </div>
        
        <div style="display: flex; gap: 12px;">
          <button class="btn primary" style="flex: 1; padding: 16px; font-size: 1rem; font-weight: 600;" onclick="createPromoteVideo()">
            üöÄ Generate Promotion Video
          </button>
          <button class="btn secondary" onclick="loadHeyGenVoices('promote')" style="padding: 16px;">
            üîÑ Get Voices
          </button>
        </div>
      </div>
      
      <div class="history-list" id="promoteHistoryList" style="margin-top: 40px;">
        <!-- Âä®ÊÄÅÂä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï -->
      </div>
    </div>
  </main>
  
  <!-- Âä†ËΩΩÂä®Áîª -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Generating voice...</div>
  </div>
  
  <script>
    // ========== API ÈÖçÁΩÆ ==========
    // API Âü∫Á°Ä URL ÈÖçÁΩÆÔºàÊîØÊåÅÊú¨Âú∞ÂíåÁ∫ø‰∏äÊµãËØïÔºâ
    // ÂèØ‰ª•ÈÄöËøá localStorage ËÆæÁΩÆ 'api_base_url' Êù•Ë¶ÜÁõñÈªòËÆ§ÂÄº
    // ËÆæÁΩÆ 'use_local' ‰∏∫ 'true' Âº∫Âà∂‰ΩøÁî®Êú¨Âú∞Âú∞ÂùÄÔºàÂç≥‰ΩøÂú®Á∫ø‰∏ä‰πü‰ΩøÁî®localhostÔºâ
    function getApiBaseUrl() {
      // ‰ºòÂÖà‰ªé localStorage ËØªÂèñÈÖçÁΩÆ
      try {
        const customBaseUrl = localStorage.getItem('api_base_url');
        if (customBaseUrl && customBaseUrl.trim()) {
          // Â¶ÇÊûúÊòéÁ°ÆËÆæÁΩÆ‰∫Üapi_base_urlÔºå‰ΩøÁî®ËØ•ÂÄºÔºàÂÖÅËÆ∏localhostÔºâ
          return customBaseUrl.trim().replace(/\/+$/, '');
        }
      } catch (e) {
        console.warn('Êó†Ê≥ïËØªÂèñ api_base_url ÈÖçÁΩÆ:', e);
      }
      
      // Ê£ÄÊü•ÊòØÂê¶Âº∫Âà∂‰ΩøÁî®Êú¨Âú∞
      const useLocal = localStorage.getItem('use_local') === 'true';
      const currentOrigin = window.location.origin;
      const isLocalhost = currentOrigin.includes('localhost') || currentOrigin.includes('127.0.0.1');
      
      if (useLocal || isLocalhost) {
        // Êú¨Âú∞ÁéØÂ¢ÉÔºö‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑÔºàÁ©∫Â≠óÁ¨¶‰∏≤ÔºâÔºåËøôÊ†∑‰ºö‰ΩøÁî®ÂΩìÂâçÂüüÂêçÂíåÁ´ØÂè£
        return '';
      }
      
      // Á∫ø‰∏äÁéØÂ¢ÉÔºö‰ΩøÁî®ÂΩìÂâçÈ°µÈù¢ÁöÑorigin
      return currentOrigin;
    }

    function buildApiUrl(path) {
      const baseUrl = getApiBaseUrl();
      const normalizedPath = path.startsWith('/') ? path : '/' + path;
      return baseUrl + normalizedPath;
    }
    // Ê£ÄÊü•ÁôªÂΩï
    const user = JSON.parse(sessionStorage.getItem('user'));
    if (!user) window.location.href = '/';
    
    // ÂÖ®Â±ÄÂèòÈáè
    let currentPlatform = 'heygen';
    let selectedAvatar = 'üë©‚Äçüíº';
    let selectedAvatarId = null; // ÈÄâ‰∏≠ÁöÑ HeyGen avatar ID
    let selectedAvatarForRecite = null; // ËØµËØªÊñáÊ°àÈÄâ‰∏≠ÁöÑ avatar ID
    let selectedAvatarForPromote = null; // ÂçñË¥ßÊé®ÈÄÅÈÄâ‰∏≠ÁöÑ avatar ID
    let heygenAvatarsCache = null; // ÁºìÂ≠òÁöÑ avatar ÂàóË°®
    let heygenVoicesCache = null; // ÁºìÂ≠òÁöÑËØ≠Èü≥ÂàóË°®
    let selectedVoiceId = null; // ÈÄâ‰∏≠ÁöÑËØ≠Èü≥ID
    let currentAvatarMode = 'template'; // ÂΩìÂâçÈÄâÊã©ÁöÑÂΩ¢Ë±°Ê®°ÂºèÔºö'template', 'upload', 'record'
    let selectedTemplatePreviewVideo = null; // Ê®°ÊùøÊ®°Âºè‰∏ãÊ≠•È™§3Â±ïÁ§∫Áî®ÁöÑÈ¢ÑËßàËßÜÈ¢ë URL
    let selectedTemplatePreviewImage = null; // Ê®°ÊùøÊ®°Âºè‰∏ãÊ≠•È™§3Â±ïÁ§∫Áî®ÁöÑÈ¢ÑËßàÂõæÁâá URL
    let selectedTemplateName = null; // ÈÄâ‰∏≠ÁöÑÊ®°ÊùøÂêçÁß∞
    
    // ËµÑÊ∫êÁ±ªÂûãÂíåÂàÜÈ°µÁõ∏ÂÖ≥ÂèòÈáè
    let currentResourceType = 'video'; // Âõ∫ÂÆö‰∏∫ËßÜÈ¢ëÁ±ªÂûã
    let currentPage = 1;
    let pageSize = 30; // ÊØèÈ°µÊòæÁ§∫ÁöÑÊï∞Èáè
    let totalAvatars = 0;
    let displayedAvatars = 0;
    let digitalHumanType = 'video'; // ËßÜÈ¢ëÊï∞Â≠ó‰∫∫
    let currentAudioUrl = null;
    let currentAudioBlob = null;
    let audioContext = null;
    
    // ÂΩïÂà∂Áõ∏ÂÖ≥ÂèòÈáè
    let videoStream = null;
    let audioStream = null;
    let videoRecorder = null;
    let audioRecorder = null;
    let recordedVideoBlob = null;
    let recordedAudioBlob = null;
    let currentVideoUrl = null;
    let isRecordingVideo = false;
    let isRecordingAudio = false;
    let recordStartTime = null;
    let recordTimer = null;
    
    // ÂΩìÂâçÊ≠•È™§
    let currentStep = 1;
    let uploadedMaterials = [];
    let selectedVideoFile = null;
    let selectedAudioFile = null;
    let selectedVideoUrl = null;
    let extractedFrames = [];
    let selectedFrameId = null;
    
    // ‰ªªÂä°ËΩÆËØ¢Áä∂ÊÄÅÁÆ°ÁêÜ
    const taskPollingIntervals = new Map();
    
    // ========== ËèúÂçïÂàáÊç¢ÔºàÊèêÂâçÂÆö‰πâ‰ª•Á°Æ‰øùÂÖ®Â±ÄÂèØÁî®Ôºâ==========
    function switchMenu(menu) {
      // Êõ¥Êñ∞ËèúÂçïÊøÄÊ¥ªÁä∂ÊÄÅ
      document.querySelectorAll('.menu-link').forEach(link => {
        link.classList.remove('active');
      });
      const activeLink = document.querySelector(`[data-menu="${menu}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
      }
      
      // ÈöêËóèÊâÄÊúâÈù¢Êùø
      document.querySelectorAll('.content-panel').forEach(panel => {
        panel.classList.add('hidden');
      });
      
      // ÊòæÁ§∫ÂØπÂ∫îÈù¢Êùø
      const panelMap = {
        'create': 'createPanel',
        'manage': 'managePanel',
        'works': 'worksPanel',
        'recite': 'recitePanel',
        'promote': 'promotePanel'
      };
      
      const panelId = panelMap[menu];
      if (panelId) {
        const panel = document.getElementById(panelId);
        if (panel) {
          panel.classList.remove('hidden');
        }
      }
      
      // Ê†πÊçÆËèúÂçïÂä†ËΩΩÁõ∏Â∫îÊï∞ÊçÆ
      if (menu === 'manage') {
        loadDigitalHumans();
      } else if (menu === 'works') {
        loadWorks();
      } else if (menu === 'recite') {
        loadRecitePanel();
      } else if (menu === 'promote') {
        loadPromotePanel();
      }
    }
    
    // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºàÁ°Æ‰øùonclickÂèØ‰ª•ËÆøÈóÆÔºâ
    window.switchMenu = switchMenu;
    
    // ÂàùÂßãÂåñ
    function init() {
      loadConfigs();
      loadHistory();
      loadDigitalHumans();
      loadWorks();
      updateStepIndicator(1);
      
      // Ëá™Âä®Âä†ËΩΩ avatar Ê®°ÊùøÔºàÂ¶ÇÊûú API Key Â∑≤ÈÖçÁΩÆÔºâ
      const apiKey = getHeyGenApiKey();
      if (apiKey) {
        setTimeout(() => {
          loadHeyGenAvatars('create');
        }, 500);
      }
      
      // Âú®Ê≠•È™§1‰∏≠ÊòæÁ§∫APIÈÖçÁΩÆ
      document.querySelectorAll('.api-config').forEach(config => {
        config.classList.add('hidden');
      });
      const configEl = document.getElementById(currentPlatform + 'Config');
      if (configEl) {
        configEl.classList.remove('hidden');
      }
    }
    
    // ========== Ê≠•È™§ÁÆ°ÁêÜ ==========
    
    function goToStep(step) {
      // È™åËØÅÂΩìÂâçÊ≠•È™§
      if (step > currentStep && !validateCurrentStep()) {
        return;
      }
      
      currentStep = step;
      updateStepIndicator(step);
      
      // ÈöêËóèÊâÄÊúâÊ≠•È™§ÂÜÖÂÆπ
      document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // ÊòæÁ§∫ÂØπÂ∫îÊ≠•È™§
      document.getElementById(`step${step}Content`).classList.add('active');
      
      // Âú®Ê≠•È™§1‰∏≠ÊòæÁ§∫ÂΩìÂâçÂπ≥Âè∞ÁöÑAPIÈÖçÁΩÆ
      if (step === 1) {
        document.querySelectorAll('.api-config').forEach(config => {
          config.classList.add('hidden');
        });
        const configEl = document.getElementById(currentPlatform + 'Config');
        if (configEl) {
          configEl.classList.remove('hidden');
        }
      }
      
      // Âú®Ê≠•È™§3‰∏≠ÊòæÁ§∫ËßÜÈ¢ëÈ¢ÑËßà
      if (step === 3) {
        updateStep3VideoPreview();
      }
      
      // ÊªöÂä®Âà∞È°∂ÈÉ®
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function updateStepIndicator(step) {
      document.querySelectorAll('.step-item').forEach((item, index) => {
        const stepNum = index + 1;
        item.classList.remove('active', 'completed');
        
        if (stepNum < step) {
          item.classList.add('completed');
        } else if (stepNum === step) {
          item.classList.add('active');
        }
      });
      
      document.querySelectorAll('.step-line').forEach((line, index) => {
        if (index + 1 < step) {
          line.classList.add('completed');
        } else {
          line.classList.remove('completed');
        }
      });
    }
    
    // Ëé∑Âèñ HeyGen API Key ÁöÑËæÖÂä©ÂáΩÊï∞
    function getHeyGenApiKey() {
      // ‰ºòÂÖà‰ªéËæìÂÖ•Ê°ÜËØªÂèñ
      const inputEl = document.getElementById('heygenApiKey');
      if (inputEl) {
        const inputValue = inputEl.value.trim();
        if (inputValue && inputValue.length > 10) {
          return inputValue;
        }
      }
      
      // ‰ªé localStorage ËØªÂèñ
      try {
        const apiKey = localStorage.getItem('intl_heygen_api_key');
        if (apiKey && apiKey.trim().length > 10) {
          return apiKey.trim();
        }
      } catch (e) {
        console.warn('Cannot read from localStorage:', e);
      }
      
      return null;
    }
    
    function validateCurrentStep() {
      if (currentStep === 1) {
        // È™åËØÅ HeyGen API ÈÖçÁΩÆ
        const apiKey = getHeyGenApiKey();
        if (!apiKey) {
          alert('Please configure and test API connection first\n\nTip: Please fill in HeyGen API Key and click "Save Configuration" button.');
          return false;
        }
      } else if (currentStep === 2) {
        // È™åËØÅÂøÖÈ°ªÂêåÊó∂ÊúâËßÜÈ¢ëÂíåËØ≠Èü≥ËµÑÊ∫ê
        if (currentAvatarMode === 'template') {
          // Ê®°ÊùøÊ®°ÂºèÔºöÈúÄË¶ÅÈÄâÊã©Ê®°ÊùøÔºàËßÜÈ¢ëÔºâÂíåËØ≠Èü≥
          if (!selectedAvatarId) {
            alert('Please select a digital human template first');
            return false;
          }
          // ËØ≠Èü≥ÊòØÂèØÈÄâÁöÑÔºå‰ΩÜÂª∫ËÆÆÈÄâÊã©
          // ‰∏çÂº∫Âà∂Ë¶ÅÊ±ÇÈÄâÊã©ËØ≠Èü≥ÔºåÂõ†‰∏∫Á≥ªÁªüÂèØ‰ª•Ëá™Âä®ÈÄâÊã©
        } else if (currentAvatarMode === 'upload') {
          // ‰∏ä‰º†Ê®°ÂºèÔºöÈúÄË¶ÅÂêåÊó∂‰∏ä‰º†ËßÜÈ¢ëÂíåÈü≥È¢ë
          if (!selectedVideoFile) {
            alert('Please upload video file first');
            return false;
          }
          if (!selectedAudioFile) {
            alert('Please upload audio file first\n\nTip: When uploading reference files, you need to upload both video and audio.');
            return false;
          }
        } else if (currentAvatarMode === 'record') {
          // ÂΩïÂà∂Ê®°ÂºèÔºöÈúÄË¶ÅÂêåÊó∂ÂΩïÂà∂ËßÜÈ¢ëÂíåÈü≥È¢ë
          if (!recordedVideoBlob) {
            alert('Please record video first');
            return false;
          }
          if (!recordedAudioBlob) {
            alert('Please record audio first\n\nTip: When recording in real-time, you need to record both video and audio.');
            return false;
          }
        } else {
          // Êú™ÈÄâÊã©‰ªª‰ΩïÊ®°Âºè
          alert('Please select an avatar selection method (template, upload, or record)');
          return false;
        }
      } else if (currentStep === 3) {
        // È™åËØÅÊòØÂê¶ËæìÂÖ•‰∫ÜÊñáÊ°àÂíåÂêçÁß∞
        const script = document.getElementById('scriptInput').value.trim();
        if (!script) {
          alert('Please enter script content');
          return false;
        }
        const name = document.getElementById('digitalHumanName').value.trim();
        if (!name) {
          alert('Please enter digital human name');
          return false;
        }
      }
      return true;
    }
    
    // ========== ÂΩ¢Ë±°ÈÄâÊã©ÊñπÂºèÂàáÊç¢ ==========
    function switchAvatarMode(mode) {
      console.log('Switch avatar selection mode:', mode);
      
      currentAvatarMode = mode; // ‰øùÂ≠òÂΩìÂâçÊ®°Âºè
      
      const templateBtn = document.getElementById('avatarModeTemplate');
      const uploadBtn = document.getElementById('avatarModeUpload');
      const recordBtn = document.getElementById('avatarModeRecord');
      const templateSection = document.getElementById('templateSelectionSection');
      const uploadSection = document.getElementById('uploadReferenceSection');
      const recordSection = document.getElementById('recordSection');
      const voiceSelectionSection = document.getElementById('voiceSelectionSection');
      
      // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
      if (templateBtn && uploadBtn && recordBtn) {
        templateBtn.classList.remove('active');
        uploadBtn.classList.remove('active');
        recordBtn.classList.remove('active');
        
        if (mode === 'template') {
          templateBtn.classList.add('active');
          if (templateSection) templateSection.style.display = 'block';
          if (uploadSection) uploadSection.style.display = 'none';
          if (recordSection) recordSection.style.display = 'none';
          // ÊòæÁ§∫ËØ≠Èü≥ÈÄâÊã©ÔºàÊ®°ÊùøÊ®°ÂºèÈúÄË¶ÅTTSËØ≠Èü≥Ôºâ
          if (voiceSelectionSection) voiceSelectionSection.style.display = 'block';
          
          // Ê∏ÖÈô§‰∏ä‰º†ÁöÑÊñá‰ª∂ÂíåÂΩïÂà∂ÁöÑÂÜÖÂÆπ
          clearUploadedFiles();
          clearRecordedFiles();
        } else if (mode === 'upload') {
          uploadBtn.classList.add('active');
          if (templateSection) templateSection.style.display = 'none';
          if (uploadSection) uploadSection.style.display = 'block';
          if (recordSection) recordSection.style.display = 'none';
          // ÈöêËóèËØ≠Èü≥ÈÄâÊã©Ôºà‰∏ä‰º†Ê®°ÂºèÂ∑≤ÊúâÈü≥È¢ëÊñá‰ª∂Ôºâ
          if (voiceSelectionSection) voiceSelectionSection.style.display = 'none';
          
          // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©ÂíåÂΩïÂà∂ÁöÑÂÜÖÂÆπ
          clearTemplateSelection();
          clearRecordedFiles();
        } else if (mode === 'record') {
          recordBtn.classList.add('active');
          if (templateSection) templateSection.style.display = 'none';
          if (uploadSection) uploadSection.style.display = 'none';
          if (recordSection) recordSection.style.display = 'block';
          // ÈöêËóèËØ≠Èü≥ÈÄâÊã©ÔºàÂΩïÂà∂Ê®°ÂºèÂ∑≤ÊúâÈü≥È¢ëÊñá‰ª∂Ôºâ
          if (voiceSelectionSection) voiceSelectionSection.style.display = 'none';
          
          // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©Âíå‰∏ä‰º†ÁöÑÊñá‰ª∂
          clearTemplateSelection();
          clearUploadedFiles();
        }
      }
    }
    
    // Ê∏ÖÈô§ÂΩïÂà∂ÁöÑÊñá‰ª∂
    function clearRecordedFiles() {
      recordedVideoBlob = null;
      recordedAudioBlob = null;
      currentVideoUrl = null;
      
      // Ê∏ÖÈô§ÂΩïÂà∂È¢ÑËßà
      const videoRecordPreview = document.getElementById('videoRecordPreview');
      const audioRecordPreview = document.getElementById('audioRecordPreview');
      const recordedVideo = document.getElementById('recordedVideo');
      const recordedAudio = document.getElementById('recordedAudio');
      const recordStatus = document.getElementById('recordStatus');
      
      if (videoRecordPreview) {
        videoRecordPreview.style.display = 'none';
        videoRecordPreview.style.border = '';
        videoRecordPreview.style.background = '';
      }
      if (audioRecordPreview) {
        audioRecordPreview.style.display = 'none';
        audioRecordPreview.style.border = '';
        audioRecordPreview.style.background = '';
      }
      if (recordedVideo && recordedVideo.src) {
        URL.revokeObjectURL(recordedVideo.src);
        recordedVideo.src = '';
      }
      if (recordedAudio && recordedAudio.src) {
        URL.revokeObjectURL(recordedAudio.src);
        recordedAudio.src = '';
      }
      if (recordStatus) recordStatus.style.display = 'none';
      
      // ÂÅúÊ≠¢ÂΩïÂà∂ÔºàÂ¶ÇÊûúÊ≠£Âú®ÂΩïÂà∂Ôºâ
      if (isRecordingVideo) {
        stopVideoRecording();
      }
      if (isRecordingAudio) {
        stopAudioRecording();
      }
      
      console.log('Cleared recorded files');
    }
    
    // Ê∏ÖÈô§‰∏ä‰º†ÁöÑÊñá‰ª∂
    function clearUploadedFiles() {
      selectedVideoFile = null;
      selectedVideoUrl = null;
      selectedAudioFile = null;
      
      // Ê∏ÖÈô§È¢ÑËßà
      const videoPreview = document.getElementById('videoPreviewSection');
      const audioPreview = document.getElementById('audioPreviewSection');
      
      if (videoPreview) {
        videoPreview.style.display = 'none';
        videoPreview.style.border = '';
        videoPreview.style.background = '';
      }
      if (audioPreview) {
        audioPreview.style.display = 'none';
        audioPreview.style.border = '';
        audioPreview.style.background = '';
      }
      
      // Ê∏ÖÈô§Êñá‰ª∂ËæìÂÖ•
      const uploadFileInput = document.getElementById('uploadFile');
      const uploadAudioInput = document.getElementById('uploadAudioFile');
      if (uploadFileInput) uploadFileInput.value = '';
      if (uploadAudioInput) uploadAudioInput.value = '';
      
      // Ê∏ÖÈô§ËßÜÈ¢ëÈ¢ÑËßàÂÖÉÁ¥†
      const uploadedVideoPreview = document.getElementById('uploadedVideoPreview');
      const uploadedAudioPreview = document.getElementById('uploadedAudioPreview');
      if (uploadedVideoPreview && uploadedVideoPreview.src) {
        URL.revokeObjectURL(uploadedVideoPreview.src);
        uploadedVideoPreview.src = '';
      }
      if (uploadedAudioPreview && uploadedAudioPreview.src) {
        URL.revokeObjectURL(uploadedAudioPreview.src);
        uploadedAudioPreview.src = '';
      }
      
      console.log('Cleared uploaded files');
    }
    
    // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©
    function clearTemplateSelection() {
      selectedAvatarId = null;
      selectedTemplatePreviewVideo = null;
      selectedTemplatePreviewImage = null;
      selectedTemplateName = null;
      
      // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©Áä∂ÊÄÅ
      document.querySelectorAll('.avatar-template-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // ÈöêËóèÊ®°ÊùøÈ¢ÑËßà
      hideTemplatePreview();
      
      console.log('Cleared template selection');
    }
    
    // ========== Ê†áÁ≠æÂàáÊç¢ ==========
    function switchTab(tab) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.currentTarget.classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('uploadArea').classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleVideoFile(files[0]);
      }
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('uploadArea').classList.add('dragover');
    }
    
    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('uploadArea').classList.remove('dragover');
    }
    
    function handleVideoFileUpload(input) {
      if (input.files.length > 0) {
        handleVideoFile(input.files[0]);
      }
    }
    
    function handleVideoFile(file) {
      if (!file.type.startsWith('video/')) {
        alert('Please select video file');
        return;
      }
      
      // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂100MBÔºâ
      if (file.size > 100 * 1024 * 1024) {
        alert('Video file size cannot exceed 100MB');
        return;
      }
      
      // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©ÂíåÂΩïÂà∂ÁöÑÂÜÖÂÆπÔºà‰∫íÊñ•ÈÄªËæëÔºâ
      clearTemplateSelection();
      clearRecordedFiles();
      
      selectedVideoFile = file;
      const url = URL.createObjectURL(file);
      selectedVideoUrl = url;
      
      // ÊòæÁ§∫ËßÜÈ¢ëÈ¢ÑËßà
      const previewSection = document.getElementById('videoPreviewSection');
      const videoPreview = document.getElementById('uploadedVideoPreview');
      const fileName = document.getElementById('videoFileName');
      
      videoPreview.src = url;
      fileName.textContent = file.name;
      previewSection.style.display = 'block';
      
      // Ëé∑ÂèñËßÜÈ¢ëÊó∂Èïø
      videoPreview.onloadedmetadata = () => {
        const duration = videoPreview.duration;
        const minutes = Math.floor(duration / 60);
        const seconds = Math.floor(duration % 60);
        document.getElementById('videoDuration').textContent = `${minutes}:${String(seconds).padStart(2, '0')}`;
      };
      
      // Ëá™Âä®ÊèêÂèñÂÖ≥ÈîÆÂ∏ß
      setTimeout(() => {
        extractVideoFrame();
      }, 500);
    }
    
    // ========== Èü≥È¢ëÊñá‰ª∂‰∏ä‰º†Â§ÑÁêÜ ==========
    
    function handleAudioDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('uploadAudioArea').classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleAudioFile(files[0]);
      }
    }
    
    function handleAudioFileUpload(input) {
      if (input.files && input.files.length > 0) {
        handleAudioFile(input.files[0]);
      }
    }
    
    function handleAudioFile(file) {
      if (!file.type.startsWith('audio/')) {
        alert('Please select audio file');
        return;
      }
      
      // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©ÂíåÂΩïÂà∂ÁöÑÂÜÖÂÆπÔºà‰∫íÊñ•ÈÄªËæëÔºâ
      clearTemplateSelection();
      clearRecordedFiles();
      
      selectedAudioFile = file;
      
      const audioPreview = document.getElementById('uploadedAudioPreview');
      const fileName = document.getElementById('audioFileName');
      const fileSize = document.getElementById('audioFileSize');
      const previewSection = document.getElementById('audioPreviewSection');
      
      if (audioPreview && fileName && fileSize) {
        const url = URL.createObjectURL(file);
        audioPreview.src = url;
        fileName.textContent = file.name;
        fileSize.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        previewSection.style.display = 'block';
      }
    }
    
    function removeUploadedAudio() {
      selectedAudioFile = null;
      const audioPreview = document.getElementById('uploadedAudioPreview');
      const fileName = document.getElementById('audioFileName');
      const fileSize = document.getElementById('audioFileSize');
      const previewSection = document.getElementById('audioPreviewSection');
      
      if (audioPreview && audioPreview.src) {
        URL.revokeObjectURL(audioPreview.src);
        audioPreview.src = '';
      }
      if (fileName) fileName.textContent = '-';
      if (fileSize) fileSize.textContent = '-';
      if (previewSection) previewSection.style.display = 'none';
    }
    
    function removeUploadedVideo() {
      if (selectedVideoUrl) {
        URL.revokeObjectURL(selectedVideoUrl);
      }
      
      selectedVideoFile = null;
      selectedVideoUrl = null;
      extractedFrames = [];
      
      // ÂÆâÂÖ®Âú∞ËÆøÈóÆÂÖÉÁ¥†ÔºåÊ∑ªÂä†Á©∫ÂÄºÊ£ÄÊü•
      const videoPreviewSection = document.getElementById('videoPreviewSection');
      if (videoPreviewSection) {
        videoPreviewSection.style.display = 'none';
      }
      
      const framePreviewSection = document.getElementById('framePreviewSection');
      if (framePreviewSection) {
        framePreviewSection.style.display = 'none';
      }
      
      const uploadedVideoPreview = document.getElementById('uploadedVideoPreview');
      if (uploadedVideoPreview) {
        uploadedVideoPreview.src = '';
      }
      
      const frameGrid = document.getElementById('frameGrid');
      if (frameGrid) {
        frameGrid.innerHTML = '';
      }
    }
    
    // ÊèêÂèñËßÜÈ¢ëÂÖ≥ÈîÆÂ∏ß
    function extractVideoFrame() {
      const video = document.getElementById('uploadedVideoPreview');
      if (!video || !selectedVideoUrl) {
        alert('Please upload video first');
        return;
      }
      
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      extractedFrames = [];
      const frameGrid = document.getElementById('frameGrid');
        frameGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--text-secondary);">Extracting key frames...</div>';
      
      // Á≠âÂæÖËßÜÈ¢ëÂÖÉÊï∞ÊçÆÂä†ËΩΩ
      if (!video.videoWidth || !video.videoHeight) {
        video.onloadedmetadata = () => {
          extractFramesFromVideo(video, canvas, ctx);
        };
      } else {
        extractFramesFromVideo(video, canvas, ctx);
      }
    }
    
    function extractFramesFromVideo(video, canvas, ctx) {
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      
      // ÊèêÂèñÂ§ö‰∏™ÂÖ≥ÈîÆÂ∏ßÔºàËßÜÈ¢ëÂºÄÂßã„ÄÅ1/4„ÄÅ1/2„ÄÅ3/4„ÄÅÁªìÊùüÔºâ
      const frameTimes = [];
      const duration = video.duration || 10;
      
      frameTimes.push(0);
      if (duration > 2) frameTimes.push(duration * 0.25);
      if (duration > 4) frameTimes.push(duration * 0.5);
      if (duration > 6) frameTimes.push(duration * 0.75);
      if (duration > 1) frameTimes.push(Math.max(0, duration - 0.5));
      
      let extractedCount = 0;
      const totalFrames = frameTimes.length;
      
      frameTimes.forEach((time, index) => {
        const originalTime = video.currentTime;
        video.currentTime = time;
        
        const seekHandler = () => {
          try {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frameDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            
            extractedFrames.push({
              id: Date.now() + index,
              time: time,
              dataUrl: frameDataUrl
            });
            
            extractedCount++;
            if (extractedCount === totalFrames) {
              video.removeEventListener('seeked', seekHandler);
              renderFrames();
              video.currentTime = originalTime;
            }
          } catch (e) {
            console.error('Failed to extract frame:', e);
            extractedCount++;
            if (extractedCount === totalFrames) {
              video.removeEventListener('seeked', seekHandler);
              renderFrames();
            }
          }
        };
        
        video.addEventListener('seeked', seekHandler, { once: true });
      });
    }
    
    function renderFrames() {
      const frameGrid = document.getElementById('frameGrid');
      const frameSection = document.getElementById('framePreviewSection');
      
      if (extractedFrames.length === 0) {
        frameGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--text-secondary);">Failed to extract key frames</div>';
        return;
      }
      
      frameGrid.innerHTML = extractedFrames.map((frame, index) => `
        <div class="material-item ${index === 0 ? 'selected' : ''}" onclick="selectFrame(${frame.id}, this)">
          <img class="material-preview" src="${frame.dataUrl}" style="object-fit: cover;">
          <div class="material-info">
            <div class="material-name">Frame ${index + 1}</div>
          </div>
        </div>
      `).join('');
      
      frameSection.style.display = 'block';
    }
    
    function selectFrame(id, element) {
      selectedFrameId = id;
      document.querySelectorAll('#frameGrid .material-item').forEach(item => {
        item.classList.remove('selected');
      });
      if (element) element.classList.add('selected');
    }
    
    function confirmVideoSelection() {
      if (!selectedVideoFile) {
        alert('Please upload video first');
        return;
      }
      
      // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©Ôºà‰∫íÊñ•ÈÄªËæëÔºâ
      clearTemplateSelection();
      
      // Ê†áËÆ∞Â∑≤ÈÄâÊã©ËßÜÈ¢ë
      const previewSection = document.getElementById('videoPreviewSection');
      previewSection.style.border = '2px solid var(--success)';
      previewSection.style.background = 'rgba(82, 196, 26, 0.1)';
      
      alert('‚úÖ Video confirmed!\n\nYou can proceed to the next step to configure generation parameters.');
    }
    
    // Á°ÆËÆ§ËßÜÈ¢ëÂíåÈü≥È¢ëÈÄâÊã©Ôºà‰∏ä‰º†Ê®°ÂºèÔºâ
    function confirmVideoAndAudioSelection() {
      if (!selectedVideoFile) {
        alert('‚ùå Please upload video file first');
        return;
      }
      
      if (!selectedAudioFile) {
        alert('‚ùå Please upload audio file first\n\nWhen uploading reference files, you need to provide both video and audio.');
        return;
      }
      
      // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©ÂíåÂΩïÂà∂ÁöÑÂÜÖÂÆπÔºà‰∫íÊñ•ÈÄªËæëÔºâ
      clearTemplateSelection();
      clearRecordedFiles();
      
      // Ê†áËÆ∞Â∑≤ÈÄâÊã©ËßÜÈ¢ëÂíåÈü≥È¢ë
      const videoPreviewSection = document.getElementById('videoPreviewSection');
      const audioPreviewSection = document.getElementById('audioPreviewSection');
      
      if (videoPreviewSection) {
        videoPreviewSection.style.border = '2px solid var(--success)';
        videoPreviewSection.style.background = 'rgba(82, 196, 26, 0.1)';
      }
      
      if (audioPreviewSection) {
        audioPreviewSection.style.border = '2px solid var(--success)';
        audioPreviewSection.style.background = 'rgba(82, 196, 26, 0.1)';
      }
      
      alert('‚úÖ Video and audio confirmed!\n\nYou can proceed to the next step to configure generation parameters.');
    }
    
    // Á°ÆËÆ§ÂΩïÂà∂ÁöÑËßÜÈ¢ëÂíåÈü≥È¢ë
    function confirmRecordedVideoAndAudio() {
      if (!recordedVideoBlob) {
        alert('‚ùå Please record video first');
        return;
      }
      
      if (!recordedAudioBlob) {
        alert('‚ùå Please record audio first\n\nWhen recording in real-time, you need to record both video and audio.');
        return;
      }
      
      // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©Âíå‰∏ä‰º†ÁöÑÊñá‰ª∂Ôºà‰∫íÊñ•ÈÄªËæëÔºâ
      clearTemplateSelection();
      clearUploadedFiles();
      
      // Ê†áËÆ∞Â∑≤ÈÄâÊã©ÂΩïÂà∂ÁöÑËßÜÈ¢ëÂíåÈü≥È¢ë
      const videoRecordPreview = document.getElementById('videoRecordPreview');
      const audioRecordPreview = document.getElementById('audioRecordPreview');
      
      if (videoRecordPreview) {
        videoRecordPreview.style.border = '2px solid var(--success)';
        videoRecordPreview.style.background = 'rgba(82, 196, 26, 0.1)';
      }
      
      if (audioRecordPreview) {
        audioRecordPreview.style.border = '2px solid var(--success)';
        audioRecordPreview.style.background = 'rgba(82, 196, 26, 0.1)';
      }
      
      alert('‚úÖ Recorded video and audio confirmed!\n\nYou can proceed to the next step to configure generation parameters.');
    }
    
    // Êõ¥Êñ∞Ê≠•È™§3ÁöÑËßÜÈ¢ëÈ¢ÑËßà
    function updateStep3VideoPreview() {
      const displayEl = document.getElementById('step3VideoDisplay');
      if (!displayEl) return;
      
      // Ê®°ÊùøÊ®°ÂºèÔºöÂ∑≤ÈÄâÊã©Ê®°ÊùøÊó∂ÔºåÂ±ïÁ§∫Ê®°ÊùøÈ¢ÑËßàÔºàËßÜÈ¢ëÊàñÂõæÁâáÔºâ
      if (currentAvatarMode === 'template' && selectedAvatarId) {
        const name = selectedTemplateName || 'Selected Template';
        if (selectedTemplatePreviewVideo) {
          displayEl.innerHTML = `
            <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; align-items: center;">
              <div>
                <video src="${selectedTemplatePreviewVideo}" style="width: 100%; border-radius: 12px; border: 2px solid var(--primary);" muted autoplay loop playsinline></video>
              </div>
              <div style="text-align: left;">
                <div style="font-weight: 600; margin-bottom: 8px;">${name}</div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);">Template ID: ${selectedAvatarId}</div>
                <button class="btn secondary" style="margin-top: 12px; padding: 8px 16px; font-size: 0.85rem;" onclick="goToStep(2)">Go Back to Edit</button>
              </div>
            </div>
          `;
        } else if (selectedTemplatePreviewImage) {
          displayEl.innerHTML = `
            <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; align-items: center;">
              <div>
                <img src="${selectedTemplatePreviewImage}" style="width: 100%; border-radius: 12px; border: 2px solid var(--primary); object-fit: contain;" alt="${name}">
              </div>
              <div style="text-align: left;">
                <div style="font-weight: 600; margin-bottom: 8px;">${name}</div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);">Template ID: ${selectedAvatarId}</div>
                <button class="btn secondary" style="margin-top: 12px; padding: 8px 16px; font-size: 0.85rem;" onclick="goToStep(2)">Go Back to Edit</button>
              </div>
            </div>
          `;
        } else {
          displayEl.innerHTML = `
            <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; align-items: center;">
              <div style="width: 200px; height: 120px; background: var(--bg-secondary); border-radius: 12px; border: 2px solid var(--primary); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 2.5rem;">üìπ</div>
              <div style="text-align: left;">
                <div style="font-weight: 600; margin-bottom: 8px;">${name}</div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);">Template ID: ${selectedAvatarId} (This template has no preview yet)</div>
                <button class="btn secondary" style="margin-top: 12px; padding: 8px 16px; font-size: 0.85rem;" onclick="goToStep(2)">ËøîÂõû‰øÆÊîπ</button>
              </div>
            </div>
          `;
        }
        return;
      }
      
      if (selectedVideoUrl) {
        const selectedFrame = extractedFrames.find(f => f.id === selectedFrameId) || extractedFrames[0];
        
        displayEl.innerHTML = `
          <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; align-items: center;">
            <div>
              ${selectedFrame ? 
                `<img src="${selectedFrame.dataUrl}" style="width: 100%; border-radius: 12px; border: 2px solid var(--primary);">` :
                `<video src="${selectedVideoUrl}" style="width: 100%; border-radius: 12px; border: 2px solid var(--primary);" muted autoplay loop></video>`
              }
            </div>
            <div style="text-align: left;">
              <div style="font-weight: 600; margin-bottom: 8px;">${selectedVideoFile ? selectedVideoFile.name : 'Recorded Video'}</div>
              <div style="font-size: 0.9rem; color: var(--text-secondary);">
                ${selectedVideoFile ? `File Size: ${(selectedVideoFile.size / 1024 / 1024).toFixed(2)} MB` : ''}
              </div>
              <button class="btn secondary" style="margin-top: 12px; padding: 8px 16px; font-size: 0.85rem;" onclick="goToStep(2)">Go Back to Edit</button>
            </div>
          </div>
        `;
      } else if (recordedVideoBlob) {
        displayEl.innerHTML = `
          <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; align-items: center;">
            <div>
              <video src="${currentVideoUrl}" style="width: 100%; border-radius: 12px; border: 2px solid var(--primary);" muted autoplay loop></video>
            </div>
            <div style="text-align: left;">
              <div style="font-weight: 600; margin-bottom: 8px;">Real-time Recorded Video</div>
              <div style="font-size: 0.9rem; color: var(--text-secondary);">
                Recording Completed
              </div>
              <button class="btn secondary" style="margin-top: 12px; padding: 8px 16px; font-size: 0.85rem;" onclick="goToStep(2)">Go Back to Edit</button>
            </div>
          </div>
        `;
      } else {
        displayEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">Please go back to the previous step to select video avatar</div>';
      }
    }
    
    // ========== ÂàÜÈ°µÊéßÂà∂ ==========
    function changePage(direction) {
      console.log('Switch page:', direction);
      const totalPages = Math.ceil(totalAvatars / pageSize);
      const newPage = currentPage + direction;
      
      if (newPage < 1 || newPage > totalPages) {
        console.log('Page number out of range:', newPage);
        return;
      }
      
      currentPage = newPage;
      displayedAvatars = 0; // ÈáçÁΩÆ‰∏∫ÂàÜÈ°µÊ®°Âºè
      renderAvatars();
      updatePaginationControls();
    }
    
    function updatePaginationControls() {
      const totalPages = Math.ceil(totalAvatars / pageSize);
      const paginationContainer = document.getElementById('paginationContainer');
      const pageInfo = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');
      
      if (totalPages > 1) {
        paginationContainer.style.display = 'flex';
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
      } else {
        paginationContainer.style.display = 'none';
      }
    }
    
    // ========== Âä†ËΩΩÊõ¥Â§öÊ®°Êùø ==========
    function loadMoreAvatars(context) {
      console.log('Load more templates, context:', context, 'Currently displayed:', displayedAvatars, 'Total:', totalAvatars);
      
      if (displayedAvatars >= totalAvatars) {
        console.log('All templates displayed');
        return;
      }
      
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      const loadMoreText = document.getElementById('loadMoreText');
      const loadMoreIcon = document.getElementById('loadMoreIcon');
      
      if (!loadMoreBtn) {
        console.error('Cannot find load more button');
        return;
      }
      
      loadMoreBtn.disabled = true;
      if (loadMoreText) loadMoreText.textContent = 'Loading...';
      if (loadMoreIcon) loadMoreIcon.textContent = '‚è≥';
      
      // Â¢ûÂä†ÊòæÁ§∫Êï∞Èáè
      displayedAvatars = Math.min(displayedAvatars + pageSize, totalAvatars);
      renderAvatars();
      
      // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
      setTimeout(() => {
        loadMoreBtn.disabled = false;
        if (loadMoreText) loadMoreText.textContent = 'Load More Templates';
        if (loadMoreIcon) loadMoreIcon.textContent = '‚¨áÔ∏è';
        
        // Â¶ÇÊûúÂ∑≤ÊòæÁ§∫ÂÖ®ÈÉ®ÔºåÈöêËóèÂä†ËΩΩÊõ¥Â§öÊåâÈíÆ
        if (displayedAvatars >= totalAvatars) {
          const loadMoreContainer = document.getElementById('loadMoreContainer');
          if (loadMoreContainer) loadMoreContainer.style.display = 'none';
        }
      }, 500);
    }
    
    // ========== Ê∏≤ÊüìÊ®°ÊùøÂàóË°® ==========
    function renderAvatars() {
      console.log('Render template list, current page:', currentPage, 'Display count:', displayedAvatars);
      
      if (!heygenAvatarsCache || !Array.isArray(heygenAvatarsCache)) {
        console.warn('No cached avatar list or incorrect format');
        return;
      }
      
      const container = document.getElementById('avatarTemplateGrid');
      if (!container) {
        console.error('Cannot find avatarTemplateGrid container');
        return;
      }
      
      // ËøáÊª§ËßÜÈ¢ëÁ±ªÂûãÁöÑavatar
      const filteredAvatars = heygenAvatarsCache.filter(avatar => {
        return avatar.type === 'video' || avatar.avatar_type === 'video' || !avatar.type;
      });
      
      totalAvatars = filteredAvatars.length;
      console.log('Filtered template count:', totalAvatars);
      
      // ËÆ°ÁÆóÂΩìÂâçÈ°µË¶ÅÊòæÁ§∫ÁöÑËåÉÂõ¥ÔºàÂàÜÈ°µÊ®°ÂºèÔºâ
      let avatarsToShow;
      if (displayedAvatars > 0 && displayedAvatars < totalAvatars) {
        // ‰∏ãÊãâÂä†ËΩΩÊ®°ÂºèÔºöÊòæÁ§∫‰ªé0Âà∞displayedAvatars
        avatarsToShow = filteredAvatars.slice(0, displayedAvatars);
      } else {
        // ÂàÜÈ°µÊ®°ÂºèÔºöÊòæÁ§∫ÂΩìÂâçÈ°µÁöÑÊï∞ÊçÆ
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalAvatars);
        avatarsToShow = filteredAvatars.slice(startIndex, endIndex);
      }
      
      console.log('Number of templates to display:', avatarsToShow.length);
      
      // Ê∏ÖÁ©∫ÂÆπÂô®Ôºà‰øùÁïôÂä†ËΩΩÁä∂ÊÄÅÔºâ
      const loadingState = document.getElementById('avatarLoadingState');
      container.innerHTML = '';
      if (loadingState) {
        container.appendChild(loadingState);
      }
      
      // Ê∏≤ÊüìÊ®°Êùø
      avatarsToShow.forEach((avatar, index) => {
        const avatarId = avatar.avatar_id || avatar.id || avatar;
        const avatarName = avatar.avatar_name || avatar.name || `Avatar ${index + 1}`;
        const previewImage = avatar.preview_image_url || avatar.preview_url || '';
        const gender = avatar.gender || 'unknown';
        const genderIcon = gender === 'female' ? 'üë©' : gender === 'male' ? 'üë®' : 'üë§';
        
        const avatarItem = document.createElement('div');
        avatarItem.className = 'avatar-template-item';
        avatarItem.setAttribute('data-avatar-id', avatarId);
        // ‰øùÂ≠òÂÆåÊï¥ÁöÑavatarÊï∞ÊçÆ‰ª•‰æøÈ¢ÑËßà
        avatarItem.setAttribute('data-avatar-data', JSON.stringify(avatar));
        avatarItem.style.cssText = 'background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 12px; padding: 12px; cursor: pointer; transition: all 0.3s; text-align: center;';
        avatarItem.onclick = () => {
          console.log('Select template:', avatarId);
          selectAvatarTemplate(avatarId, 'create', avatar);
        };
        
        if (previewImage) {
          avatarItem.innerHTML = `
            <img src="${previewImage}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="font-size: 2.5rem; margin-bottom: 8px; display: none;">${genderIcon}</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${avatarName}">
              ${avatarName}
            </div>
          `;
        } else {
          avatarItem.innerHTML = `
            <div style="font-size: 2.5rem; margin-bottom: 8px;">${genderIcon}</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${avatarName}">
              ${avatarName}
            </div>
          `;
        }
        
        container.appendChild(avatarItem);
      });
      
      // Ê∑ªÂä†Ê†∑ÂºèÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÔºâ
      if (!document.getElementById('avatarTemplateStyles')) {
        const style = document.createElement('style');
        style.id = 'avatarTemplateStyles';
        style.textContent = `
          .avatar-template-item:hover {
            border-color: var(--primary) !important;
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(24, 144, 255, 0.2);
          }
          .avatar-template-item.selected {
            border-color: var(--primary) !important;
            background: rgba(24, 144, 255, 0.1) !important;
            box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.2);
          }
          .digital-human-type-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.15);
          }
        `;
        document.head.appendChild(style);
      }
      
      // Êõ¥Êñ∞Âä†ËΩΩÊõ¥Â§öÊåâÈíÆÂíåÂàÜÈ°µÊéßÂà∂
      const loadMoreContainer = document.getElementById('loadMoreContainer');
      const paginationContainer = document.getElementById('paginationContainer');
      if (displayedAvatars > 0 && displayedAvatars < totalAvatars) {
        // ‰∏ãÊãâÂä†ËΩΩÊ®°Âºè
        if (loadMoreContainer) loadMoreContainer.style.display = 'block';
        if (paginationContainer) paginationContainer.style.display = 'none';
      } else {
        // ÂàÜÈ°µÊ®°Âºè
        if (loadMoreContainer) loadMoreContainer.style.display = 'none';
        updatePaginationControls();
      }
      
      // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
      if (loadingState) {
        loadingState.style.display = 'none';
      }
    }
    
    // ========== ÂàõÂª∫Êï∞Â≠ó‰∫∫Ôºà‰øÆÊîπÁâàÔºâ ==========
    
    async function createDigitalHuman() {
      const name = document.getElementById('digitalHumanName').value.trim();
      const desc = document.getElementById('digitalHumanDesc').value.trim();
      const script = document.getElementById('scriptInput').value.trim();
      
      if (!name) {
        alert('Please enter digital human name');
        return;
      }
      
      // HeyGen Âπ≥Âè∞ÁâπÊÆäÂ§ÑÁêÜÔºàÂêéÂè∞ÂàõÂª∫Ôºâ
      if (currentPlatform === 'heygen') {
        await createHeyGenDigitalHuman(name, desc, script);
        return;
      }
      
      alert('Currently only HeyGen platform is supported');
    }
    
    // HeyGen Êï∞Â≠ó‰∫∫ÂàõÂª∫ÔºàÂêéÂè∞Â§ÑÁêÜÔºåÊîØÊåÅÂõæÁâáÂíåËßÜÈ¢ëÊï∞Â≠ó‰∫∫Ôºâ
    async function createHeyGenDigitalHuman(name, desc, script) {
      const apiKey = getHeyGenApiKey();
      
      if (!apiKey) {
        alert('Please configure HeyGen API Key first\n\nTip: Please return to Step 1, fill in the correct API Key and click "Save Configuration".');
        return;
      }
      
      if (!script) {
        alert('Please enter script content');
        return;
      }
      
      // Set digital human type to video
      digitalHumanType = 'video';
      
      showLoading(true, 'Creating video digital human...');
      
      try {
        // Ëé∑ÂèñÁº©Áï•Âõæ
        let thumbnail = null;
        if (selectedVideoFile && extractedFrames.length > 0) {
          const selectedFrame = extractedFrames.find(f => f.id === selectedFrameId) || extractedFrames[0];
          thumbnail = selectedFrame ? selectedFrame.dataUrl : null;
        }
        
        // Ëé∑ÂèñËØ≠Èü≥ËÆæÁΩÆ
        const voiceSelect = document.getElementById('voiceSelect');
        // ‰ºòÂÖà‰ΩøÁî®ÈÄâ‰∏≠ÁöÑËØ≠Èü≥IDÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ªéselectËé∑ÂèñÔºàÂêëÂêéÂÖºÂÆπÔºâ
        const voiceId = selectedVoiceId || (voiceSelect && voiceSelect.value ? voiceSelect.value : null);
        
        // Â§ÑÁêÜËßÜÈ¢ëËµÑÊ∫ê
        let videoBase64 = null;
        
        // Ê£ÄÊü•ÊòØÂê¶‰ΩøÁî®‰∫Ü‰∏ä‰º†ÂèÇËÄÉÊñá‰ª∂Ê®°ÂºèÊàñÂÆûÊó∂ÂΩïÂà∂Ê®°Âºè
        const uploadSection = document.getElementById('uploadReferenceSection');
        const recordSection = document.getElementById('recordSection');
        const isUploadMode = uploadSection && uploadSection.style.display !== 'none';
        const isRecordMode = recordSection && recordSection.style.display !== 'none';
        
        // ËßÜÈ¢ëÊï∞Â≠ó‰∫∫ÔºöÂ¶ÇÊûúÊúâ‰∏ä‰º†ÁöÑËßÜÈ¢ëÊñá‰ª∂ÊàñÂΩïÂà∂ÁöÑËßÜÈ¢ëÔºåËΩ¨Êç¢‰∏∫ base64
        const videoFile = selectedVideoFile || recordedVideoBlob;
        if (videoFile) {
          try {
            videoBase64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => {
                resolve(reader.result);
              };
              reader.onerror = reject;
              reader.readAsDataURL(videoFile);
            });
            console.log('Video file converted to base64, size:', (videoBase64.length / 1024 / 1024).toFixed(2), 'MB');
          } catch (error) {
            console.error('Video file conversion failed:', error);
            alert('‚ö†Ô∏è Video file conversion failed, will use HeyGen platform default avatar');
          }
        }
        
        // Â¶ÇÊûúÊúâ‰∏ä‰º†ÁöÑÈü≥È¢ëÊñá‰ª∂ÊàñÂΩïÂà∂ÁöÑÈü≥È¢ëÔºåËΩ¨Êç¢‰∏∫ base64
        let audioBase64 = null;
        const audioFile = selectedAudioFile || recordedAudioBlob;
        
        // Â¶ÇÊûú‰ΩøÁî®‰∏ä‰º†Ê®°ÂºèÊàñÂΩïÂà∂Ê®°ÂºèÔºåÂøÖÈ°ªÂêåÊó∂ÊúâËßÜÈ¢ëÂíåÈü≥È¢ë
        if (isUploadMode || isRecordMode) {
          if (!videoFile) {
            showLoading(false);
            alert('‚ùå Please upload or record video file first');
            return;
          }
          if (!audioFile) {
            showLoading(false);
            alert('‚ùå Please upload or record audio file first\n\nWhen uploading reference files or recording in real-time, you need to provide both video and audio.');
            return;
          }
        }
        
        if (audioFile) {
          try {
            audioBase64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => {
                resolve(reader.result);
              };
              reader.onerror = reject;
              reader.readAsDataURL(audioFile);
            });
            console.log('Audio file converted to base64, size:', (audioBase64.length / 1024 / 1024).toFixed(2), 'MB');
          } catch (error) {
            console.error('Audio file conversion failed:', error);
            if (isUploadMode || isRecordMode) {
              showLoading(false);
              alert('‚ö†Ô∏è Audio file conversion failed, please re-upload or record audio file');
              return;
            } else {
              alert('‚ö†Ô∏è Audio file conversion failed, will use text-to-speech (TTS)');
            }
          }
        }
        
        // Ë∞ÉÁî®ÊúçÂä°Âô®Á´Ø API ÂàõÂª∫‰ªªÂä°
        const response = await fetch(buildApiUrl('/api/heygen/video'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            apiKey,
            avatarId: selectedAvatarId || null,
            text: script,
            voiceId: voiceId,
            digitalHumanType: 'video', // Âõ∫ÂÆö‰∏∫ËßÜÈ¢ëÊï∞Â≠ó‰∫∫
            videoFile: videoBase64,
            audioFile: audioBase64,
            name: name,
            description: desc
          })
        });
        
        const contentType = response.headers.get('content-type') || '';
        let result;
        
        if (contentType.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error('Server returned non-JSON response:', text.substring(0, 200));
          throw new Error('Server returned a non-JSON response. Please check server configuration.');
        }
        
        if (!result.success) {
          showLoading(false);
          alert('‚ùå Failed to create task: ' + result.message);
          return;
        }
        
        // ‰ªªÂä°ÂàõÂª∫ÊàêÂäüÔºåÂøÖÈ°ªÊãøÂà∞ HeyGen ËøîÂõûÁöÑ video_id ÊâçËÉΩËΩÆËØ¢Áä∂ÊÄÅ
        const taskId = result.data?.video_id || result.data?.id || null;
        if (!taskId) {
          showLoading(false);
          console.error('HeyGen did not return video_id:', result);
          alert('‚ùå Failed to create task: Server did not return task ID (video_id). Please check HeyGen API response or contact technical support.');
          return;
        }
        
        const digitalHumanId = Date.now().toString();
        
        // ÂàõÂª∫‰∏¥Êó∂Êï∞Â≠ó‰∫∫ËÆ∞ÂΩïÔºàÂæÖÂÆåÊàêÁä∂ÊÄÅÔºâ
        const digitalHuman = {
          id: digitalHumanId,
          name: name,
          description: desc,
          script: script,
          platform: 'heygen',
          taskId: taskId,
          status: 'processing',
          progress: 0,
          videoUrl: null,
          thumbnail: thumbnail,
          videoFile: videoFile ? {
            name: selectedVideoFile ? selectedVideoFile.name : 'recorded_video.webm',
            size: videoFile.size,
            type: videoFile.type
          } : null,
          audioFile: audioFile ? {
            name: selectedAudioFile ? selectedAudioFile.name : 'recorded_audio.webm',
            size: audioFile.size,
            type: audioFile.type
          } : null,
          voice: voiceId,
          speed: 5,
          pitch: 5,
          volume: 5,
          createDate: new Date().toISOString(),
          updateDate: new Date().toISOString()
        };
        
        // ‰øùÂ≠òÂà∞localStorage
        const digitalHumans = JSON.parse(localStorage.getItem('intl_digital_humans') || '[]');
        digitalHumans.unshift(digitalHuman);
        if (digitalHumans.length > 50) digitalHumans.length = 50;
        localStorage.setItem('intl_digital_humans', JSON.stringify(digitalHumans));
        
        showLoading(false);
        
        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
        alert('‚úÖ Digital human creation task submitted!\n\nThe task is being processed in the background. You can check the progress in "Digital Human Management".\n\nTask ID: ' + taskId);
        
        // ÈáçÁΩÆË°®Âçï
        resetCreateForm();
        
        // ÂàáÊç¢Âà∞Êï∞Â≠ó‰∫∫ÁÆ°ÁêÜ
        switchMenu('manage');
        
        // ÂºÄÂßãËΩÆËØ¢‰ªªÂä°Áä∂ÊÄÅ
        startTaskPolling(digitalHumanId, taskId, apiKey);
        
      } catch (error) {
        console.error('Create HeyGen digital human error:', error);
        showLoading(false);
        alert('‚ùå Error occurred while creating task: ' + error.message);
      }
    }
    
    // ÂºÄÂßãËΩÆËØ¢‰ªªÂä°Áä∂ÊÄÅ
    function startTaskPolling(digitalHumanId, taskId, apiKey) {
      // Â¶ÇÊûúÂ∑≤ÊúâËΩÆËØ¢ÔºåÂÖàÊ∏ÖÈô§
      if (taskPollingIntervals.has(digitalHumanId)) {
        clearInterval(taskPollingIntervals.get(digitalHumanId));
      }
      
      let pollCount = 0;
      const maxPolls = 300;
      
      const pollInterval = setInterval(async () => {
        pollCount++;
        
        if (pollCount > maxPolls) {
          clearInterval(pollInterval);
          taskPollingIntervals.delete(digitalHumanId);
          updateTaskStatus(digitalHumanId, 'failed', 0, null, '‰ªªÂä°Ë∂ÖÊó∂ÔºåËØ∑ÊâãÂä®Âà∑Êñ∞Êü•ÁúãÁä∂ÊÄÅ');
          return;
        }
        
        try {
          const response = await fetch(`/api/heygen/task/${taskId}?apiKey=${encodeURIComponent(apiKey)}`);
          
          const contentType = response.headers.get('content-type') || '';
          let result;
          
          if (contentType.includes('application/json')) {
            result = await response.json();
          } else {
            const text = await response.text();
            console.error('ÊúçÂä°Âô®ËøîÂõûÈùûJSONÂìçÂ∫î:', text.substring(0, 200));
            return;
          }
          
          if (result.success) {
            const status = result.status;
            const progress = result.progress || 0;
            const videoUrl = result.videoUrl || result.data?.video_url;
            const error = result.error;
            
            updateTaskStatus(digitalHumanId, status, progress, videoUrl, error);
            
            // Â¶ÇÊûú‰ªªÂä°ÂÆåÊàêÊàñÂ§±Ë¥•ÔºåÂÅúÊ≠¢ËΩÆËØ¢
            if (status === 'completed' || status === 'failed') {
              // Ê£ÄÊü•ÊòØÂê¶‰∏∫Ëá¥ÂëΩÈîôËØØÔºà‰∏çÂèØÊÅ¢Â§çÁöÑÈîôËØØÔºâ
              const isFatalError = error && (
                error.includes('Insufficient credit') ||
                error.includes('‰ΩôÈ¢ù‰∏çË∂≥') ||
                error.includes('MOVIO_PAYMENT_INSUFFICIENT_CREDIT') ||
                error.includes('unauthorized') ||
                error.includes('ÊùÉÈôê') ||
                error.includes('invalid') ||
                error.includes('forbidden')
              );
              
              // Â¶ÇÊûúÊòØËá¥ÂëΩÈîôËØØÔºåÁ´ãÂç≥Ê†áËÆ∞‰∏∫Â§±Ë¥•
              if (status === 'failed' && isFatalError) {
                updateTaskStatus(digitalHumanId, 'failed', 0, null, error);
              }
              
              clearInterval(pollInterval);
              taskPollingIntervals.delete(digitalHumanId);
              
              // Â¶ÇÊûúÂ§±Ë¥•ÔºåÊòæÁ§∫ÈîôËØØÊèêÁ§∫
              if (status === 'failed') {
                const errorMsg = error || '‰ªªÂä°Â§±Ë¥•ÔºåÂéüÂõ†Êú™Áü•';
                console.error('Task failed:', { digitalHumanId, taskId, error: errorMsg, isFatalError });
                
                // Â¶ÇÊûúÁî®Êà∑Âú®Êï∞Â≠ó‰∫∫ÁÆ°ÁêÜÈ°µÈù¢ÔºåÂà∑Êñ∞ÊòæÁ§∫ÔºàÈîôËØØ‰ø°ÊÅØ‰ºöÊòæÁ§∫Âú®ÂàóË°®‰∏≠Ôºâ
                if (document.getElementById('managePanel') && !document.getElementById('managePanel').classList.contains('hidden')) {
                  loadDigitalHumans();
                } else if (isFatalError) {
                  // Â¶ÇÊûú‰∏çÂú®ÁÆ°ÁêÜÈ°µÈù¢‰∏îÊòØËá¥ÂëΩÈîôËØØÔºåÊòæÁ§∫ÂºπÁ™óÊèêÁ§∫
                  alert(`‚ùå Êï∞Â≠ó‰∫∫ÂàõÂª∫Â§±Ë¥•\n\n‰ªªÂä°ID: ${taskId}\nÈîôËØØ‰ø°ÊÅØ: ${errorMsg}\n\nËØ∑ÂâçÂæÄ"Êï∞Â≠ó‰∫∫ÁÆ°ÁêÜ"Êü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ`);
                }
              }
            }
          } else {
            // Â¶ÇÊûúÊü•ËØ¢Â§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ΩÜ‰∏çÂÅúÊ≠¢ËΩÆËØ¢ÔºàÂèØËÉΩÊòØ‰∏¥Êó∂ÁΩëÁªúÈóÆÈ¢òÔºâ
            console.error('Failed to query task status:', { digitalHumanId, taskId, error: result.message });
            
            // Â¶ÇÊûúËøûÁª≠Â§öÊ¨°Â§±Ë¥•ÔºåÂÅúÊ≠¢ËΩÆËØ¢
            if (pollCount > 10 && pollCount % 5 === 0) {
              clearInterval(pollInterval);
              taskPollingIntervals.delete(digitalHumanId);
              updateTaskStatus(digitalHumanId, 'failed', 0, null, `Êü•ËØ¢Áä∂ÊÄÅÂ§±Ë¥•: ${result.message || 'Êú™Áü•ÈîôËØØ'}`);
              console.error('Continuous query failures, stopping polling:', { digitalHumanId, taskId });
            }
          }
        } catch (error) {
          console.error('Poll task status error:', error);
        }
      }, 10000); // ÊØè10ÁßíÊü•ËØ¢‰∏ÄÊ¨°
      
      taskPollingIntervals.set(digitalHumanId, pollInterval);
    }
    
    // Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ
    function updateTaskStatus(digitalHumanId, status, progress, videoUrl, error) {
      const digitalHumans = JSON.parse(localStorage.getItem('intl_digital_humans') || '[]');
      const index = digitalHumans.findIndex(dh => dh.id === digitalHumanId);
      
      if (index !== -1) {
        const oldStatus = digitalHumans[index].status;
        digitalHumans[index].status = status;
        digitalHumans[index].progress = progress;
        digitalHumans[index].updateDate = new Date().toISOString();
        
        if (videoUrl) {
          digitalHumans[index].videoUrl = videoUrl;
        }
        
        // ‰øùÂ≠òÈîôËØØ‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
        if (error) {
          digitalHumans[index].error = error;
        } else if (status === 'failed' && !digitalHumans[index].error) {
          // Â¶ÇÊûúÁä∂ÊÄÅÊòØÂ§±Ë¥•‰ΩÜÊ≤°ÊúâÈîôËØØ‰ø°ÊÅØÔºåËÆæÁΩÆÈªòËÆ§ÈîôËØØ‰ø°ÊÅØ
          digitalHumans[index].error = '‰ªªÂä°Â§±Ë¥•ÔºåÂéüÂõ†Êú™Áü•';
        }
        
        localStorage.setItem('intl_digital_humans', JSON.stringify(digitalHumans));
        
        // Â¶ÇÊûúÊ≠£Âú®Êü•ÁúãÊï∞Â≠ó‰∫∫ÁÆ°ÁêÜÈ°µÈù¢ÔºåÂà∑Êñ∞ÊòæÁ§∫
        if (document.getElementById('managePanel') && !document.getElementById('managePanel').classList.contains('hidden')) {
          loadDigitalHumans();
        }
        
        // ËÆ∞ÂΩïÁä∂ÊÄÅÂèòÂåñ
        if (oldStatus !== status) {
          console.log('Task status updated:', { digitalHumanId, oldStatus, newStatus: status, error });
        }
      }
    }
    
    function resetCreateForm() {
      currentStep = 1;
      selectedAvatar = 'üë©‚Äçüíº';
      uploadedMaterials = [];
      recordedVideoBlob = null;
      recordedAudioBlob = null;
      selectedVideoFile = null;
      selectedVideoUrl = null;
      extractedFrames = [];
      selectedFrameId = null;
      selectedAvatarId = null;
      selectedTemplatePreviewVideo = null;
      selectedTemplatePreviewImage = null;
      selectedTemplateName = null;
      currentPlatform = 'heygen';
      document.getElementById('scriptInput').value = '';
      document.getElementById('digitalHumanName').value = '';
      document.getElementById('digitalHumanDesc').value = '';
      updateStepIndicator(1);
      goToStep(1);
      
      // Ê∏ÖÁêÜËßÜÈ¢ëÈ¢ÑËßà
      removeUploadedVideo();
      hideTemplatePreview();
    }
    
    // ========== Êï∞Â≠ó‰∫∫ÁÆ°ÁêÜ ==========
    
    function loadDigitalHumans() {
      const digitalHumans = JSON.parse(localStorage.getItem('intl_digital_humans') || '[]');
      const container = document.getElementById('digitalHumanManageList');
      
      // Â¶ÇÊûúÂÆπÂô®‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû
      if (!container) {
        console.warn('Cannot find digitalHumanManageList container, skipping digital human list loading');
        return;
      }
      
      if (digitalHumans.length === 0) {
        container.innerHTML = '<div class="empty-history">No digital humans yet, please create one first</div>';
        return;
      }
      
      container.innerHTML = digitalHumans.map(dh => {
        // ‰ΩøÁî®ËßÜÈ¢ëÁº©Áï•ÂõæÊàñËßÜÈ¢ëÈ¢ÑËßà
        const avatarDisplay = dh.thumbnail 
          ? `<img src="${dh.thumbnail}" style="width: 48px; height: 48px; border-radius: 12px; object-fit: cover;">`
          : dh.videoUrl
          ? `<video src="${dh.videoUrl}" style="width: 48px; height: 48px; border-radius: 12px; object-fit: cover;" muted></video>`
          : `<span class="history-avatar">${dh.avatar || 'üë§'}</span>`;
        
        // Áä∂ÊÄÅÊòæÁ§∫ÔºàHeyGen Âπ≥Âè∞Ôºâ
        let statusBadge = '';
        if (dh.platform === 'heygen' && dh.status) {
          if (dh.status === 'processing') {
            const progress = dh.progress || 0;
            statusBadge = `
              <div style="margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-size: 0.85rem; color: var(--primary);">‚è≥ Processing...</span>
                  <span style="font-size: 0.85rem; color: var(--text-secondary);">${progress}%</span>
                </div>
                <div style="width: 100%; height: 6px; background: var(--bg-primary); border-radius: 3px; overflow: hidden;">
                  <div style="width: ${progress}%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); transition: width 0.3s;"></div>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">Task ID: ${dh.taskId || 'N/A'}</div>
              </div>
            `;
          } else if (dh.status === 'completed') {
            statusBadge = `
              <div style="margin-top: 8px; padding: 6px 12px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; display: inline-block;">
                <span style="font-size: 0.85rem; color: #22c55e;">‚úÖ Completed</span>
              </div>
            `;
          } else if (dh.status === 'failed') {
            statusBadge = `
              <div style="margin-top: 8px; padding: 6px 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px;">
                <div style="font-size: 0.85rem; color: #ef4444; margin-bottom: 4px;">‚ùå Creation Failed</div>
                ${dh.error ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${dh.error}</div>` : ''}
                <button onclick="retryHeyGenTask('${dh.id}')" style="margin-top: 4px; padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">üîÑ Retry</button>
              </div>
            `;
          }
        }
        
        // Âπ≥Âè∞Ê†áËØÜ
        const platformBadge = dh.platform === 'heygen' 
          ? '<span style="font-size: 0.75rem; padding: 2px 6px; background: var(--primary); color: white; border-radius: 4px; margin-left: 8px;">HeyGen</span>'
          : '';
        
        return `
        <div class="history-item">
          <div class="history-header">
            ${avatarDisplay}
            <div class="history-meta">
              <div class="history-date">${new Date(dh.createDate || Date.now()).toLocaleString()}</div>
            </div>
          </div>
          <div style="margin-bottom: 12px;">
            <h4 style="margin-bottom: 8px; display: flex; align-items: center;">
              ${dh.name}
              ${platformBadge}
            </h4>
            <div class="history-script">${dh.description || 'No description'}</div>
            ${dh.videoFile ? `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">üìπ ${dh.videoFile.name}</div>` : ''}
            ${statusBadge}
          </div>
          <div class="history-actions">
            ${dh.status === 'completed' || !dh.status || dh.status !== 'processing' ? `<button class="history-btn" onclick="previewDigitalHumanVideo('${dh.id}')">üëÅÔ∏è Preview</button>` : ''}
            ${dh.platform === 'heygen' && dh.status === 'processing' ? `<button class="history-btn" onclick="refreshTaskStatus('${dh.id}')">üîÑ Refresh</button>` : ''}
            <button class="history-btn" onclick="deleteDigitalHuman('${dh.id}')">üóëÔ∏è Delete</button>
          </div>
        </div>
      `;
      }).join('');
    }
    
    // Âà∑Êñ∞‰ªªÂä°Áä∂ÊÄÅ
    async function refreshTaskStatus(digitalHumanId) {
      const digitalHumans = JSON.parse(localStorage.getItem('intl_digital_humans') || '[]');
      const dh = digitalHumans.find(d => d.id === digitalHumanId);
      
      if (!dh || dh.platform !== 'heygen' || !dh.taskId) {
        alert('Cannot refresh: Task information is incomplete');
        return;
      }
      
      const apiKey = getHeyGenApiKey();
      
      if (!apiKey) {
        alert('Please configure HeyGen API Key first\n\nTip: Please return to Step 1, fill in the correct API Key and click "Save Configuration".');
        return;
      }
      
      try {
        const response = await fetch(`/api/heygen/task/${dh.taskId}?apiKey=${encodeURIComponent(apiKey)}`);
        
        const contentType = response.headers.get('content-type') || '';
        let result;
        
        if (contentType.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error('Server returned non-JSON response:', text.substring(0, 200));
          alert('Server returned a non-JSON response. Please check server configuration.');
          return;
        }
        
        if (result.success) {
          updateTaskStatus(digitalHumanId, result.status, result.progress, result.videoUrl, result.error);
          loadDigitalHumans();
          
          if (result.status === 'completed') {
            alert('‚úÖ Task completed!');
          } else if (result.status === 'failed') {
            alert('‚ùå Task failed: ' + (result.error || 'Unknown error'));
          } else {
            alert('Task status updated: ' + (result.progress || 0) + '%');
          }
        } else {
          alert('Refresh failed: ' + result.message);
        }
      } catch (error) {
        console.error('Refresh task status error:', error);
        alert('Refresh failed: ' + error.message);
      }
    }
    
    // ÈáçËØï HeyGen ‰ªªÂä°
    async function retryHeyGenTask(digitalHumanId) {
      const digitalHumans = JSON.parse(localStorage.getItem('intl_digital_humans') || '[]');
      const dh = digitalHumans.find(d => d.id === digitalHumanId);
      
      if (!dh || dh.platform !== 'heygen') {
        alert('Cannot retry: Not a HeyGen digital human');
        return;
      }
      
      if (!confirm('Are you sure you want to recreate this digital human?')) {
        return;
      }
      
      const apiKey = getHeyGenApiKey();
      
      if (!apiKey) {
        alert('Please configure HeyGen API Key first\n\nTip: Please return to Step 1, fill in the correct API Key and click "Save Configuration".');
        return;
      }
      
      showLoading(true, 'Recreating task...');
      
      try {
        const response = await fetch(buildApiUrl('/api/heygen/video'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            apiKey,
            avatarId: 'default',
            text: dh.script,
            voiceId: dh.voice || null
          })
        });
        
        const contentType = response.headers.get('content-type') || '';
        let result;
        
        if (contentType.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error('Server returned non-JSON response:', text.substring(0, 200));
          throw new Error('Server returned a non-JSON response. Please check server configuration.');
        }
        
        if (!result.success) {
          showLoading(false);
          alert('‚ùå Retry failed: ' + result.message);
          return;
        }
        
        const taskId = result.data?.video_id || result.data?.id || null;
        if (!taskId) {
          showLoading(false);
          alert('‚ùå Retry failed: Task ID (video_id) not returned, cannot query status.');
          return;
        }
        
        const index = digitalHumans.findIndex(d => d.id === digitalHumanId);
        if (index !== -1) {
          digitalHumans[index].taskId = taskId;
          digitalHumans[index].status = 'processing';
          digitalHumans[index].progress = 0;
          digitalHumans[index].error = null;
          digitalHumans[index].updateDate = new Date().toISOString();
          localStorage.setItem('intl_digital_humans', JSON.stringify(digitalHumans));
        }
        
        showLoading(false);
        alert('‚úÖ Task resubmitted! Processing in background...');
        
        startTaskPolling(digitalHumanId, taskId, apiKey);
        loadDigitalHumans();
        
      } catch (error) {
        console.error('Retry task error:', error);
        showLoading(false);
        alert('‚ùå Retry failed: ' + error.message);
      }
    }
    
    function previewDigitalHumanVideo(id) {
      const digitalHumans = JSON.parse(localStorage.getItem('intl_digital_humans') || '[]');
      const dh = digitalHumans.find(d => d.id === id);
      
      if (!dh) {
        alert('Digital human does not exist');
        return;
      }
      
      if (dh.videoUrl || dh.videoFile?.dataUrl) {
        let videoUrl = dh.videoUrl || dh.videoFile.dataUrl;
        
        // Â§ÑÁêÜÁ∫Ø base64 Â≠óÁ¨¶‰∏≤ÔºöÂ¶ÇÊûú videoUrl ÊòØÁ∫Ø base64ÔºàÊ≤°Êúâ data: ÂâçÁºÄÔºâÔºåËΩ¨Êç¢‰∏∫ data URL
        if (!videoUrl.startsWith('data:') && !videoUrl.startsWith('http://') && !videoUrl.startsWith('https://') && !videoUrl.startsWith('blob:')) {
          // ÂÅáËÆæÊòØËßÜÈ¢ëÊ†ºÂºèÔºåÂ∞ùËØïÊ£ÄÊµãÊòØÂê¶‰∏∫ base64
          if (/^[A-Za-z0-9+/=]+$/.test(videoUrl.replace(/[\s\n\r]/g, ''))) {
            // ÊòØ base64 Â≠óÁ¨¶‰∏≤ÔºåËΩ¨Êç¢‰∏∫ data URLÔºàÂÅáËÆæÊòØ mp4 Ê†ºÂºèÔºâ
            videoUrl = `data:video/mp4;base64,${videoUrl}`;
          }
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center;';
        modal.innerHTML = `
          <div style="position: relative; max-width: 90%; max-height: 90%;">
            <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: -40px; right: 0; background: var(--danger); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">ÂÖ≥Èó≠</button>
            <video src="${videoUrl}" controls autoplay style="max-width: 100%; max-height: 90vh; border-radius: 8px;"></video>
          </div>
        `;
        document.body.appendChild(modal);
        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
      } else {
        alert('This digital human has no video file');
      }
    }
    
    function deleteDigitalHuman(id) {
      if (!confirm('Are you sure you want to delete this digital human?')) return;
      
      let digitalHumans = JSON.parse(localStorage.getItem('intl_digital_humans') || '[]');
      digitalHumans = digitalHumans.filter(dh => dh.id !== id);
      localStorage.setItem('intl_digital_humans', JSON.stringify(digitalHumans));
      
      loadDigitalHumans();
    }
    
    // ========== ‰ΩúÂìÅÁÆ°ÁêÜ ==========
    
    function loadWorks() {
      const works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
      const container = document.getElementById('worksList');
      
      // Â¶ÇÊûúÂÆπÂô®‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû
      if (!container) {
        console.warn('Cannot find worksList container, skipping works list loading');
        return;
      }
      
      if (works.length === 0) {
        container.innerHTML = '<div class="empty-history">No works yet</div>';
        return;
      }
      
      container.innerHTML = works.map(work => {
        const typeLabel = work.type === 'product' ? 'üõí Product Promotion' : 'üé¨ Other';
        const title = work.type === 'product' ? work.productName : work.title;
        
        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-avatar">${typeLabel}</span>
              <div class="history-meta">
                <div class="history-platform" style="background: ${work.status === 'ready' ? 'var(--success)' : 'var(--warning)'};">${work.status === 'ready' ? 'Completed' : 'Processing'}</div>
                <div class="history-date">${new Date(work.createDate).toLocaleString()}</div>
              </div>
            </div>
            <div class="history-script">${title}</div>
            <div class="history-actions">
              <button class="history-btn" onclick="playWork('${work.id}')">‚ñ∂Ô∏è Play</button>
              <button class="history-btn" onclick="downloadWork('${work.id}')">üì• Download</button>
              <button class="history-btn" onclick="deleteWork('${work.id}')">üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function playWork(id) {
      alert('Play function under development...');
    }
    
    function downloadWork(id) {
      alert('Download function under development...');
    }
    
    function deleteWork(id) {
      if (!confirm('Are you sure you want to delete this work?')) return;
      
      let works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
      works = works.filter(w => w.id !== id);
      localStorage.setItem('intl_dh_works', JSON.stringify(works));
      
      loadWorks();
    }
    
    // ========== ÈÄöÁî®ÂäüËÉΩ ==========
    
    // Êõ¥Êñ∞Â≠óÊï∞ÁªüËÆ°
    function updateCharCount() {
      const text = document.getElementById('scriptInput').value;
      const count = text.length;
      const countEl = document.getElementById('charCount');
      
      countEl.textContent = `${count} / 500 characters`;
      countEl.className = 'char-count';
      
      if (count > 500) {
        countEl.classList.add('error');
      } else if (count > 400) {
        countEl.classList.add('warning');
      }
    }
    
    // Êõ¥Êñ∞ÊªëÂùóÂÄº
    function updateSliderValue(type) {
      const slider = document.getElementById(type + 'Slider');
      const valueEl = document.getElementById(type + 'Value');
      valueEl.textContent = slider.value;
    }
    
    // ========== HeyGen API ==========
    
    function saveHeyGenConfig() {
      const apiKey = document.getElementById('heygenApiKey').value.trim();
      
      if (!apiKey) {
        showStatus('heygenStatus', 'Please fill in API Key', 'error');
        return;
      }
      
      try {
        localStorage.setItem('intl_heygen_api_key', apiKey);
        showStatus('heygenStatus', '‚úÖ Configuration saved (recommended to click "Test Connection" to verify)', 'success');
      } catch (e) {
        console.warn('Cannot save to localStorage:', e);
        showStatus('heygenStatus', '‚ö†Ô∏è Configuration saved to input field, but localStorage may be unavailable', 'warning');
      }
    }
    
    async function testHeyGenApi() {
      const apiKey = document.getElementById('heygenApiKey').value.trim();
      
      if (!apiKey) {
        showStatus('heygenStatus', 'Please fill in API Key first', 'error');
        return;
      }
      
      showStatus('heygenStatus', '‚è≥ Testing connection...', 'warning');
      
      try {
        const response = await fetch(buildApiUrl('/api/heygen/test'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            apiKey
          })
        });
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Non-JSON response:', text.substring(0, 200));
          showStatus('heygenStatus', '‚ùå Server returned non-JSON response, please check server configuration', 'error');
          return;
        }
        
        const result = await response.json();
        
        if (result.success) {
          localStorage.setItem('intl_heygen_api_key', apiKey);
          localStorage.setItem('intl_heygen_api_tested', 'true');
          localStorage.setItem('intl_heygen_api_test_time', new Date().toISOString());
          showStatus('heygenStatus', '‚úÖ ' + (result.message || 'Connection successful! API Key verified'), 'success');
          
          // ÊµãËØïÊàêÂäüÂêéËá™Âä®Âä†ËΩΩËØ≠Èü≥ÂàóË°®
          setTimeout(() => {
            loadHeyGenVoices();
          }, 500);
        } else {
          localStorage.removeItem('intl_heygen_api_tested');
          showStatus('heygenStatus', '‚ùå Connection failed: ' + (result.message || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('HeyGen API test error:', error);
        if (error.message.includes('JSON')) {
          showStatus('heygenStatus', '‚ùå Server response format error, please check server configuration', 'error');
        } else {
          showStatus('heygenStatus', '‚ùå Network error: ' + error.message, 'error');
        }
      }
    }
    
    // Âä†ËΩΩ HeyGen Avatar Ê®°ÊùøÂàóË°®ÔºàÊîØÊåÅÂàÜÈ°µÂíåËµÑÊ∫êÁ±ªÂûãËøáÊª§Ôºâ
    async function loadHeyGenAvatars(context = 'create', resetPage = true) {
      const apiKey = getHeyGenApiKey();
      
      if (!apiKey) {
        alert('Please configure and test HeyGen API Key first\n\nTip: Please return to Step 1, fill in the correct API Key and click "Test Connection".');
        return;
      }
      
      // Ê†πÊçÆ‰∏ä‰∏ãÊñáÈÄâÊã©ÂÆπÂô®
      let containerId;
      if (context === 'create') {
        containerId = 'avatarTemplateGrid';
      } else if (context === 'recite') {
        containerId = 'reciteAvatarSelector';
      } else if (context === 'promote') {
        containerId = 'promoteAvatarSelector';
      } else {
        console.warn('Unknown context:', context);
        return;
      }
      
      const container = document.getElementById(containerId);
      if (!container) {
        console.warn('Cannot find container:', containerId);
        return;
      }
      
      // ÈáçÁΩÆÂàÜÈ°µÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
      if (resetPage) {
        currentPage = 1;
        displayedAvatars = pageSize; // ÂàùÂßãÊòæÁ§∫Á¨¨‰∏ÄÈ°µÁöÑÊï∞Èáè
      }
      
      // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      const loadingState = document.getElementById('avatarLoadingState');
      if (loadingState) {
        loadingState.style.display = 'block';
        loadingState.innerHTML = `
          <div style="font-size: 2.5rem; margin-bottom: 12px; animation: pulse 2s infinite;">‚è≥</div>
          <div style="font-size: 0.9rem; margin-bottom: 8px;">Ê≠£Âú®Âä†ËΩΩÊ®°Êùø...</div>
          <div style="font-size: 0.75rem; color: var(--text-secondary); opacity: 0.7;">ËØ∑Á®çÂÄôÔºåÊ≠£Âú®‰ªé HeyGen Âπ≥Âè∞Ëé∑ÂèñÊï∞Â≠ó‰∫∫Ê®°Êùø</div>
        `;
      }
      
      // Êõ¥Êñ∞Âà∑Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
      const refreshBtn = document.getElementById('refreshAvatarBtn');
      const refreshIcon = document.getElementById('refreshAvatarIcon');
      const refreshText = document.getElementById('refreshAvatarText');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
        if (refreshIcon) refreshIcon.innerHTML = '<span class="loading-spinner">üîÑ</span>';
        if (refreshText) refreshText.textContent = 'Loading...';
      }
      
      try {
        // ÊûÑÂª∫APIËØ∑Ê±ÇURLÔºåÊ∑ªÂä†ËµÑÊ∫êÁ±ªÂûãÂèÇÊï∞
        let apiUrl = `/api/heygen/avatars?apiKey=${encodeURIComponent(apiKey)}`;
        if (context === 'create') {
          apiUrl += `&resourceType=video`;
        }
        
        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const contentType = response.headers.get('content-type') || '';
        let result;
        
        if (contentType.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error('ÊúçÂä°Âô®ËøîÂõûÈùûJSONÂìçÂ∫î:', text.substring(0, 200));
          throw new Error('Server returned a non-JSON response');
        }
        
        if (result.success && result.avatars && result.avatars.length > 0) {
          // ÁºìÂ≠ò avatar ÂàóË°®
          heygenAvatarsCache = result.avatars;
          
          // ÂàùÂßãÂåñÊòæÁ§∫Êï∞ÈáèÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâËÆæÁΩÆÔºâ
          if (displayedAvatars === 0) {
            displayedAvatars = pageSize;
          }
          
          // ‰ΩøÁî®Êñ∞ÁöÑÊ∏≤ÊüìÂáΩÊï∞
          renderAvatars();
          
          console.log('Loaded', result.avatars.length, 'avatar templates');
          
          // ÊÅ¢Â§çÂà∑Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
          if (refreshBtn) {
            refreshBtn.classList.remove('loading');
            refreshBtn.disabled = false;
            if (refreshIcon) refreshIcon.textContent = 'üîÑ';
            if (refreshText) refreshText.textContent = 'Refresh Templates';
          }
        } else {
          container.innerHTML = `
            <div style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1 / -1;">
              <div style="font-size: 2rem; margin-bottom: 8px;">‚ö†Ô∏è</div>
              <div style="font-size: 0.9rem; margin-bottom: 12px; color: var(--warning);">${result.message || 'Êó†Ê≥ïÂä†ËΩΩÊ®°ÊùøÂàóË°®'}</div>
              <button class="btn secondary" onclick="loadHeyGenAvatars('${context}')" style="padding: 8px 16px; font-size: 0.85rem;">
                üîÑ ÈáçËØï
              </button>
            </div>
          `;
          
          // ÊÅ¢Â§çÂà∑Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
          if (refreshBtn) {
            refreshBtn.classList.remove('loading');
            refreshBtn.disabled = false;
            if (refreshIcon) refreshIcon.textContent = 'üîÑ';
            if (refreshText) refreshText.textContent = 'Refresh Templates';
          }
        }
      } catch (error) {
        console.error('Load avatar template error:', error);
        
        let errorMessage = error.message || 'Êú™Áü•ÈîôËØØ';
        if (error.message && error.message.includes('Ë∂ÖÊó∂')) {
          errorMessage = 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Á®çÂêéÈáçËØï';
        } else if (error.message && error.message.includes('fetch')) {
          errorMessage = 'ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
        }
        
        container.innerHTML = `
          <div style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1 / -1;">
            <div style="font-size: 2rem; margin-bottom: 8px;">‚ö†Ô∏è</div>
            <div style="font-size: 0.9rem; margin-bottom: 12px; color: var(--warning);">${errorMessage}</div>
            <button class="btn secondary" onclick="loadHeyGenAvatars('${context}')" style="padding: 8px 16px; font-size: 0.85rem;">
              üîÑ ÈáçËØï
            </button>
          </div>
        `;
        
        // ÊÅ¢Â§çÂà∑Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
          refreshBtn.disabled = false;
          if (refreshIcon) refreshIcon.textContent = 'üîÑ';
          if (refreshText) refreshText.textContent = 'Âà∑Êñ∞Ê®°Êùø';
        }
      }
    }
    
    // ÈÄâÊã© avatar Ê®°Êùø
    function selectAvatarTemplate(avatarId, context, avatarData = null) {
      // Ê∏ÖÈô§‰∏ä‰º†ÁöÑÊñá‰ª∂ÂíåÂΩïÂà∂ÁöÑÂÜÖÂÆπÔºà‰∫íÊñ•ÈÄªËæëÔºâ
      clearUploadedFiles();
      clearRecordedFiles();
      
      // ÁßªÈô§‰πãÂâçÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
      document.querySelectorAll('.avatar-template-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Ê∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
      const selectedItem = document.querySelector(`[data-avatar-id="${avatarId}"]`);
      if (selectedItem) {
        selectedItem.classList.add('selected');
        
        // Â¶ÇÊûúÊ≤°Êúâ‰º†ÂÖ•avatarDataÔºåÂ∞ùËØï‰ªédataÂ±ûÊÄßËé∑Âèñ
        if (!avatarData) {
          const dataAttr = selectedItem.getAttribute('data-avatar-data');
          if (dataAttr) {
            try {
              avatarData = JSON.parse(dataAttr);
            } catch (e) {
              console.warn('Failed to parse avatar data:', e);
            }
          }
        }
      }
      
      // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑ avatar ID
      if (context === 'create') {
        selectedAvatarId = avatarId;
        
        // ‰øùÂ≠òÊ®°ÊùøÈ¢ÑËßà URLÔºå‰æõÊ≠•È™§3„ÄåÊï∞Â≠ó‰∫∫ËßÜÈ¢ëÂΩ¢Ë±°„ÄçÂ±ïÁ§∫
        if (avatarData) {
          selectedTemplatePreviewVideo = avatarData.preview_video_url || avatarData.video_url || avatarData.preview_video || null;
          selectedTemplatePreviewImage = avatarData.preview_image_url || avatarData.preview_url || null;
          selectedTemplateName = avatarData.avatar_name || avatarData.name || 'Êú™Áü•Ê®°Êùø';
          showTemplatePreview(avatarData);
        } else {
          selectedTemplatePreviewVideo = null;
          selectedTemplatePreviewImage = null;
          selectedTemplateName = null;
          // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªéÁºìÂ≠ò‰∏≠Êü•Êâæ
          if (heygenAvatarsCache && Array.isArray(heygenAvatarsCache)) {
            const foundAvatar = heygenAvatarsCache.find(a => 
              (a.avatar_id || a.id) === avatarId
            );
            if (foundAvatar) {
              selectedTemplatePreviewVideo = foundAvatar.preview_video_url || foundAvatar.video_url || foundAvatar.preview_video || null;
              selectedTemplatePreviewImage = foundAvatar.preview_image_url || foundAvatar.preview_url || null;
              selectedTemplateName = foundAvatar.avatar_name || foundAvatar.name || 'Êú™Áü•Ê®°Êùø';
              showTemplatePreview(foundAvatar);
            } else {
              selectedTemplatePreviewVideo = null;
              selectedTemplatePreviewImage = null;
              selectedTemplateName = null;
              hideTemplatePreview();
            }
          } else {
            selectedTemplatePreviewVideo = null;
            selectedTemplatePreviewImage = null;
            selectedTemplateName = null;
            hideTemplatePreview();
          }
        }
      } else if (context === 'recite') {
        selectedAvatarForRecite = avatarId;
      } else if (context === 'promote') {
        selectedAvatarForPromote = avatarId;
      }
      
      console.log('Â∑≤ÈÄâÊã© avatar:', avatarId, '‰∏ä‰∏ãÊñá:', context);
    }
    
    // ÊòæÁ§∫Ê®°ÊùøÈ¢ÑËßà
    function showTemplatePreview(avatarData) {
      const previewSection = document.getElementById('templatePreviewSection');
      const previewContent = document.getElementById('templatePreviewContent');
      
      if (!previewSection || !previewContent) {
        return;
      }
      
      const avatarName = avatarData.avatar_name || avatarData.name || 'Êú™Áü•Ê®°Êùø';
      const previewVideoUrl = avatarData.preview_video_url || avatarData.video_url || avatarData.preview_video || '';
      const previewImageUrl = avatarData.preview_image_url || avatarData.preview_url || '';
      
      // ÊòæÁ§∫È¢ÑËßàÂå∫Âüü
      previewSection.style.display = 'block';
      
      // ÊûÑÂª∫È¢ÑËßàÂÜÖÂÆπ
      let previewHTML = `
        <div style="margin-bottom: 16px;">
          <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
            ${avatarName}
          </div>
          <div style="font-size: 0.85rem; color: var(--text-secondary);">
            Ê®°ÊùøID: ${avatarData.avatar_id || avatarData.id || 'Êú™Áü•'}
          </div>
        </div>
      `;
      
      // Â¶ÇÊûúÊúâÈ¢ÑËßàËßÜÈ¢ëÔºå‰ºòÂÖàÊòæÁ§∫ËßÜÈ¢ë
      if (previewVideoUrl) {
        previewHTML += `
          <div style="margin-bottom: 12px;">
            <video 
              id="templatePreviewVideo" 
              controls 
              style="width: 100%; max-width: 600px; max-height: 400px; border-radius: 8px; background: #000; margin: 0 auto; display: block;"
              preload="metadata"
              onerror="this.parentElement.innerHTML='<div style=\\'text-align:center;color:var(--text-secondary);padding:20px;\\'>Video loading failed</div>'">
              <source src="${previewVideoUrl}" type="video/mp4">
              <source src="${previewVideoUrl}" type="video/webm">
              Your browser does not support video playback.
            </video>
          </div>
        `;
      } else if (previewImageUrl) {
        // Â¶ÇÊûúÊ≤°ÊúâËßÜÈ¢ë‰ΩÜÊúâÂõæÁâáÔºåÊòæÁ§∫ÂõæÁâá
        previewHTML += `
          <div style="margin-bottom: 12px;">
            <img 
              src="${previewImageUrl}" 
              style="width: 100%; max-width: 400px; max-height: 400px; border-radius: 8px; object-fit: contain; margin: 0 auto; display: block;"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="text-align: center; color: var(--text-secondary); padding: 20px; display: none;">
              <div style="font-size: 2rem; margin-bottom: 8px;">üñºÔ∏è</div>
              <div>Image loading failed</div>
            </div>
          </div>
        `;
      } else {
        // Â¶ÇÊûúÊó¢Ê≤°ÊúâËßÜÈ¢ë‰πüÊ≤°ÊúâÂõæÁâáÔºåÊòæÁ§∫ÊèêÁ§∫
        previewHTML += `
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
            <div style="font-size: 2rem; margin-bottom: 8px;">üìπ</div>
            <div>This template has no preview content yet</div>
          </div>
        `;
      }
      
      previewContent.innerHTML = previewHTML;
    }
    
    // ÈöêËóèÊ®°ÊùøÈ¢ÑËßà
    function hideTemplatePreview() {
      const previewSection = document.getElementById('templatePreviewSection');
      if (previewSection) {
        previewSection.style.display = 'none';
      }
    }
    
    // Ê∏≤ÊüìËØ≠Èü≥Âç°ÁâáÔºàÁΩëÊ†ºÂ∏ÉÂ±ÄÔºâ
    function renderVoices(voices, filterText = '') {
      const voiceGrid = document.getElementById('voiceGrid');
      const voiceLoadingState = document.getElementById('voiceLoadingState');
      
      if (!voiceGrid) {
        console.warn('Cannot find voiceGrid container');
        return;
      }
      
      // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
      if (voiceLoadingState) {
        voiceLoadingState.style.display = 'none';
      }
      
      // ËøáÊª§ËØ≠Èü≥
      let filteredVoices = voices;
      if (filterText && filterText.trim()) {
        const searchLower = filterText.toLowerCase().trim();
        filteredVoices = voices.filter(voice => {
          const name = (voice.name || voice.voice_id || '').toLowerCase();
          const language = (voice.language || '').toLowerCase();
          const gender = voice.gender === 'female' ? 'Â•≥' : voice.gender === 'male' ? 'Áî∑' : '';
          const voiceId = (voice.voice_id || '').toLowerCase();
          
          return name.includes(searchLower) || 
                 language.includes(searchLower) || 
                 gender.includes(searchLower) ||
                 voiceId.includes(searchLower);
        });
      }
      
      // Ê∏ÖÁ©∫ÂÆπÂô®
      voiceGrid.innerHTML = '';
      
      if (filteredVoices.length === 0) {
        voiceGrid.innerHTML = `
          <div style="text-align: center; color: var(--text-secondary); padding: 40px; grid-column: 1 / -1;">
            <div style="font-size: 2rem; margin-bottom: 12px;">üîç</div>
            <div style="font-size: 0.9rem; margin-bottom: 8px;">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑËØ≠Èü≥</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary); opacity: 0.7;">ËØ∑Â∞ùËØïÂÖ∂‰ªñÊêúÁ¥¢ÂÖ≥ÈîÆËØç</div>
          </div>
        `;
        return;
      }
      
      // Ê∏≤ÊüìËØ≠Èü≥Âç°Áâá
      filteredVoices.forEach((voice, index) => {
        const voiceId = voice.voice_id || voice.id || `voice_${index}`;
        const voiceName = voice.name || voiceId;
        const language = voice.language || 'Êú™Áü•';
        const gender = voice.gender || 'unknown';
        const genderIcon = gender === 'female' ? 'üë©' : gender === 'male' ? 'üë®' : 'üë§';
        const genderText = gender === 'female' ? 'Â•≥Â£∞' : gender === 'male' ? 'Áî∑Â£∞' : 'Êú™Áü•';
        
        const voiceItem = document.createElement('div');
        voiceItem.className = 'voice-template-item';
        voiceItem.setAttribute('data-voice-id', voiceId);
        voiceItem.style.cssText = 'background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.3s; text-align: center;';
        voiceItem.onclick = () => {
          selectVoice(voiceId, voice);
        };
        
        voiceItem.innerHTML = `
          <div style="font-size: 2.5rem; margin-bottom: 12px;">${genderIcon}</div>
          <div style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${voiceName}">
            ${voiceName}
          </div>
          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
            üåê ${language}
          </div>
          <div style="font-size: 0.85rem; color: var(--text-secondary);">
            ${genderText}
          </div>
        `;
        
        voiceGrid.appendChild(voiceItem);
      });
      
      // Ê∑ªÂä†Ê†∑ÂºèÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÔºâ
      if (!document.getElementById('voiceTemplateStyles')) {
        const style = document.createElement('style');
        style.id = 'voiceTemplateStyles';
        style.textContent = `
          .voice-template-item:hover {
            border-color: var(--primary) !important;
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(24, 144, 255, 0.2);
          }
          .voice-template-item.selected {
            border-color: var(--primary) !important;
            background: rgba(24, 144, 255, 0.1) !important;
            box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.2);
          }
        `;
        document.head.appendChild(style);
      }
      
      // Â¶ÇÊûú‰πãÂâçÊúâÈÄâ‰∏≠ÁöÑËØ≠Èü≥ÔºåÊÅ¢Â§çÈÄâ‰∏≠Áä∂ÊÄÅ
      if (selectedVoiceId) {
        const selectedItem = voiceGrid.querySelector(`[data-voice-id="${selectedVoiceId}"]`);
        if (selectedItem) {
          selectedItem.classList.add('selected');
        }
      }
    }
    
    // ÈÄâÊã©ËØ≠Èü≥
    function selectVoice(voiceId, voiceData = null) {
      // ÁßªÈô§‰πãÂâçÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
      document.querySelectorAll('.voice-template-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Ê∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
      const selectedItem = document.querySelector(`[data-voice-id="${voiceId}"]`);
      if (selectedItem) {
        selectedItem.classList.add('selected');
      }
      
      // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑËØ≠Èü≥ID
      selectedVoiceId = voiceId;
      
      // Êõ¥Êñ∞ÈöêËóèÁöÑselectÂÖÉÁ¥†ÔºàÂêëÂêéÂÖºÂÆπÔºâ
      const voiceSelect = document.getElementById('voiceSelect');
      if (voiceSelect) {
        voiceSelect.value = voiceId;
      }
      
      console.log('Selected voice:', voiceId, voiceData);
    }
    
    // ËøáÊª§ËØ≠Èü≥ÔºàÊêúÁ¥¢ÂäüËÉΩÔºâ
    function filterVoices() {
      const searchInput = document.getElementById('voiceSearchInput');
      const searchText = searchInput ? searchInput.value : '';
      
      if (heygenVoicesCache && Array.isArray(heygenVoicesCache)) {
        renderVoices(heygenVoicesCache, searchText);
      }
    }
    
    // Ëé∑Âèñ HeyGen ËØ≠Èü≥ÂàóË°®ÔºàÊîØÊåÅ‰∏çÂêå‰∏ä‰∏ãÊñáÔºâ
    async function loadHeyGenVoices(context = 'create') {
      const apiKey = getHeyGenApiKey();
      
      if (!apiKey) {
        alert('Please configure and test HeyGen API Key first\n\nTip: Please return to Step 1, fill in the correct API Key and click "Test Connection".');
        return;
      }
      
      // Ê†πÊçÆ‰∏ä‰∏ãÊñáÈÄâÊã©‰∏ãÊãâÊ°Ü
      let voiceSelectId;
      if (context === 'create') {
        voiceSelectId = 'voiceSelect';
      } else if (context === 'recite') {
        voiceSelectId = 'reciteVoiceSelect';
      } else if (context === 'promote') {
        voiceSelectId = 'promoteVoiceSelect';
      } else {
        console.warn('Unknown context:', context);
        return;
      }
      
      const voiceSelect = document.getElementById(voiceSelectId);
      if (!voiceSelect) {
        console.warn('Cannot find voice selection dropdown:', voiceSelectId);
        return;
      }
      
      // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      const originalHtml = voiceSelect.innerHTML;
      voiceSelect.innerHTML = '<option value="">‚è≥ Getting voice list...</option>';
      voiceSelect.disabled = true;
      
      // Êõ¥Êñ∞Âà∑Êñ∞ÊåâÈíÆÁä∂ÊÄÅÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
      const refreshVoiceBtn = document.getElementById('refreshVoiceBtn');
      const refreshVoiceIcon = document.getElementById('refreshVoiceIcon');
      const refreshVoiceText = document.getElementById('refreshVoiceText');
      if (refreshVoiceBtn) {
        refreshVoiceBtn.classList.add('loading');
        refreshVoiceBtn.disabled = true;
        if (refreshVoiceIcon) refreshVoiceIcon.innerHTML = '<span class="loading-spinner">üîÑ</span>';
        if (refreshVoiceText) refreshVoiceText.textContent = 'Loading...';
      }
      
      try {
        const response = await fetch(`/api/heygen/voices?apiKey=${encodeURIComponent(apiKey)}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const contentType = response.headers.get('content-type') || '';
        let result;
        
        if (contentType.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error('ÊúçÂä°Âô®ËøîÂõûÈùûJSONÂìçÂ∫î:', text.substring(0, 200));
          throw new Error('Server returned a non-JSON response');
        }
        
        if (result.success && result.voices && result.voices.length > 0) {
          // ÁºìÂ≠òËØ≠Èü≥ÂàóË°®
          heygenVoicesCache = result.voices;
          
          // Êõ¥Êñ∞ËØ≠Èü≥ÈÄâÊã©‰∏ãÊãâÊ°ÜÔºàÂêëÂêéÂÖºÂÆπÔºâ
          voiceSelect.innerHTML = '<option value="">ÈªòËÆ§ËØ≠Èü≥ÔºàËá™Âä®ÈÄâÊã©Ôºâ</option>';
          
          result.voices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.voice_id;
            let displayName = voice.name || voice.voice_id;
            if (voice.language) {
              displayName += ` (${voice.language})`;
            }
            if (voice.gender) {
              displayName += ` - ${voice.gender === 'female' ? 'Â•≥Â£∞' : voice.gender === 'male' ? 'Áî∑Â£∞' : voice.gender}`;
            }
            option.textContent = displayName;
            voiceSelect.appendChild(option);
          });
          
          // Â¶ÇÊûúÊòØcreate‰∏ä‰∏ãÊñáÔºå‰ΩøÁî®ÁΩëÊ†ºÂ∏ÉÂ±ÄÊ∏≤Êüì
          if (context === 'create') {
            const searchInput = document.getElementById('voiceSearchInput');
            const searchText = searchInput ? searchInput.value : '';
            renderVoices(result.voices, searchText);
          }
          
          // ‰øùÂ≠òÂà∞ localStorage
          localStorage.setItem('intl_heygen_voices', JSON.stringify(result.voices));
          localStorage.setItem('intl_heygen_voices_update_time', new Date().toISOString());
          
          console.log('Loaded voice list:', result.voices.length, 'voices');
          
          // ÊÅ¢Â§çÂà∑Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
          const refreshVoiceBtn = document.getElementById('refreshVoiceBtn');
          const refreshVoiceIcon = document.getElementById('refreshVoiceIcon');
          const refreshVoiceText = document.getElementById('refreshVoiceText');
          if (refreshVoiceBtn) {
            refreshVoiceBtn.classList.remove('loading');
            refreshVoiceBtn.disabled = false;
            if (refreshVoiceIcon) refreshVoiceIcon.textContent = 'üîÑ';
            if (refreshVoiceText) refreshVoiceText.textContent = 'Refresh Voices';
          }
          
          voiceSelect.disabled = false;
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâËé∑ÂèñÂà∞ËØ≠Èü≥ÂàóË°®ÔºåÊÅ¢Â§çÈªòËÆ§ÈÄâÈ°π
          voiceSelect.innerHTML = originalHtml;
          voiceSelect.disabled = false;
          
          // ÊÅ¢Â§çÂà∑Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
          const refreshVoiceBtn = document.getElementById('refreshVoiceBtn');
          const refreshVoiceIcon = document.getElementById('refreshVoiceIcon');
          const refreshVoiceText = document.getElementById('refreshVoiceText');
          if (refreshVoiceBtn) {
            refreshVoiceBtn.classList.remove('loading');
            refreshVoiceBtn.disabled = false;
            if (refreshVoiceIcon) refreshVoiceIcon.textContent = 'üîÑ';
            if (refreshVoiceText) refreshVoiceText.textContent = 'Refresh Voices';
          }
          
          if (context === 'create') {
            const warningMsg = document.createElement('div');
            warningMsg.id = 'voiceLoadWarningMsg';
            warningMsg.style.cssText = 'background: rgba(250, 173, 20, 0.1); border: 1px solid var(--warning); border-radius: 8px; padding: 8px 12px; margin-bottom: 8px; font-size: 0.85rem; color: var(--warning); text-align: center;';
            warningMsg.textContent = `‚ö†Ô∏è Unable to get voice list: ${result.message || 'Unknown error'}, will use default voice`;
            const existingMsg = document.getElementById('voiceLoadWarningMsg');
            if (existingMsg) existingMsg.remove();
            voiceSelect.parentElement.insertBefore(warningMsg, voiceSelect);
            setTimeout(() => {
              if (warningMsg && warningMsg.parentElement) {
                warningMsg.style.transition = 'opacity 0.3s';
                warningMsg.style.opacity = '0';
                setTimeout(() => warningMsg.remove(), 300);
              }
            }, 5000);
          }
        }
      } catch (error) {
        console.error('Get voice list error:', error);
        
        // ÊÅ¢Â§çÈªòËÆ§ÈÄâÈ°π
        voiceSelect.innerHTML = originalHtml;
        voiceSelect.disabled = false;
        
        // ÊÅ¢Â§çÂà∑Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        const refreshVoiceBtn = document.getElementById('refreshVoiceBtn');
        const refreshVoiceIcon = document.getElementById('refreshVoiceIcon');
        const refreshVoiceText = document.getElementById('refreshVoiceText');
        if (refreshVoiceBtn) {
          refreshVoiceBtn.classList.remove('loading');
          refreshVoiceBtn.disabled = false;
          if (refreshVoiceIcon) refreshVoiceIcon.textContent = 'üîÑ';
          if (refreshVoiceText) refreshVoiceText.textContent = 'Âà∑Êñ∞ËØ≠Èü≥';
        }
        
        if (context === 'create') {
          // ÊòæÁ§∫ÈîôËØØÊèêÁ§∫Ôºà‰∏çÂºπÁ™óÔºâ
          const errorMsg = document.createElement('div');
          errorMsg.id = 'voiceLoadErrorMsg';
          errorMsg.style.cssText = 'background: rgba(255, 77, 79, 0.1); border: 1px solid var(--danger); border-radius: 8px; padding: 8px 12px; margin-bottom: 8px; font-size: 0.85rem; color: var(--danger); text-align: center;';
          errorMsg.textContent = `‚ùå Failed to get voice list: ${error.message || 'Unknown error'}`;
          
          const existingMsg = document.getElementById('voiceLoadErrorMsg');
          if (existingMsg) existingMsg.remove();
          voiceSelect.parentElement.insertBefore(errorMsg, voiceSelect);
          
          setTimeout(() => {
            if (errorMsg && errorMsg.parentElement) {
              errorMsg.style.transition = 'opacity 0.3s';
              errorMsg.style.opacity = '0';
              setTimeout(() => errorMsg.remove(), 300);
            }
          }, 5000);
        }
      }
    }
    
    // Âä†ËΩΩÂéÜÂè≤
    function loadHistory() {
      const history = JSON.parse(localStorage.getItem('intl_dh_history') || '[]');
      const container = document.getElementById('historyList');
      
      // Â¶ÇÊûúÂÆπÂô®‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû
      if (!container) {
        console.warn('Cannot find historyList container, skipping history loading');
        return;
      }
      
      if (history.length === 0) {
        container.innerHTML = '<div class="empty-history">No generation records yet</div>';
        return;
      }
      
      const platformNames = {
        heygen: 'HeyGen'
      };
      
      container.innerHTML = history.map(item => `
        <div class="history-item">
          <div class="history-header">
            <span class="history-avatar">${item.avatar}</span>
            <div class="history-meta">
              <div class="history-platform">${platformNames[item.platform] || item.platform}</div>
              <div class="history-date">${new Date(item.createDate).toLocaleString()}</div>
            </div>
          </div>
          <div class="history-script">${item.script}</div>
          <div class="history-actions">
            <button class="history-btn" onclick="deleteHistory('${item.id}')">üóëÔ∏è Delete</button>
          </div>
        </div>
      `).join('');
    }
    
    // Âà†Èô§ÂéÜÂè≤
    function deleteHistory(id) {
      if (!confirm('Are you sure you want to delete this record?')) return;
      
      let history = JSON.parse(localStorage.getItem('intl_dh_history') || '[]');
      history = history.filter(h => h.id != id);
      localStorage.setItem('intl_dh_history', JSON.stringify(history));
      loadHistory();
    }
    
    // Âä†ËΩΩÈÖçÁΩÆ
    function loadConfigs() {
      // HeyGen
      const heygenApiKey = localStorage.getItem('intl_heygen_api_key');
      if (heygenApiKey) {
        const inputEl = document.getElementById('heygenApiKey');
        if (inputEl) inputEl.value = heygenApiKey;
      }
      
      // Âä†ËΩΩÁºìÂ≠òÁöÑËØ≠Èü≥ÂàóË°®
      loadCachedVoices();
    }
    
    // Âä†ËΩΩÁºìÂ≠òÁöÑËØ≠Èü≥ÂàóË°®
    function loadCachedVoices() {
      try {
        const cachedVoices = localStorage.getItem('intl_heygen_voices');
        if (cachedVoices) {
          const voices = JSON.parse(cachedVoices);
          heygenVoicesCache = voices; // ÁºìÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè
          
          const voiceSelect = document.getElementById('voiceSelect');
          
          if (voiceSelect && Array.isArray(voices) && voices.length > 0) {
            voiceSelect.innerHTML = '<option value="">ÈªòËÆ§ËØ≠Èü≥ÔºàËá™Âä®ÈÄâÊã©Ôºâ</option>';
            
            voices.forEach(voice => {
              const option = document.createElement('option');
              option.value = voice.voice_id;
              let displayName = voice.name || voice.voice_id;
              if (voice.language) {
                displayName += ` (${voice.language})`;
              }
              if (voice.gender) {
                displayName += ` - ${voice.gender === 'female' ? 'Â•≥Â£∞' : voice.gender === 'male' ? 'Áî∑Â£∞' : voice.gender}`;
              }
              option.textContent = displayName;
              voiceSelect.appendChild(option);
            });
            
            // Ê∏≤ÊüìËØ≠Èü≥Âç°Áâá
            const searchInput = document.getElementById('voiceSearchInput');
            const searchText = searchInput ? searchInput.value : '';
            renderVoices(voices, searchText);
            
            console.log('Loaded cached voice list:', voices.length, 'voices');
          }
        }
      } catch (error) {
        console.warn('Failed to load cached voice list:', error);
      }
    }
    
    // ÊòæÁ§∫Áä∂ÊÄÅ
    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = 'api-status ' + type;
      el.textContent = message;
      el.style.display = 'block';
    }
    
    // ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩ
    function showLoading(show, text) {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      
      if (show) {
        overlay.classList.remove('hidden');
        loadingText.textContent = text || 'Â§ÑÁêÜ‰∏≠...';
      } else {
        overlay.classList.add('hidden');
      }
    }
    
    // ========== ÂΩïÂà∂ÂäüËÉΩ ==========
    
    // ÂàáÊç¢ËßÜÈ¢ëÂΩïÂà∂
    async function toggleVideoRecording() {
      if (isRecordingVideo) {
        stopVideoRecording();
      } else {
        await startVideoRecording();
      }
    }
    
    // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
    function checkMediaSupport() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Your browser does not support camera/microphone access.\n\nPlease use a modern browser (Chrome, Firefox, Edge, Safari)');
        return false;
      }
      return true;
    }
    
    // ÂºÄÂßãËßÜÈ¢ëÂΩïÂà∂
    async function startVideoRecording() {
      if (!checkMediaSupport()) {
        return;
      }
      
      const recordBtn = document.getElementById('recordVideoBtn');
      if (recordBtn) {
        recordBtn.disabled = true;
        recordBtn.querySelector('.record-text').textContent = 'Requesting permission...';
      }
      
      try {
        // ÂÖàÂÅúÊ≠¢‰πãÂâçÁöÑÊµÅÔºàÂ¶ÇÊûúÊúâÔºâ
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
          videoStream = null;
        }
        
        // ËØ∑Ê±ÇÊëÑÂÉèÂ§¥ÂíåÈ∫¶ÂÖãÈ£éÊùÉÈôê
        let constraints = {
          video: {
            facingMode: { ideal: 'user' }
          },
          audio: true
        };
        
        // Â∞ùËØïËØ∑Ê±ÇÊùÉÈôê
        try {
          videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (constraintError) {
          console.warn('Failed to use ideal constraints, trying basic constraints:', constraintError);
          constraints = {
            video: true,
            audio: true
          };
          videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        }
        
        if (!videoStream || videoStream.getVideoTracks().length === 0) {
          throw new Error('Unable to get video stream');
        }
        
        const videoRecordPreview = document.getElementById('videoRecordPreview');
        const recordedVideo = document.getElementById('recordedVideo');
        
        if (!videoRecordPreview || !recordedVideo) {
          throw new Error('Cannot find preview element');
        }
        
        // ÊòæÁ§∫È¢ÑËßàÂå∫Âüü
        videoRecordPreview.style.display = 'block';
        
        // ÂàõÂª∫ÊàñËé∑ÂèñÈ¢ÑËßàËßÜÈ¢ëÂÖÉÁ¥†
        let previewVideo = videoRecordPreview.querySelector('.preview-live-video');
        if (!previewVideo) {
          previewVideo = document.createElement('video');
          previewVideo.className = 'preview-live-video';
          previewVideo.autoplay = true;
          previewVideo.muted = true;
          previewVideo.playsInline = true;
          previewVideo.style.cssText = 'max-width: 100%; max-height: 200px; border-radius: 8px; background: #000;';
          videoRecordPreview.insertBefore(previewVideo, videoRecordPreview.firstChild);
        }
        
        // ËÆæÁΩÆËßÜÈ¢ëÊµÅ
        previewVideo.srcObject = videoStream;
        
        // Á≠âÂæÖËßÜÈ¢ëÂÖÉÊï∞ÊçÆÂä†ËΩΩ
        await new Promise((resolve, reject) => {
          previewVideo.onloadedmetadata = () => {
            resolve();
          };
          previewVideo.onerror = (e) => {
            reject(new Error('ËßÜÈ¢ëÈ¢ÑËßàÂä†ËΩΩÂ§±Ë¥•'));
          };
          setTimeout(() => {
            if (previewVideo.readyState >= 2) {
              resolve();
            } else {
              reject(new Error('ËßÜÈ¢ëÂä†ËΩΩË∂ÖÊó∂'));
            }
          }, 3000);
        });
        
        // ÈöêËóèÂ∑≤ÂΩïÂà∂ÁöÑËßÜÈ¢ëÔºàÂ¶ÇÊûúÊúâÔºâ
        if (recordedVideo.src) {
          recordedVideo.style.display = 'none';
        }
        
        // ÂºÄÂßãÂΩïÂà∂
        const chunks = [];
        
        // Ê£ÄÊµãÊîØÊåÅÁöÑ MIME Á±ªÂûã
        let mimeType = '';
        const supportedTypes = [
          'video/webm;codecs=vp9,opus',
          'video/webm;codecs=vp8,opus',
          'video/webm;codecs=h264,opus',
          'video/webm',
          'video/mp4'
        ];
        
        for (const type of supportedTypes) {
          if (MediaRecorder.isTypeSupported(type)) {
            mimeType = type;
            break;
          }
        }
        
        if (!mimeType) {
          console.warn('No supported MIME type found, using default');
        }
        
        // ÂàõÂª∫ MediaRecorder
        const options = mimeType ? { mimeType: mimeType } : {};
        
        // ËÆæÁΩÆÂΩïÂà∂ÈÄâÈ°π
        if (mimeType.includes('webm')) {
          options.videoBitsPerSecond = 2500000;
        }
        
        videoRecorder = new MediaRecorder(videoStream, options);
        
        // Â§ÑÁêÜÊï∞ÊçÆÂèØÁî®‰∫ã‰ª∂
        videoRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            chunks.push(e.data);
          }
        };
        
        // Â§ÑÁêÜÂÅúÊ≠¢‰∫ã‰ª∂
        videoRecorder.onstop = () => {
          if (chunks.length === 0) {
            alert('Recording failed: No data recorded');
            return;
          }
          
          recordedVideoBlob = new Blob(chunks, { type: mimeType || 'video/webm' });
          
          // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©Âíå‰∏ä‰º†ÁöÑÊñá‰ª∂Ôºà‰∫íÊñ•ÈÄªËæëÔºâ
          clearTemplateSelection();
          clearUploadedFiles();
          
          if (recordedVideoBlob.size === 0) {
            alert('Recording failed: Video file is empty');
            return;
          }
          
          const url = URL.createObjectURL(recordedVideoBlob);
          recordedVideo.src = url;
          recordedVideo.style.display = 'block';
          
          currentVideoUrl = url;
          
          const previewVideo = videoRecordPreview.querySelector('.preview-live-video');
          if (previewVideo) {
            previewVideo.srcObject = null;
            previewVideo.remove();
          }
          
          if (videoStream) {
            videoStream.getTracks().forEach(track => {
              track.stop();
            });
            videoStream = null;
          }
        };
        
        // ÂºÄÂßãÂΩïÂà∂
        videoRecorder.start(100);
        
        isRecordingVideo = true;
        if (recordBtn) {
          recordBtn.disabled = false;
          recordBtn.classList.add('recording');
          recordBtn.querySelector('.record-text').textContent = 'Stop Recording';
        }
        
        // ÊòæÁ§∫ÂΩïÂà∂Áä∂ÊÄÅ
        startRecordTimer();
        
      } catch (error) {
        console.error('Record video failed:', error);
        
        const recordBtn = document.getElementById('recordVideoBtn');
        if (recordBtn) {
          recordBtn.disabled = false;
          recordBtn.querySelector('.record-text').textContent = 'Record Video';
        }
        
        alert('Recording failed: ' + error.message);
      }
    }
    
    // ÂÅúÊ≠¢ËßÜÈ¢ëÂΩïÂà∂
    function stopVideoRecording() {
      if (videoRecorder && isRecordingVideo) {
        try {
          if (videoRecorder.state === 'recording') {
            videoRecorder.stop();
          }
          
          isRecordingVideo = false;
          
          const recordBtn = document.getElementById('recordVideoBtn');
          if (recordBtn) {
            recordBtn.classList.remove('recording');
            recordBtn.disabled = false;
            recordBtn.querySelector('.record-text').textContent = 'Record Video';
          }
          
          stopRecordTimer();
        } catch (error) {
          console.error('Error stopping recording:', error);
        }
      }
    }
    
    // Êí≠ÊîæÂΩïÂà∂ÁöÑËßÜÈ¢ë
    function playRecordedVideo() {
      const recordedVideo = document.getElementById('recordedVideo');
      if (recordedVideo.src) {
        recordedVideo.play();
      }
    }
    
    // Âà†Èô§ÂΩïÂà∂ÁöÑËßÜÈ¢ë
    function removeRecordedVideo() {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ÂΩïÂà∂ÁöÑËßÜÈ¢ëÂêóÔºü')) return;
      
      const videoRecordPreview = document.getElementById('videoRecordPreview');
      const recordedVideo = document.getElementById('recordedVideo');
      
      if (recordedVideo && recordedVideo.src) {
        URL.revokeObjectURL(recordedVideo.src);
        recordedVideo.src = '';
      }
      
      recordedVideoBlob = null;
      
      if (videoRecordPreview) {
        videoRecordPreview.style.display = 'none';
      }
    }
    
    // ÂàáÊç¢Èü≥È¢ëÂΩïÂà∂
    async function toggleAudioRecording() {
      if (isRecordingAudio) {
        stopAudioRecording();
      } else {
        await startAudioRecording();
      }
    }
    
    // ÂºÄÂßãÈü≥È¢ëÂΩïÂà∂
    async function startAudioRecording() {
      if (!checkMediaSupport()) {
        return;
      }
      
      const recordBtn = document.getElementById('recordAudioBtn');
      if (recordBtn) {
        recordBtn.disabled = true;
        recordBtn.querySelector('.record-text').textContent = 'Requesting permission...';
      }
      
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });
        
        if (recordBtn) {
          recordBtn.disabled = false;
        }
        
        const audioRecordPreview = document.getElementById('audioRecordPreview');
        const recordedAudio = document.getElementById('recordedAudio');
        
        // ÂºÄÂßãÂΩïÂà∂
        const chunks = [];
        const mimeType = MediaRecorder.isTypeSupported('audio/webm')
          ? 'audio/webm'
          : MediaRecorder.isTypeSupported('audio/mp4')
          ? 'audio/mp4'
          : '';
        
        audioRecorder = new MediaRecorder(audioStream, {
          mimeType: mimeType || undefined
        });
        
        audioRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) chunks.push(e.data);
        };
        
        audioRecorder.onstop = () => {
          recordedAudioBlob = new Blob(chunks, { type: mimeType || 'audio/webm' });
          
          // Ê∏ÖÈô§Ê®°ÊùøÈÄâÊã©Âíå‰∏ä‰º†ÁöÑÊñá‰ª∂Ôºà‰∫íÊñ•ÈÄªËæëÔºâ
          clearTemplateSelection();
          clearUploadedFiles();
          
          const url = URL.createObjectURL(recordedAudioBlob);
          recordedAudio.src = url;
          
          if (audioStream) {
            audioStream.getTracks().forEach(track => track.stop());
            audioStream = null;
          }
          
          audioRecordPreview.style.display = 'block';
        };
        
        audioRecorder.start();
        isRecordingAudio = true;
        recordBtn.classList.add('recording');
        recordBtn.querySelector('.record-text').textContent = 'ÂÅúÊ≠¢ÂΩïÂà∂';
        
        // ÊòæÁ§∫ÂΩïÂà∂Áä∂ÊÄÅ
        startRecordTimer();
        
      } catch (error) {
        console.error('Record audio failed:', error);
        
        const recordBtn = document.getElementById('recordAudioBtn');
        if (recordBtn) {
          recordBtn.disabled = false;
          recordBtn.querySelector('.record-text').textContent = 'Record Audio';
        }
        
        alert('Recording failed: ' + error.message);
      }
    }
    
    // ÂÅúÊ≠¢Èü≥È¢ëÂΩïÂà∂
    function stopAudioRecording() {
      if (audioRecorder && isRecordingAudio) {
        audioRecorder.stop();
        isRecordingAudio = false;
        
        const recordBtn = document.getElementById('recordAudioBtn');
        recordBtn.classList.remove('recording');
        recordBtn.querySelector('.record-text').textContent = 'Record Audio';
        
        stopRecordTimer();
      }
    }
    
    // Êí≠ÊîæÂΩïÂà∂ÁöÑÈü≥È¢ë
    function playRecordedAudio() {
      const recordedAudio = document.getElementById('recordedAudio');
      if (recordedAudio.src) {
        recordedAudio.play();
      }
    }
    
    // Âà†Èô§ÂΩïÂà∂ÁöÑÈü≥È¢ë
    function removeRecordedAudio() {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ÂΩïÂà∂ÁöÑÈü≥È¢ëÂêóÔºü')) return;
      
      const audioRecordPreview = document.getElementById('audioRecordPreview');
      const recordedAudio = document.getElementById('recordedAudio');
      
      if (recordedAudio && recordedAudio.src) {
        URL.revokeObjectURL(recordedAudio.src);
        recordedAudio.src = '';
      }
      
      recordedAudioBlob = null;
      
      if (audioRecordPreview) {
        audioRecordPreview.style.display = 'none';
      }
    }
    
    // ÂºÄÂßãÂΩïÂà∂ËÆ°Êó∂Âô®
    function startRecordTimer() {
      recordStartTime = Date.now();
      const recordStatus = document.getElementById('recordStatus');
      const recordTime = document.getElementById('recordTime');
      
      recordStatus.style.display = 'flex';
      
      recordTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - recordStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        recordTime.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }, 1000);
    }
    
    // ÂÅúÊ≠¢ÂΩïÂà∂ËÆ°Êó∂Âô®
    function stopRecordTimer() {
      if (recordTimer) {
        clearInterval(recordTimer);
        recordTimer = null;
      }
      
      const recordStatus = document.getElementById('recordStatus');
      recordStatus.style.display = 'none';
    }
    
    // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
    window.addEventListener('beforeunload', () => {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
      }
      stopRecordTimer();
    });
    
    function goBack() {
      var url = (typeof window.DIGITAL_HUMAN_BACK_URL !== 'undefined' && window.DIGITAL_HUMAN_BACK_URL) || (document.body && document.body.getAttribute('data-back-url')) || 'page.html?page=my-digital-worker';
      window.location.href = url;
    }
    
    // ========== ËØµËØªÊñáÊ°àÂäüËÉΩ ==========
    
    // Êõ¥Êñ∞ËØµËØªÊñáÊ°àÂ≠óÊï∞ÁªüËÆ°
    function updateReciteCharCount() {
      const text = document.getElementById('reciteScript')?.value || '';
      const count = text.length;
      const countEl = document.getElementById('reciteCharCount');
      if (countEl) {
        countEl.textContent = count;
        countEl.style.color = count > 1000 ? 'var(--danger)' : 'var(--text-secondary)';
      }
    }
    
    // È¢ÑËßàËØµËØªÊñáÊ°àËØ≠Èü≥
    async function previewReciteScript() {
      const script = document.getElementById('reciteScript')?.value.trim();
      if (!script) {
        alert('Please enter script content first');
        return;
      }
      alert('Voice preview function under development...\n\nTip: You can directly generate video to see the effect.');
    }
    
    // ÂàõÂª∫ËØµËØªÊñáÊ°àËßÜÈ¢ë
    async function createReciteVideo() {
      const script = document.getElementById('reciteScript')?.value.trim();
      const apiKey = getHeyGenApiKey();
      
      if (!apiKey) {
        alert('Please configure HeyGen API Key first\n\nTip: Please return to the "Create Digital Human" page and configure API Key in Step 1.');
        return;
      }
      
      if (!script) {
        alert('Please enter script content');
        return;
      }
      
      if (script.length > 1000) {
        alert('Script content is too long, please keep it within 1000 characters');
        return;
      }
      
      showLoading(true, 'Ê≠£Âú®ÁîüÊàêËØµËØªËßÜÈ¢ë...');
      
      try {
        const voiceSelect = document.getElementById('reciteVoiceSelect');
        const voiceId = voiceSelect && voiceSelect.value ? voiceSelect.value : null;
        
        const response = await fetch(buildApiUrl('/api/heygen/video'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            apiKey,
            avatarId: selectedAvatarForRecite || null,
            text: script,
            voiceId: voiceId
          })
        });
        
        const contentType = response.headers.get('content-type') || '';
        let result;
        
        if (contentType.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error('ÊúçÂä°Âô®ËøîÂõûÈùûJSONÂìçÂ∫î:', text.substring(0, 200));
          throw new Error('Server returned a non-JSON response');
        }
        
        if (!result.success) {
          showLoading(false);
          alert('‚ùå Creation failed: ' + result.message);
          return;
        }
        
        const taskId = result.data?.video_id || result.data?.id || null;
        if (!taskId) {
          showLoading(false);
          alert('‚ùå Creation failed: Task ID (video_id) not returned, cannot query status.');
          return;
        }
        
        const workId = Date.now().toString();
        
        const work = {
          id: workId,
          type: 'recite',
          title: script.substring(0, 50) + (script.length > 50 ? '...' : ''),
          script: script,
          platform: 'heygen',
          taskId: taskId,
          status: 'processing',
          progress: 0,
          videoUrl: null,
          avatarId: selectedAvatarForRecite,
          voiceId: voiceId,
          createDate: new Date().toISOString(),
          updateDate: new Date().toISOString()
        };
        
        const works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
        works.unshift(work);
        if (works.length > 100) works.length = 100;
        localStorage.setItem('intl_dh_works', JSON.stringify(works));
        
        showLoading(false);
        alert('‚úÖ Script recitation video task submitted!\n\nThe task is being processed in the background. You can check the progress in "Works Management".');
        
        // Ê∏ÖÁ©∫Ë°®Âçï
        document.getElementById('reciteScript').value = '';
        updateReciteCharCount();
        
        // ÂºÄÂßãËΩÆËØ¢
        startReciteTaskPolling(workId, taskId, apiKey);
        loadReciteHistory();
        
      } catch (error) {
        console.error('Create script recitation video error:', error);
        showLoading(false);
        alert('‚ùå Creation failed: ' + error.message);
      }
    }
    
    // ËØµËØª‰ªªÂä°ËΩÆËØ¢
    function startReciteTaskPolling(workId, taskId, apiKey) {
      if (taskPollingIntervals.has(workId)) {
        clearInterval(taskPollingIntervals.get(workId));
      }
      
      let pollCount = 0;
      const maxPolls = 300;
      
      const pollInterval = setInterval(async () => {
        pollCount++;
        
        if (pollCount > maxPolls) {
          clearInterval(pollInterval);
          taskPollingIntervals.delete(workId);
          updateReciteWorkStatus(workId, 'failed', 0, null, '‰ªªÂä°Ë∂ÖÊó∂');
          return;
        }
        
        try {
          const response = await fetch(`/api/heygen/task/${taskId}?apiKey=${encodeURIComponent(apiKey)}`);
          const contentType = response.headers.get('content-type') || '';
          let result;
          
          if (contentType.includes('application/json')) {
            result = await response.json();
          } else {
            return;
          }
          
          if (result.success) {
            const status = result.status;
            const progress = result.progress || 0;
            const videoUrl = result.videoUrl || result.data?.video_url;
            const error = result.error;
            
            updateReciteWorkStatus(workId, status, progress, videoUrl, error);
            
            if (status === 'completed' || status === 'failed') {
              clearInterval(pollInterval);
              taskPollingIntervals.delete(workId);
            }
          }
        } catch (error) {
          console.error('Poll recitation task status error:', error);
        }
      }, 10000); // ÊØè10ÁßíÊü•ËØ¢‰∏ÄÊ¨°
      
      taskPollingIntervals.set(workId, pollInterval);
    }
    
    // Êõ¥Êñ∞ËØµËØª‰ΩúÂìÅÁä∂ÊÄÅ
    function updateReciteWorkStatus(workId, status, progress, videoUrl, error) {
      const works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
      const index = works.findIndex(w => w.id === workId);
      
      if (index !== -1) {
        works[index].status = status === 'completed' ? 'ready' : status;
        works[index].progress = progress;
        works[index].updateDate = new Date().toISOString();
        
        if (videoUrl) {
          works[index].videoUrl = videoUrl;
        }
        
        if (error) {
          works[index].error = error;
        }
        
        localStorage.setItem('intl_dh_works', JSON.stringify(works));
        
        if (document.getElementById('recitePanel') && !document.getElementById('recitePanel').classList.contains('hidden')) {
          loadReciteHistory();
        }
      }
    }
    
    // Âä†ËΩΩËØµËØªÂéÜÂè≤
    function loadReciteHistory() {
      const works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
      const reciteWorks = works.filter(w => w.type === 'recite');
      const container = document.getElementById('reciteHistoryList');
      
      if (!container) return;
      
      if (reciteWorks.length === 0) {
        container.innerHTML = '<div class="empty-history">No script recitation works yet</div>';
        return;
      }
      
      container.innerHTML = reciteWorks.map(work => {
        const statusBadge = work.status === 'ready' 
          ? '<span style="background: var(--success); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">Completed</span>'
          : work.status === 'failed'
          ? '<span style="background: var(--danger); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">Failed</span>'
          : '<span style="background: var(--warning); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">Processing ' + (work.progress || 0) + '%</span>';
        
        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-avatar">üìñ</span>
              <div class="history-meta">
                ${statusBadge}
                <div class="history-date">${new Date(work.createDate).toLocaleString()}</div>
              </div>
            </div>
            <div class="history-script">${work.title}</div>
            <div class="history-actions">
              ${work.videoUrl ? `<button class="history-btn" onclick="playWork('${work.id}')">‚ñ∂Ô∏è Play</button>` : ''}
              ${work.videoUrl ? `<button class="history-btn" onclick="downloadWork('${work.id}')">üì• Download</button>` : ''}
              <button class="history-btn" onclick="deleteReciteWork('${work.id}')">üóëÔ∏è Delete</button>
              ${work.status === 'processing' ? `<button class="history-btn" onclick="refreshReciteWork('${work.id}')">üîÑ Refresh</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Âà†Èô§ËØµËØª‰ΩúÂìÅ
    function deleteReciteWork(id) {
      if (!confirm('Are you sure you want to delete this work?')) return;
      let works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
      works = works.filter(w => w.id !== id);
      localStorage.setItem('intl_dh_works', JSON.stringify(works));
      loadReciteHistory();
    }
    
    // Âà∑Êñ∞ËØµËØª‰ΩúÂìÅÁä∂ÊÄÅ
    async function refreshReciteWork(id) {
      const works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
      const work = works.find(w => w.id === id);
      
      if (!work || !work.taskId) return;
      
      const apiKey = getHeyGenApiKey();
      if (!apiKey) return;
      
      try {
        const response = await fetch(`/api/heygen/task/${work.taskId}?apiKey=${encodeURIComponent(apiKey)}`);
        const result = await response.json();
        
        if (result.success) {
          updateReciteWorkStatus(id, result.status, result.progress, result.videoUrl, result.error);
          loadReciteHistory();
        }
      } catch (error) {
        console.error('Refresh work status error:', error);
      }
    }
    
    // ========== ÂçñË¥ßÊé®ÈÄÅÂäüËÉΩ ==========
    
    // Êõ¥Êñ∞ÂçñË¥ßÊé®ÈÄÅÂ≠óÊï∞ÁªüËÆ°
    function updatePromoteCharCount() {
      const text = document.getElementById('promoteProductDesc')?.value || '';
      const count = text.length;
      const countEl = document.getElementById('promoteCharCount');
      if (countEl) {
        countEl.textContent = count;
        countEl.style.color = count > 500 ? 'var(--danger)' : 'var(--text-secondary)';
      }
    }
    
    // Â§ÑÁêÜÂïÜÂìÅÂõæÁâá‰∏ä‰º†ÔºàÂçñË¥ßÊé®ÈÄÅÔºâ
    let promoteProductImageBase64 = null;
    
    function handleProductImageUpload(input, context) {
      if (context !== 'promote') return;
      
      const file = input.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        alert('Please select image file');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = () => {
        promoteProductImageBase64 = reader.result;
        const preview = document.getElementById('promoteImagePreview');
        const previewImg = document.getElementById('promoteImagePreviewImg');
        
        if (preview && previewImg) {
          previewImg.src = promoteProductImageBase64;
          preview.style.display = 'block';
        }
      };
      reader.readAsDataURL(file);
    }
    
    function handleProductImageDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const input = document.getElementById('promoteImageInput');
        if (input) {
          input.files = files;
          handleProductImageUpload(input, 'promote');
        }
      }
    }
    
    function removeProductImage(context) {
      if (context === 'promote') {
        promoteProductImageBase64 = null;
        const preview = document.getElementById('promoteImagePreview');
        if (preview) preview.style.display = 'none';
        const input = document.getElementById('promoteImageInput');
        if (input) input.value = '';
      }
    }
    
    // ÂàõÂª∫ÂçñË¥ßÊé®ÈÄÅËßÜÈ¢ë
    async function createPromoteVideo() {
      const productName = document.getElementById('promoteProductName')?.value.trim();
      const productDesc = document.getElementById('promoteProductDesc')?.value.trim();
      const apiKey = getHeyGenApiKey();
      
      if (!apiKey) {
        alert('Please configure HeyGen API Key first\n\nTip: Please return to the "Create Digital Human" page and configure API Key in Step 1.');
        return;
      }
      
      if (!productName) {
        alert('Please enter product name');
        return;
      }
      
      if (!productDesc) {
        alert('Please enter product description');
        return;
      }
      
      if (productDesc.length > 500) {
        alert('Product description is too long, please keep it within 500 characters');
        return;
      }
      
      showLoading(true, 'Ê≠£Âú®ÁîüÊàêÊé®ÂπøËßÜÈ¢ë...');
      
      try {
        const voiceSelect = document.getElementById('promoteVoiceSelect');
        const voiceId = voiceSelect && voiceSelect.value ? voiceSelect.value : null;
        
        // ÊûÑÂª∫Êé®ÂπøÊñáÊ°à
        const script = `Â§ßÂÆ∂Â•ΩÔºå‰ªäÂ§©‰∏∫Â§ßÂÆ∂Êé®Ëçê‰∏ÄÊ¨æ${productName}„ÄÇ${productDesc}„ÄÇÊÑüÂÖ¥Ë∂£ÁöÑÊúãÂèã‰∏çË¶ÅÈîôËøáÔºÅ`;
        
        const response = await fetch(buildApiUrl('/api/heygen/video'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            apiKey,
            avatarId: selectedAvatarForPromote || null,
            text: script,
            voiceId: voiceId,
            imageUrl: promoteProductImageBase64, // ÂïÜÂìÅÂõæÁâá
            productName: productName,
            productDesc: productDesc
          })
        });
        
        const contentType = response.headers.get('content-type') || '';
        let result;
        
        if (contentType.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error('ÊúçÂä°Âô®ËøîÂõûÈùûJSONÂìçÂ∫î:', text.substring(0, 200));
          throw new Error('Server returned a non-JSON response');
        }
        
        if (!result.success) {
          showLoading(false);
          alert('‚ùå Creation failed: ' + result.message);
          return;
        }
        
        const taskId = result.data?.video_id || result.data?.id || null;
        if (!taskId) {
          showLoading(false);
          alert('‚ùå Creation failed: Task ID (video_id) not returned, cannot query status.');
          return;
        }
        
        const workId = Date.now().toString();
        
        const work = {
          id: workId,
          type: 'product',
          productName: productName,
          title: productName,
          script: script,
          platform: 'heygen',
          taskId: taskId,
          status: 'processing',
          progress: 0,
          videoUrl: null,
          avatarId: selectedAvatarForPromote,
          voiceId: voiceId,
          imageUrl: promoteProductImageBase64,
          createDate: new Date().toISOString(),
          updateDate: new Date().toISOString()
        };
        
        const works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
        works.unshift(work);
        if (works.length > 100) works.length = 100;
        localStorage.setItem('intl_dh_works', JSON.stringify(works));
        
        showLoading(false);
        alert('‚úÖ Promotion video task submitted!\n\nThe task is being processed in the background. You can check the progress in "Works Management".');
        
        // Ê∏ÖÁ©∫Ë°®Âçï
        document.getElementById('promoteProductName').value = '';
        document.getElementById('promoteProductDesc').value = '';
        removeProductImage('promote');
        updatePromoteCharCount();
        
        // ÂºÄÂßãËΩÆËØ¢
        startPromoteTaskPolling(workId, taskId, apiKey);
        loadPromoteHistory();
        
      } catch (error) {
        console.error('Create promotion video error:', error);
        showLoading(false);
        alert('‚ùå Creation failed: ' + error.message);
      }
    }
    
    // Êé®Âπø‰ªªÂä°ËΩÆËØ¢
    function startPromoteTaskPolling(workId, taskId, apiKey) {
      if (taskPollingIntervals.has(workId)) {
        clearInterval(taskPollingIntervals.get(workId));
      }
      
      let pollCount = 0;
      const maxPolls = 300;
      
      const pollInterval = setInterval(async () => {
        pollCount++;
        
        if (pollCount > maxPolls) {
          clearInterval(pollInterval);
          taskPollingIntervals.delete(workId);
          updatePromoteWorkStatus(workId, 'failed', 0, null, '‰ªªÂä°Ë∂ÖÊó∂');
          return;
        }
        
        try {
          const response = await fetch(`/api/heygen/task/${taskId}?apiKey=${encodeURIComponent(apiKey)}`);
          const contentType = response.headers.get('content-type') || '';
          let result;
          
          if (contentType.includes('application/json')) {
            result = await response.json();
          } else {
            return;
          }
          
          if (result.success) {
            const status = result.status;
            const progress = result.progress || 0;
            const videoUrl = result.videoUrl || result.data?.video_url;
            const error = result.error;
            
            updatePromoteWorkStatus(workId, status, progress, videoUrl, error);
            
            if (status === 'completed' || status === 'failed') {
              clearInterval(pollInterval);
              taskPollingIntervals.delete(workId);
            }
          }
        } catch (error) {
          console.error('Poll promotion task status error:', error);
        }
      }, 10000); // ÊØè10ÁßíÊü•ËØ¢‰∏ÄÊ¨°
      
      taskPollingIntervals.set(workId, pollInterval);
    }
    
    // Êõ¥Êñ∞Êé®Âπø‰ΩúÂìÅÁä∂ÊÄÅ
    function updatePromoteWorkStatus(workId, status, progress, videoUrl, error) {
      const works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
      const index = works.findIndex(w => w.id === workId);
      
      if (index !== -1) {
        works[index].status = status === 'completed' ? 'ready' : status;
        works[index].progress = progress;
        works[index].updateDate = new Date().toISOString();
        
        if (videoUrl) {
          works[index].videoUrl = videoUrl;
        }
        
        if (error) {
          works[index].error = error;
        }
        
        localStorage.setItem('intl_dh_works', JSON.stringify(works));
        
        if (document.getElementById('promotePanel') && !document.getElementById('promotePanel').classList.contains('hidden')) {
          loadPromoteHistory();
        }
      }
    }
    
    // Âä†ËΩΩÊé®ÂπøÂéÜÂè≤
    function loadPromoteHistory() {
      const works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
      const promoteWorks = works.filter(w => w.type === 'product');
      const container = document.getElementById('promoteHistoryList');
      
      if (!container) return;
      
      if (promoteWorks.length === 0) {
        container.innerHTML = '<div class="empty-history">No promotion works yet</div>';
        return;
      }
      
      container.innerHTML = promoteWorks.map(work => {
        const statusBadge = work.status === 'ready' 
          ? '<span style="background: var(--success); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">Completed</span>'
          : work.status === 'failed'
          ? '<span style="background: var(--danger); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">Failed</span>'
          : '<span style="background: var(--warning); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">Processing ' + (work.progress || 0) + '%</span>';
        
        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-avatar">üõí</span>
              <div class="history-meta">
                ${statusBadge}
                <div class="history-date">${new Date(work.createDate).toLocaleString()}</div>
              </div>
            </div>
            <div class="history-script">${work.productName || work.title}</div>
            <div class="history-actions">
              ${work.videoUrl ? `<button class="history-btn" onclick="playWork('${work.id}')">‚ñ∂Ô∏è Play</button>` : ''}
              ${work.videoUrl ? `<button class="history-btn" onclick="downloadWork('${work.id}')">üì• Download</button>` : ''}
              <button class="history-btn" onclick="deletePromoteWork('${work.id}')">üóëÔ∏è Delete</button>
              ${work.status === 'processing' ? `<button class="history-btn" onclick="refreshPromoteWork('${work.id}')">üîÑ Refresh</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Âà†Èô§Êé®Âπø‰ΩúÂìÅ
    function deletePromoteWork(id) {
      if (!confirm('Are you sure you want to delete this work?')) return;
      let works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
      works = works.filter(w => w.id !== id);
      localStorage.setItem('intl_dh_works', JSON.stringify(works));
      loadPromoteHistory();
    }
    
    // Âà∑Êñ∞Êé®Âπø‰ΩúÂìÅÁä∂ÊÄÅ
    async function refreshPromoteWork(id) {
      const works = JSON.parse(localStorage.getItem('intl_dh_works') || '[]');
      const work = works.find(w => w.id === id);
      
      if (!work || !work.taskId) return;
      
      const apiKey = getHeyGenApiKey();
      if (!apiKey) return;
      
      try {
        const response = await fetch(`/api/heygen/task/${work.taskId}?apiKey=${encodeURIComponent(apiKey)}`);
        const result = await response.json();
        
        if (result.success) {
          updatePromoteWorkStatus(id, result.status, result.progress, result.videoUrl, result.error);
          loadPromoteHistory();
        }
      } catch (error) {
        console.error('Refresh work status error:', error);
      }
    }
    
    // ========== Èù¢ÊùøÂä†ËΩΩÂáΩÊï∞ ==========
    
    function loadRecitePanel() {
      loadReciteHistory();
      // Â¶ÇÊûúËøòÊ≤°ÊúâÂä†ËΩΩ avatarÔºåËá™Âä®Âä†ËΩΩ
      const container = document.getElementById('reciteAvatarSelector');
      if (container && container.children.length === 1 && container.querySelector('div').textContent.includes('Loading')) {
        loadHeyGenAvatars('recite');
      }
      // Âä†ËΩΩÁºìÂ≠òÁöÑËØ≠Èü≥ÂàóË°®
      loadCachedVoicesForContext('recite');
      // ÁªëÂÆöÂ≠óÊï∞ÁªüËÆ°
      const scriptInput = document.getElementById('reciteScript');
      if (scriptInput) {
        scriptInput.addEventListener('input', updateReciteCharCount);
        updateReciteCharCount();
      }
    }
    
    function loadPromotePanel() {
      loadPromoteHistory();
      // Â¶ÇÊûúËøòÊ≤°ÊúâÂä†ËΩΩ avatarÔºåËá™Âä®Âä†ËΩΩ
      const container = document.getElementById('promoteAvatarSelector');
      if (container && container.children.length === 1 && container.querySelector('div').textContent.includes('Loading')) {
        loadHeyGenAvatars('promote');
      }
      // Âä†ËΩΩÁºìÂ≠òÁöÑËØ≠Èü≥ÂàóË°®
      loadCachedVoicesForContext('promote');
      // ÁªëÂÆöÂ≠óÊï∞ÁªüËÆ°
      const descInput = document.getElementById('promoteProductDesc');
      if (descInput) {
        descInput.addEventListener('input', updatePromoteCharCount);
        updatePromoteCharCount();
      }
    }
    
    // ‰∏∫‰∏çÂêå‰∏ä‰∏ãÊñáÂä†ËΩΩÁºìÂ≠òÁöÑËØ≠Èü≥ÂàóË°®
    function loadCachedVoicesForContext(context) {
      try {
        const cachedVoices = localStorage.getItem('intl_heygen_voices');
        if (cachedVoices) {
          const voices = JSON.parse(cachedVoices);
          let voiceSelectId;
          if (context === 'recite') {
            voiceSelectId = 'reciteVoiceSelect';
          } else if (context === 'promote') {
            voiceSelectId = 'promoteVoiceSelect';
          } else {
            return;
          }
          
          const voiceSelect = document.getElementById(voiceSelectId);
          if (voiceSelect && Array.isArray(voices) && voices.length > 0) {
            voiceSelect.innerHTML = '<option value="">ÈªòËÆ§ËØ≠Èü≥ÔºàËá™Âä®ÈÄâÊã©Ôºâ</option>';
            
            voices.forEach(voice => {
              const option = document.createElement('option');
              option.value = voice.voice_id;
              let displayName = voice.name || voice.voice_id;
              if (voice.language) {
                displayName += ` (${voice.language})`;
              }
              if (voice.gender) {
                displayName += ` - ${voice.gender === 'female' ? 'Â•≥Â£∞' : voice.gender === 'male' ? 'Áî∑Â£∞' : voice.gender}`;
              }
              option.textContent = displayName;
              voiceSelect.appendChild(option);
            });
          }
        }
      } catch (error) {
        console.warn('Failed to load cached voice list:', error);
      }
    }
    
    // ÂàùÂßãÂåñ
    init();
  </script>
</body>
</html>