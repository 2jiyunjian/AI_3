<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½ä½“å¯¹è¯</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #1890ff;
      --primary-dark: #096dd9;
      --primary-light: #40a9ff;
      --secondary: #722ed1;
      --success: #52c41a;
      --warning: #faad14;
      --danger: #ff4d4f;
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --bg-hover: #1a1a24;
      --text-primary: #ffffff;
      --text-secondary: #8c8c8c;
      --border-color: #2a2a3a;
    }

    body {
      font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
      background: var(--bg-dark);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
    }

    /* é¡¶éƒ¨å¯¼èˆª */
    .chat-header {
      height: 64px;
      background: linear-gradient(180deg, rgba(18, 18, 26, 0.98) 0%, rgba(18, 18, 26, 0.95) 100%);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 24px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }

    .back-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      margin-right: 16px;
    }

    .back-btn:hover {
      background: var(--bg-hover);
      border-color: var(--primary);
    }

    .agent-info {
      display: flex;
      align-items: center;
      gap: 14px;
      flex: 1;
    }

    .agent-avatar {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
    }

    .agent-details h1 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .agent-status {
      font-size: 0.8rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(82, 196, 26, 0.4); }
      50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(82, 196, 26, 0); }
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .header-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-secondary);
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .header-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    /* ä¸»ä½“åŒºåŸŸ */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      padding-top: 64px;
    }

    /* æ¶ˆæ¯åŒºåŸŸ */
    .messages-area {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* æ¬¢è¿åŒºåŸŸ */
    .welcome-section {
      text-align: center;
      padding: 60px 20px;
      animation: fadeInUp 0.6s ease;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .welcome-avatar {
      width: 80px;
      height: 80px;
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      margin: 0 auto 20px;
      box-shadow: 0 8px 30px rgba(24, 144, 255, 0.3);
    }

    .welcome-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .welcome-desc {
      color: var(--text-secondary);
      font-size: 0.95rem;
      max-width: 500px;
      margin: 0 auto 32px;
      line-height: 1.6;
    }

    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      max-width: 600px;
      margin: 0 auto;
    }

    .suggestion-btn {
      padding: 12px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .suggestion-btn:hover {
      background: var(--bg-hover);
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    /* æ¶ˆæ¯æ ·å¼ */
    .message {
      display: flex;
      gap: 14px;
      animation: messageIn 0.3s ease;
      max-width: 85%;
    }

    @keyframes messageIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      flex-direction: row-reverse;
      margin-left: auto;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .message.assistant .message-avatar {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #52c41a, #73d13d);
    }

    .message-content {
      flex: 1;
    }

    .message-bubble {
      padding: 14px 18px;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.7;
      word-break: break-word;
    }

    .message.assistant .message-bubble {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-top-left-radius: 4px;
    }

    .message.user .message-bubble {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-top-right-radius: 4px;
    }

    .message-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 6px;
      padding: 0 4px;
    }

    .message.user .message-time {
      text-align: right;
    }

    /* ä»£ç å—æ ·å¼ */
    .message-bubble pre {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 14px;
      overflow-x: auto;
      margin: 10px 0;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85rem;
      border: 1px solid var(--border-color);
    }

    .message-bubble code {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9em;
    }

    .message-bubble pre code {
      background: transparent;
      padding: 0;
    }

    /* æ‰“å­—åŠ¨ç”» */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 0;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-8px); opacity: 1; }
    }

    /* è¾“å…¥åŒºåŸŸ */
    .input-area {
      padding: 16px 24px 24px;
      background: linear-gradient(180deg, transparent 0%, var(--bg-dark) 20%);
      position: sticky;
      bottom: 0;
    }

    .input-container {
      max-width: 800px;
      margin: 0 auto;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 8px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      transition: border-color 0.2s ease;
    }

    .input-container:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1);
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .chat-input {
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 0.95rem;
      font-family: inherit;
      resize: none;
      min-height: 24px;
      max-height: 150px;
      line-height: 1.5;
    }

    .chat-input:focus {
      outline: none;
    }

    .chat-input::placeholder {
      color: var(--text-secondary);
    }

    .send-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 12px;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(24, 144, 255, 0.4);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .input-hint {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 10px;
    }

    .input-hint kbd {
      background: var(--bg-card);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      font-size: 0.75rem;
    }

    /* é”™è¯¯æç¤º */
    .error-message {
      background: rgba(255, 77, 79, 0.1);
      border: 1px solid rgba(255, 77, 79, 0.3);
      border-radius: 12px;
      padding: 18px 20px;
      color: #ff7875;
      max-width: 500px;
      margin: 0 auto;
    }

    .error-message .error-header {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .error-message .error-icon {
      font-size: 1.3rem;
    }

    .error-message .error-content {
      font-size: 0.9rem;
      line-height: 1.7;
      white-space: pre-line;
      color: #ffa39e;
    }

    .error-message .error-action {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255, 77, 79, 0.2);
    }

    .error-message .error-btn {
      padding: 8px 16px;
      background: rgba(255, 77, 79, 0.2);
      border: 1px solid rgba(255, 77, 79, 0.4);
      border-radius: 8px;
      color: #ff7875;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .error-message .error-btn:hover {
      background: rgba(255, 77, 79, 0.3);
    }

    /* æ¸…ç©ºå¯¹è¯å¼¹çª— */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .modal-content {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .modal-btn.cancel {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .modal-btn.cancel:hover {
      background: var(--bg-hover);
    }

    .modal-btn.confirm {
      background: var(--danger);
      border: none;
      color: white;
    }

    .modal-btn.confirm:hover {
      opacity: 0.9;
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .chat-header {
        padding: 0 16px;
      }

      .messages-area {
        padding: 16px;
      }

      .input-area {
        padding: 12px 16px 16px;
      }

      .message {
        max-width: 90%;
      }

      .suggestions {
        flex-direction: column;
      }

      .suggestion-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="chat-header">
    <button class="back-btn" onclick="goBack()" title="è¿”å›">â†</button>
    <div class="agent-info">
      <div class="agent-avatar" id="agentAvatar">ğŸ¤–</div>
      <div class="agent-details">
        <h1 id="agentName">AI åŠ©æ‰‹</h1>
        <div class="agent-status">
          <span class="status-dot"></span>
          <span id="agentPlatform">åœ¨çº¿</span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button class="header-btn" onclick="showClearModal()" title="æ¸…ç©ºå¯¹è¯">ğŸ—‘ï¸</button>
      <button class="header-btn" onclick="goToSettings()" title="è®¾ç½®">âš™ï¸</button>
    </div>
  </header>

  <!-- ä¸»ä½“ -->
  <main class="chat-container">
    <div class="messages-area" id="messagesArea">
      <!-- æ¬¢è¿åŒºåŸŸ -->
      <div class="welcome-section" id="welcomeSection">
        <div class="welcome-avatar" id="welcomeAvatar">ğŸ¤–</div>
        <h2 class="welcome-title" id="welcomeTitle">ä¸ AI åŠ©æ‰‹ å¼€å§‹å¯¹è¯</h2>
        <p class="welcome-desc" id="welcomeDesc">
          æˆ‘å¯ä»¥å¸®åŠ©ä½ å›ç­”é—®é¢˜ã€å†™ä½œã€ç¼–ç¨‹ã€åˆ†ææ•°æ®ç­‰ã€‚è¯•è¯•ä¸‹é¢çš„é—®é¢˜å¼€å§‹å¯¹è¯å§ï¼
        </p>
        <div class="suggestions" id="suggestions">
          <button class="suggestion-btn" onclick="sendSuggestion('ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±')">ğŸ‘‹ ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±</button>
          <button class="suggestion-btn" onclick="sendSuggestion('ä½ èƒ½å¸®æˆ‘åšä»€ä¹ˆï¼Ÿ')">ğŸ¤” ä½ èƒ½å¸®æˆ‘åšä»€ä¹ˆï¼Ÿ</button>
          <button class="suggestion-btn" onclick="sendSuggestion('å†™ä¸€æ®µPythonä»£ç ç¤ºä¾‹')">ğŸ’» å†™ä¸€æ®µä»£ç ç¤ºä¾‹</button>
          <button class="suggestion-btn" onclick="sendSuggestion('å¸®æˆ‘å†™ä¸€ç¯‡æ–‡ç« å¤§çº²')">ğŸ“ å¸®æˆ‘å†™æ–‡ç« å¤§çº²</button>
        </div>
      </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-area">
      <div class="input-container">
        <div class="input-wrapper">
          <textarea 
            class="chat-input" 
            id="chatInput" 
            placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." 
            rows="1"
            onkeydown="handleKeydown(event)"
            oninput="autoResize(this)"
          ></textarea>
        </div>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="å‘é€">
          â¤
        </button>
      </div>
      <div class="input-hint">
        æŒ‰ <kbd>Enter</kbd> å‘é€ï¼Œ<kbd>Shift + Enter</kbd> æ¢è¡Œ
      </div>
    </div>
  </main>

  <!-- æ¸…ç©ºå¯¹è¯å¼¹çª— -->
  <div class="modal-overlay" id="clearModal">
    <div class="modal">
      <div class="modal-title">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</div>
      <div class="modal-content">
        ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="hideClearModal()">å–æ¶ˆ</button>
        <button class="modal-btn confirm" onclick="clearAllMessages()">ç¡®å®šæ¸…ç©º</button>
      </div>
    </div>
  </div>

  <script>
    // ========== API é…ç½® ==========
    function getApiBaseUrl() {
      // ä¼˜å…ˆä» localStorage è¯»å–é…ç½®
      try {
        const customBaseUrl = localStorage.getItem('api_base_url');
        if (customBaseUrl && customBaseUrl.trim()) {
          // å¦‚æœæ˜ç¡®è®¾ç½®äº†api_base_urlï¼Œä½¿ç”¨è¯¥å€¼ï¼ˆå…è®¸localhostï¼‰
          return customBaseUrl.trim().replace(/\/+$/, '');
        }
      } catch (e) {
        console.warn('æ— æ³•è¯»å– api_base_url é…ç½®:', e);
      }
      
      // æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°
      const useLocal = localStorage.getItem('use_local') === 'true';
      const currentOrigin = window.location.origin;
      const isLocalhost = currentOrigin.includes('localhost') || currentOrigin.includes('127.0.0.1');
      
      if (useLocal || isLocalhost) {
        // æœ¬åœ°ç¯å¢ƒï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œè¿™æ ·ä¼šä½¿ç”¨å½“å‰åŸŸåå’Œç«¯å£
        return '';
      }
      
      // çº¿ä¸Šç¯å¢ƒï¼šä½¿ç”¨å½“å‰é¡µé¢çš„origin
      return currentOrigin;
    }

    function buildApiUrl(path) {
      const baseUrl = getApiBaseUrl();
      const normalizedPath = path.startsWith('/') ? path : '/' + path;
      return baseUrl + normalizedPath;
    }
    // å…¨å±€å˜é‡
    let currentAgent = null;
    let messages = [];
    let isResponding = false;
    let digitalHumanContext = null;  // æ•°å­—äººä¸Šä¸‹æ–‡

    // åˆå§‹åŒ–
    function init() {
      try {
        console.log('Chat init started...');
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user) {
          window.location.href = '/';
          return;
        }

        // è·å–æ™ºèƒ½ä½“ID
        const params = new URLSearchParams(window.location.search);
        const agentId = params.get('id');
        const agentType = params.get('type') || 'created';
        const dhId = params.get('dh');  // æ•°å­—äººID

        console.log('Agent ID:', agentId, 'Type:', agentType, 'Digital Human:', dhId);

        if (!agentId) {
          alert('æœªæ‰¾åˆ°æ™ºèƒ½ä½“ä¿¡æ¯');
          goBack();
          return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°å­—äººä¸Šä¸‹æ–‡
        if (dhId) {
          const dhContextStr = sessionStorage.getItem('digitalHumanContext');
          if (dhContextStr) {
            try {
              digitalHumanContext = JSON.parse(dhContextStr);
              console.log('Digital Human context loaded:', digitalHumanContext);
            } catch (e) {
              console.warn('Failed to parse digital human context');
            }
          }
          
          // å¦‚æœæ²¡æœ‰ä» sessionStorage è·å–åˆ°ï¼Œå°è¯•ä» localStorage è·å–
          if (!digitalHumanContext) {
            const humans = JSON.parse(localStorage.getItem('digitalHumans') || '[]');
            const human = humans.find(h => h.id === dhId);
            if (human && human.persona) {
              digitalHumanContext = {
                id: human.id,
                name: human.name,
                persona: human.persona
              };
            }
          }
        }

        // åŠ è½½æ™ºèƒ½ä½“ä¿¡æ¯
        loadAgent(agentId, agentType);
        
        // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®
        resetUIState();
        
      } catch (error) {
        console.error('Init error:', error);
        alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
      }
    }
    
    // é‡ç½®UIçŠ¶æ€
    function resetUIState() {
      isResponding = false;
      const sendBtn = document.getElementById('sendBtn');
      if (sendBtn) {
        sendBtn.disabled = false;
      }
      const input = document.getElementById('chatInput');
      if (input) {
        input.disabled = false;
      }
    }

    // åŠ è½½æ™ºèƒ½ä½“
    function loadAgent(agentId, agentType) {
      try {
        let agents;
        if (agentType === 'created') {
          agents = JSON.parse(localStorage.getItem('createdAgents') || '[]');
        } else {
          agents = JSON.parse(localStorage.getItem('purchasedAgents') || '[]');
        }

        console.log('Found agents:', agents.length);
        currentAgent = agents.find(a => a.id === agentId);

        if (!currentAgent) {
          console.error('Agent not found:', agentId);
          alert('æœªæ‰¾åˆ°æ™ºèƒ½ä½“ä¿¡æ¯ï¼Œå¯èƒ½å·²è¢«åˆ é™¤');
          goBack();
          return;
        }

        console.log('Loaded agent:', currentAgent.name, 'Platform:', currentAgent.platform);

        // è®¾ç½®platformIdï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
        if (!currentAgent.platformId) {
          currentAgent.platformId = getPlatformIdFromName(currentAgent.platform);
        }
        currentAgent.type = agentType;

        // æ›´æ–°é¡µé¢ä¿¡æ¯
        updateAgentInfo();

        // åŠ è½½å†å²æ¶ˆæ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
        try {
          messages = Array.isArray(currentAgent.chatHistory) ? currentAgent.chatHistory : [];
          // è¿‡æ»¤æ— æ•ˆæ¶ˆæ¯
          messages = messages.filter(m => m && m.role && m.content);
          console.log('Loaded messages:', messages.length);
        } catch (e) {
          console.error('Error loading chat history:', e);
          messages = [];
        }
        
        if (messages.length > 0) {
          const welcomeSection = document.getElementById('welcomeSection');
          if (welcomeSection) welcomeSection.style.display = 'none';
          renderMessages();
        }

        // èšç„¦è¾“å…¥æ¡†
        setTimeout(() => {
          const input = document.getElementById('chatInput');
          if (input) input.focus();
        }, 100);
        
      } catch (error) {
        console.error('Load agent error:', error);
        alert('åŠ è½½æ™ºèƒ½ä½“å¤±è´¥: ' + error.message);
        goBack();
      }
    }

    // æ›´æ–°æ™ºèƒ½ä½“ä¿¡æ¯æ˜¾ç¤º
    function updateAgentInfo() {
      // å¦‚æœæœ‰æ•°å­—äººä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨æ•°å­—äººä¿¡æ¯
      const isDigitalHuman = digitalHumanContext && digitalHumanContext.persona;
      
      const icon = isDigitalHuman ? 'ğŸ¤–' : (currentAgent.customIcon || currentAgent.logo || 'ğŸ¤–');
      const bgStyle = isDigitalHuman 
        ? 'linear-gradient(135deg, #722ed1, #1890ff)'
        : `linear-gradient(135deg, ${currentAgent.color || '#1890ff'}, ${currentAgent.color || '#722ed1'}80)`;
      
      const displayName = isDigitalHuman ? digitalHumanContext.name : currentAgent.name;
      const displayPlatform = isDigitalHuman 
        ? `æ•°å­—äºº Â· ${currentAgent.platform}` 
        : `${currentAgent.platform} Â· åœ¨çº¿`;
      
      // å¤´éƒ¨æ™ºèƒ½ä½“ä¿¡æ¯
      const agentAvatar = document.getElementById('agentAvatar');
      const agentName = document.getElementById('agentName');
      const agentPlatform = document.getElementById('agentPlatform');
      
      if (agentAvatar) {
        agentAvatar.textContent = icon;
        agentAvatar.style.background = bgStyle;
      }
      if (agentName) agentName.textContent = displayName;
      if (agentPlatform) agentPlatform.textContent = displayPlatform;

      // æ¬¢è¿åŒºåŸŸä¿¡æ¯
      const welcomeAvatar = document.getElementById('welcomeAvatar');
      const welcomeTitle = document.getElementById('welcomeTitle');
      const welcomeDesc = document.getElementById('welcomeDesc');
      
      if (welcomeAvatar) {
        welcomeAvatar.textContent = icon;
        welcomeAvatar.style.background = bgStyle;
      }
      
      if (isDigitalHuman) {
        if (welcomeTitle) welcomeTitle.textContent = `ä¸æ•°å­—äºº ${digitalHumanContext.name} å¯¹è¯`;
        if (welcomeDesc) welcomeDesc.textContent = digitalHumanContext.persona.greeting || 'ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ï¼';
      } else {
        if (welcomeTitle) welcomeTitle.textContent = `ä¸ ${currentAgent.name} å¼€å§‹å¯¹è¯`;
        if (welcomeDesc) welcomeDesc.textContent = currentAgent.desc || 'æˆ‘å¯ä»¥å¸®åŠ©ä½ å›ç­”é—®é¢˜ã€å†™ä½œã€ç¼–ç¨‹ç­‰ã€‚å¼€å§‹å¯¹è¯å§ï¼';
      }

      document.title = isDigitalHuman 
        ? `${digitalHumanContext.name} - æ•°å­—äººå¯¹è¯`
        : `${currentAgent.name} - æ™ºèƒ½ä½“å¯¹è¯`;
    }
    
    // è·å–æ•°å­—äººçš„ç³»ç»Ÿæç¤ºè¯
    function getDigitalHumanSystemPrompt() {
      if (!digitalHumanContext || !digitalHumanContext.persona) {
        return null;
      }
      
      const p = digitalHumanContext.persona;
      const expertise = p.expertise ? p.expertise.join('ã€') : 'å¤šä¸ªé¢†åŸŸ';
      
      return `ä½ æ˜¯ä¸€ä¸ªåå«"${digitalHumanContext.name}"çš„AIæ•°å­—äººã€‚

ã€äººè®¾ä¿¡æ¯ã€‘
- æ€§æ ¼ç‰¹ç‚¹: ${p.personality || 'çƒ­æƒ…å‹å¥½'}
- è¯´è¯é£æ ¼: ${p.voiceStyle || 'äº²åˆ‡è‡ªç„¶'}
- ä¸“é•¿é¢†åŸŸ: ${expertise}
- å£å¤´ç¦…: "${p.catchphrase || 'è®©æˆ‘æ¥å¸®ä½ '}"
- èƒŒæ™¯æ•…äº‹: ${p.background || 'æˆ‘æ˜¯ä¸€ä¸ªAIæ•°å­—äºº'}

ã€è¡Œä¸ºå‡†åˆ™ã€‘
1. å§‹ç»ˆä¿æŒäººè®¾ä¸€è‡´ï¼Œç”¨ç¬¦åˆæ€§æ ¼çš„æ–¹å¼å›ç­”
2. é€‚æ—¶ä½¿ç”¨å£å¤´ç¦…ï¼Œä½†ä¸è¦è¿‡äºé¢‘ç¹
3. åœ¨ä¸“é•¿é¢†åŸŸè¡¨ç°å‡ºè‡ªä¿¡å’Œä¸“ä¸š
4. è¯­æ°”è¦ç¬¦åˆè¯´è¯é£æ ¼çš„æè¿°
5. å›ç­”è¦æœ‰ä¸ªæ€§ï¼Œä¸è¦å¤ªæœºæ¢°åŒ–

è¯·ç”¨è¿™ä¸ªäººè®¾ä¸ç”¨æˆ·å¯¹è¯ã€‚`;
    }

    // æ ¹æ®å¹³å°åç§°è·å–å¹³å°ID
    function getPlatformIdFromName(platformName) {
      const mapping = {
        'Groq (å…è´¹)': 'groq',
        'Groq': 'groq',
        'OpenAI': 'openai',
        'Claude': 'claude',
        'æ–‡å¿ƒä¸€è¨€': 'wenxin',
        'é€šä¹‰åƒé—®': 'qianwen',
        'Kimi': 'moonshot',
        'DeepSeek': 'deepseek',
        'è®¯é£æ˜Ÿç«': 'spark',
        'ChatGLM': 'glm',
        'æ™ºè°±AI/GLM': 'glm',
        'æ™ºè°±AI': 'glm',
        'Gemini': 'gemini'
      };
      return mapping[platformName] || 'openai';
    }

    // æ¸²æŸ“æ¶ˆæ¯
    function renderMessages() {
      const container = document.getElementById('messagesArea');
      
      let html = '';
      messages.forEach(msg => {
        html += createMessageHTML(msg);
      });

      container.innerHTML = html;
      scrollToBottom();
    }

    // åˆ›å»ºæ¶ˆæ¯HTML
    function createMessageHTML(msg) {
      const icon = msg.role === 'assistant' 
        ? (currentAgent.customIcon || currentAgent.logo || 'ğŸ¤–')
        : 'ğŸ‘¤';
      
      return `
        <div class="message ${msg.role}">
          <div class="message-avatar">${icon}</div>
          <div class="message-content">
            <div class="message-bubble">${formatContent(msg.content)}</div>
            <div class="message-time">${formatTime(msg.timestamp)}</div>
          </div>
        </div>
      `;
    }

    // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
    function formatContent(content) {
      if (!content) return '';
      
      // è½¬ä¹‰HTML
      let formatted = content
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // ä»£ç å—
      formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
        return `<pre><code>${code.trim()}</code></pre>`;
      });

      // è¡Œå†…ä»£ç 
      formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

      // ç²—ä½“
      formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

      // æ–œä½“
      formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');

      // æ¢è¡Œ
      formatted = formatted.replace(/\n/g, '<br>');

      return formatted;
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'åˆšåˆš';
      if (diff < 3600000) return `${Math.floor(diff / 60000)} åˆ†é’Ÿå‰`;
      if (date.toDateString() === now.toDateString()) {
        return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
      }
      return `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    // å‘é€å»ºè®®
    function sendSuggestion(text) {
      document.getElementById('chatInput').value = text;
      sendMessage();
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      try {
        const input = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        
        if (!input) {
          console.error('Input element not found');
          return;
        }
        
        const content = input.value.trim();

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘é€
        if (!content) {
          console.log('Empty message, skipping');
          return;
        }
        
        if (isResponding) {
          console.log('Already responding, skipping');
          return;
        }
        
        // æ£€æŸ¥æ™ºèƒ½ä½“æ˜¯å¦å·²åŠ è½½
        if (!currentAgent) {
          showError('æ™ºèƒ½ä½“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
          return;
        }

        // æ£€æŸ¥API Key
        const apiKey = getApiKey(currentAgent.platformId);
        console.log('Platform:', currentAgent.platformId, 'Has API Key:', !!apiKey);
        
        if (!apiKey) {
          showError(`æ­¤æ™ºèƒ½ä½“æœªé…ç½® API Key\n\nè¯·è¿”å›ç¼–è¾‘æ™ºèƒ½ä½“ï¼Œæ·»åŠ  ${currentAgent.platform} çš„ API Keyã€‚`, 'no_api_key');
          return;
        }

        // éšè—æ¬¢è¿åŒºåŸŸ
        const welcomeSection = document.getElementById('welcomeSection');
        if (welcomeSection) welcomeSection.style.display = 'none';

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        const userMsg = {
          role: 'user',
          content: content,
          timestamp: new Date().toISOString()
        };
        messages.push(userMsg);

        // æ¸…ç©ºè¾“å…¥
        input.value = '';
        input.style.height = 'auto';

        // æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯
        appendMessage(userMsg);
        
        // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ï¼ˆé˜²æ­¢åˆ·æ–°ä¸¢å¤±ï¼‰
        saveHistory();

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        isResponding = true;
        if (sendBtn) sendBtn.disabled = true;
        showTyping();

        console.log('Sending message to API...');

        // è·å–ç³»ç»Ÿæç¤ºè¯ï¼ˆæ•°å­—äººä¼˜å…ˆï¼‰
        const dhSystemPrompt = getDigitalHumanSystemPrompt();
        const systemPrompt = dhSystemPrompt || currentAgent.systemPrompt || `ä½ æ˜¯${currentAgent.name}ï¼Œä¸€ä¸ªåŸºäº${currentAgent.platform}çš„AIåŠ©æ‰‹ã€‚`;
        
        console.log('Using system prompt:', dhSystemPrompt ? 'Digital Human' : 'Agent');
        
        // è°ƒç”¨AIæ¥å£
        const response = await fetch(buildApiUrl('/api/ai/chat'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: currentAgent.platformId,
            apiKey: apiKey,
            messages: messages.filter(m => m.role !== 'system').map(m => ({
              role: m.role,
              content: m.content
            })),
            systemPrompt: systemPrompt,
            temperature: digitalHumanContext ? 0.8 : (currentAgent.temperature || 0.7),  // æ•°å­—äººä½¿ç”¨ç¨é«˜çš„æ¸©åº¦å¢åŠ ä¸ªæ€§
            maxTokens: parseInt(currentAgent.maxTokens) || 2048
          })
        });

        console.log('Response status:', response.status);
        
        // æ£€æŸ¥å“åº”çŠ¶æ€
        if (!response.ok) {
          console.error('HTTPé”™è¯¯çŠ¶æ€:', response.status, response.statusText);
        }
        
        let data;
        try {
          const responseText = await response.text();
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('JSONè§£æå¤±è´¥:', parseError);
            console.error('å“åº”å†…å®¹:', responseText.substring(0, 500));
            hideTyping();
            showError(`æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº” (HTTP ${response.status})\n\nå“åº”å†…å®¹: ${responseText.substring(0, 200)}`, 'parse_error');
            return;
          }
        } catch (textError) {
          console.error('è¯»å–å“åº”å¤±è´¥:', textError);
          hideTyping();
          showError('æ— æ³•è¯»å–æœåŠ¡å™¨å“åº”', 'network');
          return;
        }
        
        hideTyping();

        if (data.success) {
          const assistantMsg = {
            role: 'assistant',
            content: data.message,
            timestamp: new Date().toISOString()
          };
          messages.push(assistantMsg);
          appendMessage(assistantMsg);
          saveHistory();
          console.log('Message sent successfully');
        } else {
          console.error('API error:', {
            message: data.message,
            errorType: data.errorType,
            originalError: data.originalError,
            status: response.status
          });
          
          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæ˜¯å¼€å‘ç¯å¢ƒä¸”å­˜åœ¨åŸå§‹é”™è¯¯ï¼Œä¹Ÿæ˜¾ç¤º
          let errorMsg = data.message || 'è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';
          if (data.originalError && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
            errorMsg += `\n\n[è°ƒè¯•ä¿¡æ¯] ${data.originalError}`;
          }
          
          showError(errorMsg, data.errorType);
        }

      } catch (error) {
        console.error('Send message error:', error);
        hideTyping();
        showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'network');
      } finally {
        // ç¡®ä¿çŠ¶æ€è¢«é‡ç½®
        isResponding = false;
        const sendBtn = document.getElementById('sendBtn');
        const input = document.getElementById('chatInput');
        if (sendBtn) sendBtn.disabled = false;
        if (input) {
          input.disabled = false;
          input.focus();
        }
      }
    }

    // æ·»åŠ å•æ¡æ¶ˆæ¯
    function appendMessage(msg) {
      const container = document.getElementById('messagesArea');
      container.insertAdjacentHTML('beforeend', createMessageHTML(msg));
      scrollToBottom();
    }

    // æ˜¾ç¤ºæ‰“å­—åŠ¨ç”»
    function showTyping() {
      const container = document.getElementById('messagesArea');
      const icon = currentAgent.customIcon || currentAgent.logo || 'ğŸ¤–';
      const html = `
        <div class="message assistant" id="typingMessage">
          <div class="message-avatar">${icon}</div>
          <div class="message-content">
            <div class="message-bubble">
              <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
      scrollToBottom();
    }

    // éšè—æ‰“å­—åŠ¨ç”»
    function hideTyping() {
      const typing = document.getElementById('typingMessage');
      if (typing) typing.remove();
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message, errorType = 'unknown') {
      const container = document.getElementById('messagesArea');
      
      // åˆ¤æ–­é”™è¯¯ç±»å‹
      const isBalanceError = message.includes('ä½™é¢') || message.includes('balance') || message.includes('Insufficient') || errorType === 'balance';
      const isAuthError = message.includes('æ— æ•ˆ') || message.includes('Invalid') || message.includes('Authentication') || errorType === 'auth';
      const isNoApiKey = message.includes('æœªé…ç½®') || errorType === 'no_api_key';
      const isNetworkError = message.includes('ç½‘ç»œ') || message.includes('network') || message.includes('socket') || message.includes('timeout') || errorType === 'network';
      
      let actionBtn = '';
      if (isBalanceError) {
        actionBtn = `
          <div class="error-action">
            <button class="error-btn" onclick="window.open('https://platform.openai.com/account/billing', '_blank')">å‰å¾€OpenAIå……å€¼</button>
            <button class="error-btn" onclick="window.open('https://platform.deepseek.com/', '_blank')" style="margin-left: 8px;">å‰å¾€DeepSeek</button>
          </div>
        `;
      } else if (isNoApiKey) {
        actionBtn = `
          <div class="error-action">
            <button class="error-btn" onclick="goBack()">è¿”å›ç¼–è¾‘æ™ºèƒ½ä½“</button>
          </div>
        `;
      } else if (isAuthError) {
        // åˆ¤æ–­æ˜¯å¦æ˜¯ Groq
        const isGroq = currentAgent && (currentAgent.platform === 'Groq (å…è´¹)' || currentAgent.platform === 'Groq' || currentAgent.platformId === 'groq');
        const groqHint = isGroq ? '<br><small style="opacity: 0.8;">æç¤ºï¼šGroqçš„API Keyåº”ä»¥ gsk_ å¼€å¤´</small>' : '';
        actionBtn = `
          <div class="error-action">
            <button class="error-btn" onclick="goBack()">è¿”å›æ£€æŸ¥API Key</button>
            <button class="error-btn" onclick="window.open('https://console.groq.com/keys', '_blank')" style="margin-left: 8px;">è·å–Groq Key</button>
            ${groqHint}
          </div>
        `;
      } else if (isNetworkError) {
        actionBtn = `
          <div class="error-action">
            <button class="error-btn" onclick="retryLastMessage()">ğŸ”„ é‡è¯•</button>
            <button class="error-btn" onclick="location.reload()" style="margin-left: 8px;">åˆ·æ–°é¡µé¢</button>
          </div>
        `;
      } else {
        // é€šç”¨é”™è¯¯ï¼šæä¾›é‡è¯•æŒ‰é’®
        actionBtn = `
          <div class="error-action">
            <button class="error-btn" onclick="retryLastMessage()">ğŸ”„ é‡è¯•</button>
          </div>
        `;
      }
      
      const html = `
        <div class="error-message">
          <div class="error-header">
            <span class="error-icon">âš ï¸</span>
            <span>å‡ºç°äº†ä¸€äº›é—®é¢˜</span>
          </div>
          <div class="error-content">${formatErrorMessage(message)}</div>
          ${actionBtn}
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
      scrollToBottom();
    }
    
    // é‡è¯•æœ€åä¸€æ¡æ¶ˆæ¯
    function retryLastMessage() {
      // æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
      let lastUserMsgIndex = -1;
      for (let i = messages.length - 1; i >= 0; i--) {
        if (messages[i].role === 'user') {
          lastUserMsgIndex = i;
          break;
        }
      }
      
      if (lastUserMsgIndex === -1) {
        alert('æ²¡æœ‰æ‰¾åˆ°å¯é‡è¯•çš„æ¶ˆæ¯');
        return;
      }
      
      // è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„å†…å®¹
      const lastUserMsg = messages[lastUserMsgIndex];
      
      // ç§»é™¤æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆåŒ…æ‹¬é”™è¯¯æç¤ºï¼‰
      messages = messages.slice(0, lastUserMsgIndex);
      
      // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
      renderMessages();
      
      // å°†æ¶ˆæ¯å¡«å…¥è¾“å…¥æ¡†å¹¶å‘é€
      const input = document.getElementById('chatInput');
      if (input) {
        input.value = lastUserMsg.content;
        sendMessage();
      }
    }

    // æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯
    function formatErrorMessage(message) {
      // è½¬ä¹‰HTMLå¹¶ä¿ç•™æ¢è¡Œ
      return message
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>');
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
      const container = document.getElementById('messagesArea');
      container.scrollTop = container.scrollHeight;
    }

    // ä¿å­˜å†å²
    function saveHistory() {
      try {
        if (!currentAgent) {
          console.warn('Cannot save history: no current agent');
          return;
        }

        const key = currentAgent.type === 'created' ? 'createdAgents' : 'purchasedAgents';
        let agents = JSON.parse(localStorage.getItem(key) || '[]');

        const index = agents.findIndex(a => a.id === currentAgent.id);
        if (index !== -1) {
          // é™åˆ¶å†å²æ¶ˆæ¯æ•°é‡ï¼ˆä¿ç•™æœ€è¿‘100æ¡ï¼‰
          const historyToSave = messages.slice(-100);
          agents[index].chatHistory = historyToSave;
          localStorage.setItem(key, JSON.stringify(agents));
          console.log('Chat history saved:', historyToSave.length, 'messages');
        } else {
          console.warn('Agent not found in storage:', currentAgent.id);
        }
      } catch (error) {
        console.error('Failed to save history:', error);
      }
    }

    // è·å–API Key - ä»æ™ºèƒ½ä½“é…ç½®ä¸­è·å–
    function getApiKey(platformId) {
      // é¦–å…ˆä»å½“å‰æ™ºèƒ½ä½“é…ç½®ä¸­è·å–
      if (currentAgent && currentAgent.apiKey) {
        return currentAgent.apiKey;
      }
      // å¤‡ç”¨ï¼šä»å…¨å±€è®¾ç½®è·å–ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
      const apiKeys = JSON.parse(localStorage.getItem('apiKeys') || '{}');
      return apiKeys[platformId] || '';
    }

    // é”®ç›˜äº‹ä»¶
    function handleKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
    }

    // è¿”å›
    function goBack() {
      window.location.href = 'page.html?page=my-created-agent';
    }

    // è·³è½¬è®¾ç½®
    function goToSettings() {
      // ä¿å­˜å½“å‰æ™ºèƒ½ä½“IDä»¥ä¾¿è¿”å›
      sessionStorage.setItem('returnToChat', JSON.stringify({
        id: currentAgent.id,
        type: currentAgent.type
      }));
      window.location.href = 'page.html?page=my-created-agent';
    }

    // æ˜¾ç¤ºæ¸…ç©ºå¼¹çª—
    function showClearModal() {
      document.getElementById('clearModal').classList.add('show');
    }

    // éšè—æ¸…ç©ºå¼¹çª—
    function hideClearModal() {
      document.getElementById('clearModal').classList.remove('show');
    }

    // æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯
    function clearAllMessages() {
      messages = [];
      saveHistory();
      hideClearModal();
      // ç›´æ¥åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½
      location.reload();
    }

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
